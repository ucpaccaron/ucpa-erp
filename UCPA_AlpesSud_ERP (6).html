<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UCPA ¬∑ ERP R√©gional ¬∑ Registre</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Barlow:ital,wght@0,300;0,400;0,600;0,700;0,900;1,300&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UCPA ‚Äî CHARTE GRAPHIQUE OFFICIELLE
   Couleurs primaires : Orange UCPA + Bleu Marine
   Modes : Sombre (d√©faut) / Clair
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ Couleurs UCPA ‚îÄ‚îÄ */
:root {
  --ucpa-orange:     #E8541A;
  --ucpa-orange-lt:  #FF6B35;
  --ucpa-marine:     #003B71;
  --ucpa-marine-lt:  #0056A3;
  --ucpa-blanc:      #FFFFFF;
  --ucpa-gris-clair: #F4F6FA;
}

/* ‚îÄ‚îÄ Th√®me SOMBRE (d√©faut UCPA digital) ‚îÄ‚îÄ */
[data-theme="dark"] {
  --bg:     #080c12;
  --bg2:    #0d1320;
  --bg3:    #121a28;
  --panel:  #0f1722;
  --border: #1c2840;
  --text:   #e8edf5;
  --muted:  #5a6b85;
  --muted2: #8a9bb5;

  --accent:  var(--ucpa-orange);
  --accent2: var(--ucpa-orange-lt);

  --green:  #1db954;
  --amber:  #f5a623;
  --red:    #e8361a;
  --blue:   #3a7bd5;

  --shadow: rgba(0,0,0,0.5);
  --matrix-sticky-bg: #080c12;
}

/* ‚îÄ‚îÄ Th√®me CLAIR (UCPA charte print) ‚îÄ‚îÄ */
[data-theme="light"] {
  --bg:     #F4F6FA;
  --bg2:    #FFFFFF;
  --bg3:    #EEF1F8;
  --panel:  #FFFFFF;
  --border: #D0D9EC;
  --text:   #1A2340;
  --muted:  #6B7A99;
  --muted2: #4A5A7A;

  --accent:  var(--ucpa-orange);
  --accent2: var(--ucpa-orange-lt);

  --green:  #16A34A;
  --amber:  #D97706;
  --red:    #DC2626;
  --blue:   #1D4ED8;

  --shadow: rgba(0,0,0,0.12);
  --matrix-sticky-bg: #F4F6FA;
}

/* ‚îÄ‚îÄ Variables layout (identiques dans les deux th√®mes) ‚îÄ‚îÄ */
:root {
  --sidebar: 260px;
  --hdr:     56px;
}

/* ‚îÄ‚îÄ Transition fluide lors du changement de th√®me ‚îÄ‚îÄ */
*, *::before, *::after {
  transition: background-color 0.25s ease, border-color 0.25s ease, color 0.25s ease;
}
/* Pas de transition sur les inputs actifs ni les animations ‚îÄ‚îÄ */
input, select, textarea, canvas { transition: none !important; }

*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Barlow',sans-serif;background:var(--bg);color:var(--text);display:flex;height:100vh;overflow:hidden;font-size:14px;}

/* ‚îÄ‚îÄ Bouton bascule th√®me ‚îÄ‚îÄ */
.theme-toggle-btn {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 4px 10px 4px 8px;
  cursor: pointer;
  font-size: 13px;
  color: var(--muted2);
  font-family: 'Barlow', sans-serif;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  white-space: nowrap;
}
.theme-toggle-btn:hover { border-color: var(--accent); color: var(--accent); }
[data-theme="light"] .theme-icon-dark  { display: inline; }
[data-theme="light"] .theme-icon-light { display: none; }
[data-theme="dark"]  .theme-icon-dark  { display: none; }
[data-theme="dark"]  .theme-icon-light { display: inline; }


/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
#sidebar{
  width:var(--sidebar);min-width:var(--sidebar);
  background:var(--bg);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  height:100vh;overflow:hidden;
  z-index:100;
}
#sidebar-head{
  padding:16px;
  border-bottom:1px solid var(--border);
}
.logo{
  font-size:22px;font-weight:900;letter-spacing:-0.5px;
  color:var(--accent);
  font-family:'Barlow',sans-serif;
}
.logo span{color:var(--text);font-weight:300;}
.region-label{
  font-size:10px;letter-spacing:2px;text-transform:uppercase;
  color:var(--muted);margin-top:2px;font-family:'DM Mono',monospace;
}
.centre-selector{
  margin-top:12px;
  background:var(--bg3);
  border:1px solid var(--border);
  border-radius:6px;
  padding:8px 10px;
  color:var(--text);
  font-size:12px;
  width:100%;
  font-family:'Barlow',sans-serif;
  cursor:pointer;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%235a6b85'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 10px center;
}
.centre-selector:focus{outline:none;border-color:var(--accent);}

.conformite-badge{
  margin-top:10px;
  padding:8px 10px;
  border-radius:6px;
  font-size:11px;
  font-family:'DM Mono',monospace;
  display:flex;align-items:center;gap:8px;
}
.conformite-badge .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}

#sidebar-nav{flex:1;overflow-y:auto;padding:8px 0;}
#sidebar-nav::-webkit-scrollbar{width:2px;}
#sidebar-nav::-webkit-scrollbar-thumb{background:var(--border);}

.nav-section{padding:16px 16px 4px;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);font-family:'DM Mono',monospace;}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:9px 16px;
  cursor:pointer;
  font-size:13px;font-weight:400;
  color:var(--muted2);
  transition:all 0.15s;
  border-left:2px solid transparent;
  position:relative;
}
.nav-item:hover{background:var(--bg2);color:var(--text);border-left-color:var(--border);}
.nav-item.active{background:var(--bg2);color:var(--accent);border-left-color:var(--accent);font-weight:600;}
.nav-item .icon{font-size:14px;width:16px;text-align:center;flex-shrink:0;}
.nav-badge{
  margin-left:auto;
  background:var(--red);
  color:#fff;
  font-size:9px;
  font-family:'DM Mono',monospace;
  border-radius:10px;
  padding:1px 6px;
  min-width:18px;
  text-align:center;
}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
#topbar{
  height:var(--hdr);
  background:var(--bg);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;
  padding:0 24px;gap:16px;
  flex-shrink:0;
}
#page-title{font-size:16px;font-weight:700;color:var(--text);}
#page-sub{font-size:12px;color:var(--muted);margin-left:4px;}
.topbar-actions{margin-left:auto;display:flex;gap:8px;}
.btn{
  padding:8px 16px;border-radius:6px;border:none;cursor:pointer;
  font-family:'Barlow',sans-serif;font-size:13px;font-weight:600;
  transition:all 0.15s;display:inline-flex;align-items:center;gap:6px;
}
.btn-primary{background:var(--accent);color:#fff;}
.btn-primary:hover{background:var(--accent2);}
.btn-secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border);}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent);}
.btn-ghost{background:transparent;color:var(--muted2);border:1px solid var(--border);}
.btn-ghost:hover{color:var(--text);border-color:var(--muted2);}
.btn-sm{padding:5px 12px;font-size:12px;}

#content{flex:1;overflow-y:auto;padding:24px;}
#content::-webkit-scrollbar{width:4px;}
#content::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* ‚îÄ‚îÄ PANELS & CARDS ‚îÄ‚îÄ */
.page{display:none;}
.page.active{display:block;}

.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px;}
.kpi{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:10px;
  padding:18px;
}
.kpi-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;font-family:'DM Mono',monospace;}
.kpi-val{font-size:32px;font-weight:900;margin:4px 0;line-height:1;}
.kpi-sub{font-size:11px;color:var(--muted);}
.kpi.danger .kpi-val{color:var(--red);}
.kpi.warn .kpi-val{color:var(--amber);}
.kpi.ok .kpi-val{color:var(--green);}

.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:10px;
  margin-bottom:20px;
  overflow:hidden;
}
.card-hdr{
  padding:14px 18px;
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:10px;
}
.card-hdr h3{font-size:14px;font-weight:700;}
.card-hdr .ml{margin-left:auto;}
.card-body{padding:18px;}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
table{width:100%;border-collapse:collapse;}
th{
  text-align:left;padding:10px 12px;
  font-size:10px;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--muted);font-family:'DM Mono',monospace;
  border-bottom:1px solid var(--border);
  font-weight:400;
}
td{
  padding:10px 12px;
  border-bottom:1px solid var(--border);
  font-size:13px;
  vertical-align:middle;
}
tr:last-child td{border-bottom:none;}
tr:hover td{background:var(--bg2);}
.editable-cell{
  background:transparent;border:none;
  color:var(--text);font-family:'Barlow',sans-serif;
  font-size:13px;width:100%;padding:0;
  cursor:pointer;
}
.editable-cell:focus{
  outline:none;background:var(--bg2);
  border-radius:3px;padding:2px 4px;
}

/* Status pills */
.pill{
  display:inline-block;padding:3px 10px;
  border-radius:20px;font-size:11px;font-weight:600;
  font-family:'DM Mono',monospace;
}
.pill-ok{background:rgba(29,185,84,0.15);color:var(--green);}
.pill-warn{background:rgba(245,166,35,0.15);color:var(--amber);}
.pill-ko{background:rgba(232,54,26,0.15);color:var(--red);}
.pill-na{background:rgba(90,107,133,0.1);color:var(--muted);}

/* ‚îÄ‚îÄ MATRIX ‚îÄ‚îÄ */
.matrix-wrap{overflow:auto;max-height:65vh;}
.matrix-table{border-collapse:collapse;font-size:11px;}
.matrix-table th{position:sticky;top:0;z-index:10;background:var(--matrix-sticky-bg);white-space:nowrap;}
.matrix-table td,.matrix-table th{border:1px solid var(--border);padding:6px 8px;}
.matrix-table .domain-col{position:sticky;left:0;background:var(--matrix-sticky-bg);z-index:5;min-width:160px;font-weight:600;}
.mce{width:24px;height:24px;border-radius:4px;margin:auto;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:10px;}
.mce-ok{background:rgba(29,185,84,0.2);color:var(--green);}
.mce-warn{background:rgba(245,166,35,0.2);color:var(--amber);}
.mce-ko{background:rgba(232,54,26,0.2);color:var(--red);}
.mce-na{background:rgba(90,107,133,0.1);color:var(--muted);}

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.form-grid.full{grid-template-columns:1fr;}
.form-group{display:flex;flex-direction:column;gap:4px;}
.form-group label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-family:'DM Mono',monospace;}
.form-group input,.form-group select,.form-group textarea{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:6px;padding:9px 12px;
  color:var(--text);font-family:'Barlow',sans-serif;font-size:13px;
}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{
  outline:none;border-color:var(--accent);
}
.form-group textarea{resize:vertical;min-height:80px;}

/* ‚îÄ‚îÄ CHECKLIST ‚îÄ‚îÄ */
.checklist-item{
  display:flex;align-items:center;gap:12px;
  padding:10px 0;
  border-bottom:1px solid var(--border);
}
.checklist-item:last-child{border-bottom:none;}
.cl-check{
  width:20px;height:20px;border-radius:4px;
  border:2px solid var(--border);
  background:transparent;cursor:pointer;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  transition:all 0.15s;font-size:12px;
}
.cl-check.checked{background:var(--green);border-color:var(--green);color:#fff;}
.cl-label{flex:1;font-size:13px;}
.cl-val{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:4px;padding:4px 8px;color:var(--text);
  font-size:12px;font-family:'Barlow',sans-serif;width:120px;
}

/* ‚îÄ‚îÄ PMR ‚Äî Registre d√©taill√© ‚îÄ‚îÄ */
.pmr-header-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.pmr-kpi{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;}
.pmr-kpi-val{font-size:28px;font-weight:900;line-height:1;margin:4px 0;}
.pmr-kpi-val.ok{color:var(--green);}
.pmr-kpi-val.warn{color:var(--amber);}
.pmr-kpi-val.ko{color:var(--red);}
.pmr-kpi-label{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-family:'DM Mono',monospace;}

.pmr-section{margin-bottom:20px;}
.pmr-section-title{
  font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:2px;
  color:var(--accent);font-family:'DM Mono',monospace;
  padding:8px 0 6px;border-bottom:2px solid var(--accent);
  margin-bottom:12px;display:flex;align-items:center;gap:8px;
}
.pmr-section-title .stbadge{
  font-size:8px;background:rgba(232,84,26,0.12);
  border-radius:4px;padding:2px 7px;color:var(--accent);
  font-weight:400;letter-spacing:1px;
}
.pmr-item-row{
  display:grid;grid-template-columns:2fr 130px 1fr 1fr;gap:10px;
  align-items:start;padding:10px 0;
  border-bottom:1px solid var(--border);
}
.pmr-item-row:last-child{border-bottom:none;}
.pmr-item-label{font-size:12px;font-weight:600;color:var(--text);}
.pmr-item-ref{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:2px;}
.pmr-item-note{font-size:11px;color:var(--muted2);margin-top:3px;font-style:italic;}
.pmr-status-sel{
  width:100%;background:var(--bg3);border:1px solid var(--border);
  border-radius:6px;padding:6px 8px;color:var(--text);
  font-family:'Barlow',sans-serif;font-size:12px;cursor:pointer;
}
.pmr-status-sel:focus{outline:none;border-color:var(--accent);}
.pmr-obs-input{
  width:100%;background:var(--bg3);border:1px solid var(--border);
  border-radius:6px;padding:6px 8px;color:var(--text);
  font-family:'Barlow',sans-serif;font-size:11px;
}
.pmr-obs-input:focus{outline:none;border-color:var(--accent);}
.pmr-date-input{
  width:100%;background:var(--bg3);border:1px solid var(--border);
  border-radius:6px;padding:5px 8px;color:var(--text);
  font-family:'Barlow',sans-serif;font-size:11px;
}
.pmr-date-input:focus{outline:none;border-color:var(--accent);}
.pmr-global-card{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:20px;}
.pmr-global-title{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);font-family:'DM Mono',monospace;font-weight:700;margin-bottom:12px;}
.pmr-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;}
.pmr-item{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:14px;}
.pmr-item-label{font-size:11px;color:var(--muted);margin-bottom:8px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:1px;}

/* ‚îÄ‚îÄ CANVAS SIGNATURE ‚îÄ‚îÄ */
#sig-canvas{
  background:#fff;border-radius:6px;cursor:crosshair;
  touch-action:none;display:block;
}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,0.7);z-index:1000;
  align-items:center;justify-content:center;
}
.modal-overlay.open{display:flex;}
.modal{
  background:var(--panel);border:1px solid var(--border);
  border-radius:12px;padding:24px;width:560px;max-width:95vw;
  max-height:90vh;overflow-y:auto;
}
.modal h2{font-size:18px;font-weight:700;margin-bottom:16px;}

/* ‚îÄ‚îÄ ALERT BANNER ‚îÄ‚îÄ */
.alert-banner{
  display:flex;align-items:center;gap:12px;
  padding:12px 16px;border-radius:8px;
  margin-bottom:12px;font-size:13px;
}
.alert-banner.danger{background:rgba(232,54,26,0.12);border:1px solid rgba(232,54,26,0.3);color:var(--red);}
.alert-banner.warn{background:rgba(245,166,35,0.12);border:1px solid rgba(245,166,35,0.3);color:var(--amber);}

/* ‚îÄ‚îÄ CARNET SANITAIRE ECS ‚îÄ‚îÄ */
.ecs-layout{display:grid;grid-template-columns:1fr 340px;gap:16px;}
.ecs-section{margin-bottom:20px;}
.ecs-section-title{
  font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:2px;
  color:var(--accent);font-family:'DM Mono',monospace;
  padding:8px 0 6px;border-bottom:2px solid var(--accent);
  margin-bottom:10px;display:flex;align-items:center;gap:8px;
}
.ecs-section-title .ecs-badge{
  font-size:8px;background:rgba(232,84,26,0.12);border-radius:4px;
  padding:2px 8px;color:var(--accent);font-weight:400;letter-spacing:1px;
}
.ecs-row{
  display:grid;grid-template-columns:1fr 90px 56px 60px;gap:8px;
  align-items:center;padding:7px 0;border-bottom:1px solid var(--border);
}
.ecs-row:last-child{border-bottom:none;}
.ecs-row-label{font-size:12px;color:var(--text);}
.ecs-row-ref{font-size:9px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:1px;}
.ecs-input{
  background:var(--bg3);border:1px solid var(--border);border-radius:6px;
  padding:5px 8px;color:var(--text);font-family:'DM Mono',monospace;
  font-size:12px;width:100%;text-align:center;
  transition:border-color 0.15s;
}
.ecs-input:focus{outline:none;border-color:var(--accent);}
.ecs-input.ok{border-color:var(--green);background:rgba(29,185,84,0.08);}
.ecs-input.ko{border-color:var(--red);background:rgba(232,54,26,0.08);}
.ecs-status{
  width:56px;height:28px;border-radius:5px;
  display:flex;align-items:center;justify-content:center;
  font-size:10px;font-weight:700;font-family:'DM Mono',monospace;
  flex-shrink:0;
}
.ecs-status.ok{background:rgba(29,185,84,0.15);color:var(--green);}
.ecs-status.ko{background:rgba(232,54,26,0.15);color:var(--red);}
.ecs-status.empty{background:var(--bg3);color:var(--muted);}
.ecs-unit{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;text-align:center;}

/* Colonne notes */
.ecs-note-input{
  background:var(--bg3);border:1px solid var(--border);border-radius:6px;
  padding:4px 7px;color:var(--muted2);font-family:'Barlow',sans-serif;
  font-size:11px;width:100%;
}
.ecs-note-input:focus{outline:none;border-color:var(--accent);}

/* Panneau droite ‚Äî historique + r√©sum√© */
.ecs-side-panel{display:flex;flex-direction:column;gap:14px;}
.ecs-summary-card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px;}
.ecs-summary-title{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);font-family:'DM Mono',monospace;font-weight:700;margin-bottom:10px;}
.ecs-kpi-mini{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--border);font-size:12px;}
.ecs-kpi-mini:last-child{border-bottom:none;}
.ecs-kpi-val{font-weight:700;font-family:'DM Mono',monospace;}
.ecs-history-item{
  background:var(--bg3);border:1px solid var(--border);border-radius:8px;
  padding:10px 12px;margin-bottom:8px;cursor:pointer;transition:border-color 0.15s;
}
.ecs-history-item:hover{border-color:var(--accent);}
.ecs-history-date{font-size:11px;font-weight:700;color:var(--text);font-family:'DM Mono',monospace;}
.ecs-history-meta{font-size:10px;color:var(--muted);margin-top:2px;}
.ecs-history-badges{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap;}
.ecs-anom-badge{font-size:9px;padding:2px 6px;border-radius:10px;font-family:'DM Mono',monospace;font-weight:600;}
.ecs-anom-badge.ok{background:rgba(29,185,84,0.15);color:var(--green);}
.ecs-anom-badge.ko{background:rgba(232,54,26,0.15);color:var(--red);}

/* Purges */
.purge-row{display:grid;grid-template-columns:110px 1fr 1fr 36px;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);}
.purge-row:last-child{border-bottom:none;}
.purge-input{background:var(--bg3);border:1px solid var(--border);border-radius:5px;padding:5px 8px;color:var(--text);font-size:12px;font-family:'Barlow',sans-serif;width:100%;}
.purge-input:focus{outline:none;border-color:var(--accent);}

/* Ancien .temp-row conserv√© pour compatibilit√© */
.temp-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);}
.temp-row:last-child{border-bottom:none;}
.temp-seuil{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;}

/* ‚îÄ‚îÄ REGISTRE ‚Äî Saisie de masse + Rappels ‚îÄ‚îÄ */
.reg-toolbar{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg3);border-bottom:1px solid var(--border);flex-wrap:wrap;}
.reg-search{background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:6px 12px;color:var(--text);font-size:12px;font-family:'Barlow',sans-serif;width:220px;}
.reg-search:focus{outline:none;border-color:var(--accent);}

/* Bulk edit panel */
.bulk-panel{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:16px;}
.bulk-panel-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--accent);font-family:'DM Mono',monospace;margin-bottom:12px;}
.bulk-centre-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:6px;max-height:180px;overflow-y:auto;padding:4px;}
.bulk-centre-item{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:6px;border:1px solid var(--border);cursor:pointer;font-size:12px;transition:all 0.15s;}
.bulk-centre-item:hover{border-color:var(--accent);}
.bulk-centre-item.selected{background:rgba(232,84,26,0.1);border-color:var(--accent);color:var(--accent);font-weight:600;}
.bulk-centre-item input[type=checkbox]{accent-color:var(--accent);}

.bulk-fields-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:14px;}
.bulk-progress-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin-top:8px;}
.bulk-progress-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 0.3s;}

/* Rappels e-mail */
.remind-item{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px 16px;margin-bottom:10px;display:flex;align-items:center;gap:12px;}
.remind-item.urgent{border-left:3px solid var(--red);}
.remind-item.soon{border-left:3px solid var(--amber);}
.remind-info{flex:1;min-width:0;}
.remind-title{font-size:13px;font-weight:700;color:var(--text);}
.remind-meta{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:2px;}
.remind-days{font-size:11px;font-weight:700;padding:3px 8px;border-radius:12px;font-family:'DM Mono',monospace;flex-shrink:0;}
.remind-days.urgent{background:rgba(232,54,26,0.15);color:var(--red);}
.remind-days.soon{background:rgba(245,166,35,0.15);color:var(--amber);}
.remind-days.ok{background:rgba(29,185,84,0.12);color:var(--green);}

/* Registre inline highlight */
tr.row-expired td{background:rgba(232,54,26,0.04);}
tr.row-soon td{background:rgba(245,166,35,0.03);}
tr.row-selected td{background:rgba(232,84,26,0.08) !important;}
.reg-select-cb{accent-color:var(--accent);width:14px;height:14px;cursor:pointer;}
.reg-kpi-strip{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:14px;}
.reg-kpi{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;}
.reg-kpi-val{font-size:24px;font-weight:900;line-height:1;}
.reg-kpi-label{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:3px;}
.reg-kpi-val.ok{color:var(--green);}
.reg-kpi-val.warn{color:var(--amber);}
.reg-kpi-val.ko{color:var(--red);}
.reg-kpi-val.blue{color:#3a7bd5;}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.sep{height:1px;background:var(--border);margin:20px 0;}
.empty-state{text-align:center;padding:48px 24px;color:var(--muted);}
.empty-state .icon{font-size:40px;margin-bottom:12px;}
.section-title{font-size:13px;font-weight:700;color:var(--muted2);text-transform:uppercase;letter-spacing:2px;margin-bottom:14px;font-family:'DM Mono',monospace;}
.flex{display:flex;align-items:center;gap:10px;}
.flex-wrap{display:flex;flex-wrap:wrap;gap:8px;}
.ml{margin-left:auto;}
input[type=file]{display:none;}
.upload-zone{
  border:2px dashed var(--border);border-radius:8px;
  padding:24px;text-align:center;cursor:pointer;
  color:var(--muted);transition:border-color 0.15s;
}
.upload-zone:hover{border-color:var(--accent);}

/* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
#login-screen{
  position:fixed;inset:0;z-index:9999;
  background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;
}
.login-wrap{
  width:420px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  padding:40px;
  box-shadow:0 24px 80px rgba(0,0,0,0.5);
}
.login-logo{
  font-size:32px;font-weight:900;color:var(--accent);
  font-family:'Barlow',sans-serif;margin-bottom:4px;
}
.login-logo span{color:var(--text);font-weight:300;}
.login-region{
  font-size:10px;letter-spacing:3px;text-transform:uppercase;
  color:var(--muted);font-family:'DM Mono',monospace;
  margin-bottom:32px;
}
.login-title{
  font-size:16px;font-weight:700;color:var(--text);
  margin-bottom:6px;
}
.login-sub{
  font-size:12px;color:var(--muted);margin-bottom:28px;
}
.login-tabs{
  display:flex;gap:4px;margin-bottom:24px;
  background:var(--bg3);border-radius:8px;padding:4px;
}
.login-tab{
  flex:1;padding:8px;border:none;background:transparent;
  color:var(--muted2);font-family:'Barlow',sans-serif;
  font-size:13px;font-weight:600;border-radius:6px;cursor:pointer;
  transition:all 0.15s;
}
.login-tab.active{background:var(--accent);color:#fff;}
.login-field{margin-bottom:16px;}
.login-field label{
  display:block;font-size:10px;letter-spacing:1.5px;
  text-transform:uppercase;color:var(--muted);
  font-family:'DM Mono',monospace;margin-bottom:6px;
}
.login-field input,
.login-field select{
  width:100%;background:var(--bg3);
  border:1px solid var(--border);border-radius:8px;
  padding:11px 14px;color:var(--text);
  font-family:'Barlow',sans-serif;font-size:14px;
  transition:border-color 0.15s;
}
.login-field input:focus,
.login-field select:focus{outline:none;border-color:var(--accent);}
.login-btn{
  width:100%;padding:13px;background:var(--accent);
  color:#fff;border:none;border-radius:8px;
  font-family:'Barlow',sans-serif;font-size:15px;
  font-weight:700;cursor:pointer;margin-top:8px;
  transition:background 0.15s;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.login-btn:hover{background:var(--accent2);}
.login-error{
  background:rgba(232,54,26,0.12);
  border:1px solid rgba(232,54,26,0.3);
  color:var(--red);border-radius:6px;
  padding:10px 14px;font-size:13px;
  margin-top:14px;display:none;
}
.login-user-info{
  position:fixed;bottom:16px;right:20px;
  background:var(--panel);border:1px solid var(--border);
  border-radius:8px;padding:8px 14px;
  display:flex;align-items:center;gap:10px;
  font-size:12px;color:var(--muted2);z-index:200;
}
.login-user-info .user-dot{width:7px;height:7px;border-radius:50%;background:var(--green);}
.logout-btn{
  background:transparent;border:1px solid var(--border);
  color:var(--muted);border-radius:4px;padding:3px 8px;
  font-size:11px;cursor:pointer;font-family:'Barlow',sans-serif;
  transition:all 0.15s;
}
.logout-btn:hover{border-color:var(--red);color:var(--red);}
/* Import btn style helper */
.import-file-btn{display:none;}

/* ‚îÄ‚îÄ ADMIN CENTRES ‚îÄ‚îÄ */
.admin-centre-card{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:14px 16px;display:flex;align-items:center;gap:12px;}
.admin-centre-info{flex:1;min-width:0;}
.admin-centre-name{font-size:13px;font-weight:700;color:var(--text);margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.admin-centre-pw{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;}
.admin-centre-pw code{color:var(--accent);background:var(--bg2);border:1px solid var(--border);border-radius:3px;padding:1px 5px;}
.admin-centres-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:10px;}
.admin-kpi-bar{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px;}
.admin-kpi{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:16px;text-align:center;}
.admin-kpi-val{font-size:34px;font-weight:900;color:var(--accent);line-height:1;}
.admin-kpi-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;font-family:'DM Mono',monospace;margin-top:4px;}
.admin-section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.admin-region-badge{font-size:10px;font-family:'DM Mono',monospace;font-weight:700;letter-spacing:1px;padding:3px 10px;border-radius:4px;}
.admin-region-badge.sud{background:rgba(232,84,26,0.15);color:var(--accent);}
.admin-region-badge.nord{background:rgba(58,123,213,0.15);color:#3a7bd5;}

/* ‚îÄ‚îÄ FICHE SYNTH√àSE ‚îÄ‚îÄ */
.synth-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.synth-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;}
.synth-card{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:16px;}
.synth-card-title{
  font-size:9px;letter-spacing:2px;text-transform:uppercase;
  color:var(--accent);font-family:'DM Mono',monospace;
  font-weight:700;margin-bottom:12px;
  display:flex;align-items:center;gap:6px;
}
.synth-card-title .sticon{font-size:13px;}
.synth-field{margin-bottom:10px;}
.synth-field:last-child{margin-bottom:0;}
.synth-field label{
  display:block;font-size:9px;color:var(--muted);
  text-transform:uppercase;letter-spacing:1px;
  font-family:'DM Mono',monospace;margin-bottom:4px;
}
.synth-field input,.synth-field select,.synth-field textarea{
  width:100%;background:var(--bg2);border:1px solid var(--border);
  border-radius:6px;padding:7px 11px;color:var(--text);
  font-family:'Barlow',sans-serif;font-size:13px;
  transition:border-color 0.15s;
}
.synth-field input:focus,.synth-field select:focus,.synth-field textarea:focus{
  outline:none;border-color:var(--accent);
}
.synth-field textarea{resize:none;height:60px;}
.synth-pw-preview{
  display:flex;align-items:center;gap:8px;
  background:var(--bg2);border:1px solid var(--border);
  border-radius:6px;padding:8px 12px;font-size:12px;
  font-family:'DM Mono',monospace;color:var(--muted2);
  margin-top:8px;
}
.synth-pw-preview strong{color:var(--accent);}
.synth-badge{
  display:inline-block;padding:2px 9px;border-radius:12px;
  font-size:10px;font-family:'DM Mono',monospace;font-weight:600;
}
.synth-badge.ok{background:rgba(29,185,84,0.15);color:var(--green);}
.synth-badge.warn{background:rgba(245,166,35,0.15);color:var(--amber);}
.synth-badge.ko{background:rgba(232,54,26,0.15);color:var(--red);}
.synth-section-sep{height:1px;background:var(--border);margin:14px 0;}
.synth-contact-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px;}
.synth-contact-row:last-child{border-bottom:none;}
.synth-contact-icon{width:28px;height:28px;border-radius:50%;background:var(--bg2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
.synth-contact-info{flex:1;min-width:0;}
.synth-contact-name{font-weight:700;font-size:12px;}
.synth-contact-detail{font-size:10px;color:var(--muted);}
.synth-stat-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px;}
.synth-stat-row:last-child{border-bottom:none;}
.synth-stat-val{font-weight:700;font-family:'DM Mono',monospace;color:var(--text);}
.synth-empty{text-align:center;padding:60px 24px;color:var(--muted);}
.synth-empty .icon{font-size:48px;margin-bottom:14px;}
/* Span pleine largeur dans synth-grid */
.synth-span2{grid-column:span 2;}

/* ‚îÄ‚îÄ ERP TYPE MULTI-SELECT ‚îÄ‚îÄ */
.erp-type-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:6px;
  margin-top:4px;
}
.erp-type-item{
  display:flex;align-items:center;gap:8px;
  padding:7px 10px;border-radius:6px;cursor:pointer;
  border:1px solid var(--border);background:var(--bg2);
  transition:all 0.15s;user-select:none;
}
.erp-type-item:hover{border-color:var(--accent);}
.erp-type-item.selected{
  border-color:var(--accent);
  background:rgba(232,84,26,0.1);
}
.erp-type-item input[type=checkbox]{
  display:none;
}
.erp-type-checkbox{
  width:16px;height:16px;border-radius:4px;flex-shrink:0;
  border:2px solid var(--border);background:transparent;
  display:flex;align-items:center;justify-content:center;
  font-size:10px;transition:all 0.15s;
}
.erp-type-item.selected .erp-type-checkbox{
  background:var(--accent);border-color:var(--accent);color:#fff;
}
.erp-type-code{
  font-family:'DM Mono',monospace;font-size:11px;
  font-weight:700;color:var(--accent);min-width:24px;
}
.erp-type-item:not(.selected) .erp-type-code{color:var(--muted2);}
.erp-type-label{font-size:11px;color:var(--muted2);line-height:1.3;}
.erp-type-item.selected .erp-type-label{color:var(--text);}
.erp-types-selected{
  margin-top:8px;padding:6px 10px;
  background:var(--bg3);border-radius:6px;
  font-size:11px;font-family:'DM Mono',monospace;
  color:var(--muted2);min-height:28px;
}
.erp-types-selected strong{color:var(--accent);}

/* ‚îÄ‚îÄ GED DOCUMENTS ‚îÄ‚îÄ */
.ged-layout{display:grid;grid-template-columns:280px 1fr;gap:16px;height:calc(100vh - 140px);}
.ged-tree-panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;overflow:hidden;display:flex;flex-direction:column;}
.ged-tree-head{padding:12px 16px;border-bottom:1px solid var(--border);font-size:12px;font-weight:700;color:var(--muted2);display:flex;align-items:center;gap:8px;}
.ged-tree-body{flex:1;overflow-y:auto;padding:8px 0;}
.ged-tree-body::-webkit-scrollbar{width:2px;}
.ged-tree-body::-webkit-scrollbar-thumb{background:var(--border);}

.ged-folder-row{
  display:flex;align-items:center;gap:8px;
  padding:8px 14px;cursor:pointer;font-size:12px;
  color:var(--muted2);transition:all 0.15s;
  border-left:2px solid transparent;
}
.ged-folder-row:hover{background:var(--bg2);color:var(--text);}
.ged-folder-row.active{background:var(--bg2);color:var(--accent);border-left-color:var(--accent);font-weight:600;}
.ged-folder-row .ged-icon{font-size:14px;flex-shrink:0;}
.ged-folder-row .ged-arrow{margin-left:auto;font-size:10px;color:var(--muted);transition:transform 0.2s;}
.ged-folder-row.open .ged-arrow{transform:rotate(90deg);}

.ged-subfolder-row{
  display:flex;align-items:center;gap:8px;
  padding:7px 14px 7px 32px;cursor:pointer;font-size:11px;
  color:var(--muted);transition:all 0.15s;
  border-left:2px solid transparent;
}
.ged-subfolder-row:hover{background:var(--bg2);color:var(--text);}
.ged-subfolder-row.active{background:var(--bg2);color:var(--accent);border-left-color:var(--accent);font-weight:600;}
.ged-subfolder-children{display:none;}
.ged-subfolder-children.open{display:block;}

.ged-content-panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;overflow:hidden;display:flex;flex-direction:column;}
.ged-content-head{padding:12px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0;}
.ged-content-head h3{font-size:13px;font-weight:700;}
.ged-content-body{flex:1;overflow-y:auto;padding:16px;}
.ged-content-body::-webkit-scrollbar{width:4px;}
.ged-content-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

.ged-doc-card{
  background:var(--bg3);border:1px solid var(--border);border-radius:8px;
  padding:12px 16px;margin-bottom:10px;
  display:flex;align-items:center;gap:12px;
  transition:border-color 0.15s;
}
.ged-doc-card:hover{border-color:var(--accent);}
.ged-doc-icon{font-size:22px;flex-shrink:0;}
.ged-doc-info{flex:1;min-width:0;}
.ged-doc-name{font-size:13px;font-weight:600;color:var(--text);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ged-doc-meta{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;}
.ged-doc-actions{display:flex;gap:6px;flex-shrink:0;}
.ged-drive-link{
  display:inline-flex;align-items:center;gap:5px;
  padding:4px 10px;border-radius:5px;font-size:11px;font-weight:600;
  background:rgba(58,123,213,0.12);color:#3a7bd5;
  border:1px solid rgba(58,123,213,0.3);cursor:pointer;
  text-decoration:none;transition:all 0.15s;font-family:'Barlow',sans-serif;
}
.ged-drive-link:hover{background:rgba(58,123,213,0.22);color:#3a7bd5;}
.ged-empty{text-align:center;padding:48px 24px;color:var(--muted);}
.ged-empty .icon{font-size:42px;margin-bottom:12px;}
.ged-section-placeholder{
  text-align:center;padding:80px 24px;color:var(--muted);
}
.ged-section-placeholder .icon{font-size:52px;margin-bottom:16px;}
.ged-section-placeholder h3{font-size:15px;font-weight:700;color:var(--muted2);margin-bottom:8px;}
.ged-breadcrumb{
  font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;
  padding:8px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:6px;
}
.ged-breadcrumb .sep{opacity:0.4;}

/* Modal GED */
.ged-drive-preview{
  display:flex;align-items:center;gap:10px;
  padding:12px 14px;border-radius:8px;
  background:rgba(58,123,213,0.08);border:1px solid rgba(58,123,213,0.25);
  margin-top:12px;font-size:12px;color:var(--muted2);
}
.ged-drive-preview .drive-icon{font-size:20px;}

/* ‚îÄ‚îÄ REGION SWITCHER ‚îÄ‚îÄ */
.region-switcher{
  display:flex;gap:3px;margin-bottom:16px;
  background:var(--bg3);border-radius:8px;padding:3px;
}
.region-tab{
  flex:1;padding:6px 4px;border:none;background:transparent;
  color:var(--muted);font-family:'Barlow',sans-serif;
  font-size:11px;font-weight:600;border-radius:6px;cursor:pointer;
  transition:all 0.15s;text-align:center;
}
.region-tab.active-sud{background:var(--accent);color:#fff;}
.region-tab.active-nord{background:#3a7bd5;color:#fff;}
.region-tab.active-admin{background:#7c3aed;color:#fff;}

/* Nord accent override for Nord sessions */
body.region-nord { --accent:#3a7bd5; --accent2:#5a9be8; }
body.region-admin { --accent:#7c3aed; --accent2:#9d5af0; }

.badge-admin{
  display:inline-block;background:#7c3aed;color:#fff;
  font-size:9px;font-family:'DM Mono',monospace;
  border-radius:4px;padding:2px 6px;letter-spacing:1px;
  text-transform:uppercase;margin-left:6px;
}
.badge-region-nord{
  display:inline-block;background:#3a7bd5;color:#fff;
  font-size:9px;font-family:'DM Mono',monospace;
  border-radius:4px;padding:2px 6px;letter-spacing:1px;
  text-transform:uppercase;margin-left:6px;
}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-wrap">
    <div class="login-logo">UCPA<span> ERP</span></div>
    <div class="login-region" id="login-region-label">‚ñ≤ Alpes ¬∑ Registre ERP ¬∑ Acc√®s s√©curis√©</div>
    <div class="login-title">Connexion</div>

    <!-- S√©lecteur de type de compte -->
    <div class="region-switcher" style="margin-top:0;margin-bottom:20px">
      <button class="region-tab active-admin" id="tab-admin" onclick="Auth.switchTab('admin')">üëë Admin</button>
      <button class="region-tab" id="tab-sud" onclick="Auth.switchTab('sud')">‚ñ≤ Alpes Sud</button>
      <button class="region-tab" id="tab-nord" onclick="Auth.switchTab('nord')">‚ñ≤ Alpes Nord</button>
    </div>

    <!-- ADMIN TAB -->
    <div id="login-tab-admin">
      <div style="background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.3);border-radius:8px;padding:12px 14px;margin-bottom:16px;font-size:12px;color:#a78bfa">
        üëë Acc√®s administrateur ‚Äî toutes r√©gions et tous centres
      </div>
      <div class="login-field">
        <label>Identifiant</label>
        <input type="text" id="login-user-admin" placeholder="admin" autocomplete="off">
      </div>
      <div class="login-field">
        <label>Mot de passe</label>
        <input type="password" id="login-pass-admin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          onkeydown="if(event.key==='Enter')Auth.login()">
      </div>
    </div>

    <!-- ALPES SUD TAB -->
    <div id="login-tab-sud" style="display:none">
      <div class="login-tabs" style="margin-bottom:16px">
        <button class="login-tab active" onclick="Auth.switchSubTab('sud','region')" id="subtab-sud-region">üåê R√©gion</button>
        <button class="login-tab" onclick="Auth.switchSubTab('sud','centre')" id="subtab-sud-centre">üèî Centre</button>
      </div>
      <!-- R√©gion Sud -->
      <div id="login-subtab-sud-region">
        <div class="login-field">
          <label>Identifiant</label>
          <input type="text" id="login-user-sud" placeholder="Alpessud" autocomplete="off">
        </div>
        <div class="login-field">
          <label>Mot de passe</label>
          <input type="password" id="login-pass-sud-region" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            onkeydown="if(event.key==='Enter')Auth.login()">
        </div>
      </div>
      <!-- Centre Sud -->
      <div id="login-subtab-sud-centre" style="display:none">
        <div class="login-field">
          <label>Centre</label>
          <select id="login-centre-sud">
            <option value="">‚Äî Choisir un centre ‚Äî</option>
          </select>
        </div>
        <div class="login-field">
          <label>Mot de passe</label>
          <input type="password" id="login-pass-sud-centre" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            onkeydown="if(event.key==='Enter')Auth.login()">
        </div>
      </div>
    </div>

    <!-- ALPES NORD TAB -->
    <div id="login-tab-nord" style="display:none">
      <div class="login-tabs" style="margin-bottom:16px">
        <button class="login-tab active" onclick="Auth.switchSubTab('nord','region')" id="subtab-nord-region">üåê R√©gion</button>
        <button class="login-tab" onclick="Auth.switchSubTab('nord','centre')" id="subtab-nord-centre">üèî Centre</button>
      </div>
      <!-- R√©gion Nord -->
      <div id="login-subtab-nord-region">
        <div class="login-field">
          <label>Identifiant</label>
          <input type="text" id="login-user-nord" placeholder="Alpesnord" autocomplete="off">
        </div>
        <div class="login-field">
          <label>Mot de passe</label>
          <input type="password" id="login-pass-nord-region" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            onkeydown="if(event.key==='Enter')Auth.login()">
        </div>
      </div>
      <!-- Centre Nord -->
      <div id="login-subtab-nord-centre" style="display:none">
        <div class="login-field">
          <label>Centre</label>
          <select id="login-centre-nord">
            <option value="">‚Äî Choisir un centre ‚Äî</option>
          </select>
        </div>
        <div class="login-field">
          <label>Mot de passe</label>
          <input type="password" id="login-pass-nord-centre" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            onkeydown="if(event.key==='Enter')Auth.login()">
        </div>
      </div>
    </div>

    <button class="login-btn" onclick="Auth.login()">
      <span>‚Üí</span> Se connecter
    </button>
    <div class="login-error" id="login-error">Identifiant ou mot de passe incorrect.</div>
  </div>
</div>

<!-- USER INFO BAR (shown after login) -->
<div class="login-user-info" id="user-info-bar" style="display:none">
  <div class="user-dot"></div>
  <span id="user-info-text">‚Äî</span>
  <button class="logout-btn" onclick="Auth.logout()">D√©connexion</button>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
  <div id="sidebar-head">
    <div class="logo">UCPA<span> ERP</span></div>
    <div class="region-label" id="sidebar-region-label">‚ñ≤ Alpes ¬∑ ERP R√©gional</div>
    <select class="centre-selector" id="centre-select" onchange="App.selectCentre(this.value)">
      <option value="ALL">‚Äî Tous les centres ‚Äî</option>
    </select>
    <div class="conformite-badge" id="conf-badge">
      <div class="dot" id="conf-dot" style="background:var(--muted)"></div>
      <span id="conf-text" style="font-size:11px;color:var(--muted)">S√©lectionner un centre</span>
    </div>
  </div>
  <nav id="sidebar-nav">
    <div class="nav-section">Pilotage</div>
    <div class="nav-item active" onclick="App.nav('dashboard')" data-page="dashboard"><span class="icon">‚óà</span> Dashboard KPIs</div>
    <div class="nav-item" onclick="App.nav('synthese')" data-page="synthese"><span class="icon">üè¢</span> Fiche Synth√®se</div>
    <div class="nav-item" onclick="App.nav('matrix')" data-page="matrix"><span class="icon">‚äû</span> Matrice Conformit√©</div>
    <div class="nav-section">S√©curit√©</div>
    <div class="nav-item" onclick="App.nav('registre')" data-page="registre"><span class="icon">üî•</span> Registre S√©curit√© <span class="nav-badge" id="badge-registre" style="display:none">0</span></div>
    <div class="nav-item" onclick="App.nav('observations')" data-page="observations"><span class="icon">üëÅ</span> Observations</div>
    <div class="nav-item" onclick="App.nav('veille')" data-page="veille"><span class="icon">üì°</span> Veille R√©glementaire</div>
    <div class="nav-section">Accessibilit√©</div>
    <div class="nav-item" onclick="App.nav('pmr')" data-page="pmr"><span class="icon">‚ôø</span> Registre PMR</div>
    <div class="nav-section">Pr√©vention</div>
    <div class="nav-item" onclick="App.nav('prevention')" data-page="prevention"><span class="icon">‚ö†</span> Plan de Pr√©vention</div>
    <div class="nav-item" onclick="App.nav('permisfeu')" data-page="permisfeu"><span class="icon">üî•</span> Permis de Feu</div>
    <div class="nav-section">Op√©rations</div>
    <div class="nav-item" onclick="App.nav('maintenance')" data-page="maintenance"><span class="icon">üîß</span> Maintenance & Anomalies</div>
    <div class="nav-item" onclick="App.nav('rondes')" data-page="rondes"><span class="icon">üîÑ</span> Gammes & Rondes</div>
    <div class="nav-item" onclick="App.nav('sanitaire')" data-page="sanitaire"><span class="icon">üíß</span> Carnet Sanitaire</div>
    <div class="nav-section">Investissements</div>
    <div class="nav-item" onclick="App.nav('investissements')" data-page="investissements"><span class="icon">üí∞</span> Suivi des Investissements</div>
    <div class="nav-section">Ressources</div>
    <div class="nav-item" onclick="App.nav('ged')" data-page="ged"><span class="icon">üìÅ</span> GED Documents</div>
    <div class="nav-item" onclick="App.nav('rh')" data-page="rh"><span class="icon">üë§</span> RH Habilitations <span class="nav-badge" id="badge-rh" style="display:none">0</span></div>
    <div class="nav-item" onclick="App.nav('contrats')" data-page="contrats"><span class="icon">üìã</span> Contrats</div>
    <div class="nav-item" onclick="App.nav('checklists')" data-page="checklists"><span class="icon">‚úì</span> Check-lists M√©tier</div>
    <div class="nav-item" onclick="App.nav('taches')" data-page="taches"><span class="icon">üìå</span> T√¢ches</div>
    <div class="nav-item" id="nav-admin" onclick="App.nav('admin')" data-page="admin" style="display:none"><span class="icon">‚öôÔ∏è</span> Admin ‚Äî Centres</div>
  </nav>
</div>

<!-- MAIN -->
<div id="main">
  <div id="topbar">
    <div>
      <span id="page-title">Dashboard KPIs</span>
      <span id="page-sub"></span>
    </div>
    <div class="topbar-actions" id="topbar-actions">
      <button class="theme-toggle-btn" onclick="Theme.toggle()" title="Basculer th√®me clair / sombre">
        <span class="theme-icon-dark">üåô Sombre</span>
        <span class="theme-icon-light">‚òÄÔ∏è Clair</span>
      </button>
    </div>
  </div>
  <div id="content">

    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page active">
      <div class="kpi-grid" id="kpi-grid"></div>
      <div id="alerts-zone"></div>
      <div class="card">
        <div class="card-hdr">
          <span>‚ö°</span><h3>Actions urgentes</h3>
          <div class="ml flex gap8">
            <button class="btn btn-secondary btn-sm" onclick="App.importCSV()">üì• Importer CSV</button>
            <input type="file" id="csv-input" accept=".csv" onchange="App.handleCSV(event)">
          </div>
        </div>
        <div class="card-body" id="urgent-list">
          <div class="empty-state"><div class="icon">‚úÖ</div><div>Aucune action urgente</div></div>
        </div>
      </div>
      <div class="card">
        <div class="card-hdr"><span>üìä</span><h3>Avancement par groupe</h3></div>
        <div class="card-body" id="group-progress"></div>
      </div>
    </div>

    <!-- FICHE SYNTH√àSE CENTRE -->
    <div id="page-synthese" class="page">
      <div id="synthese-container"></div>
    </div>

    <!-- MATRIX -->
    <div id="page-matrix" class="page">
      <div class="card">
        <div class="card-hdr">
          <span>‚äû</span><h3>Matrice Conformit√© ‚Äî 17 domaines √ó 13 centres</h3>
          <div class="ml flex" style="gap:8px">
            <button class="btn btn-secondary btn-sm" onclick="App.exportMatrixExcel()">üìä Export Excel</button>
            <button class="btn btn-secondary btn-sm" onclick="App.exportMatrixPDF()">üìÑ Export PDF</button>
          </div>
        </div>
        <div class="matrix-wrap" id="matrix-wrap"></div>
      </div>
    </div>

    <!-- REGISTRE -->
    <div id="page-registre" class="page">

      <!-- KPI strip -->
      <div class="reg-kpi-strip" id="reg-kpi-strip"></div>

      <!-- Carte principale -->
      <div class="card">
        <!-- Toolbar -->
        <div class="reg-toolbar">
          <input class="reg-search" id="reg-search" type="text" placeholder="üîç  Rechercher libell√©, organisme‚Ä¶" oninput="App.renderRegistre()">
          <select id="reg-groupe-filter" class="centre-selector" style="width:190px" onchange="App.renderRegistre()">
            <option value="">Tous les groupes</option>
          </select>
          <select id="reg-statut-filter" class="centre-selector" style="width:160px" onchange="App.renderRegistre()">
            <option value="">Tous les statuts</option>
            <option value="expired">üî¥ √âchus</option>
            <option value="soon">üü° ‚â§ 60 jours</option>
            <option value="ok">üü¢ OK</option>
            <option value="empty">‚¨ú Non renseign√©</option>
          </select>
          <div style="margin-left:auto;display:flex;gap:6px">
            <button class="btn btn-ghost btn-sm" onclick="App.openBulkModal()" title="Saisie de masse sur plusieurs centres">‚úèÔ∏è Saisie de masse</button>
            <button class="btn btn-ghost btn-sm" onclick="App.openReminderPanel()" title="Rappels e-mail">üîî Rappels</button>
            <button class="btn btn-secondary btn-sm" onclick="App.addRegistreRow()">+ Ligne</button>
            <button class="btn btn-secondary btn-sm" onclick="App.exportRegistreExcel()">üìä Excel</button>
            <label class="btn btn-ghost btn-sm" style="cursor:pointer" onclick="document.getElementById('reg-excel-input').click()">üì• Import</label>
            <input type="file" id="reg-excel-input" accept=".xlsx,.xls" onchange="ExcelImport.importRegistre(event)" style="display:none">
            <button class="btn btn-primary btn-sm" onclick="App.exportRegistrePDF()">üìÑ Commission</button>
          </div>
        </div>
        <!-- S√©lection masse + actions group√©es -->
        <div id="reg-bulk-bar" style="display:none;padding:8px 14px;background:rgba(232,84,26,0.08);border-bottom:1px solid rgba(232,84,26,0.2);font-size:12px;display:none;align-items:center;gap:10px">
          <span id="reg-sel-count" style="font-weight:700;color:var(--accent)">0 lignes s√©lectionn√©es</span>
          <button class="btn btn-ghost btn-sm" onclick="App.bulkSetResult('Favorable')">‚úÖ Favorable</button>
          <button class="btn btn-ghost btn-sm" onclick="App.bulkSetResult('R√©serves')">‚ö†Ô∏è R√©serves</button>
          <button class="btn btn-ghost btn-sm" onclick="App.bulkSetResult('D√©favorable')">‚ùå D√©favorable</button>
          <button class="btn btn-ghost btn-sm" onclick="App.bulkSetDate()">üìÖ Fixer date</button>
          <button class="btn btn-ghost btn-sm" onclick="App.selectAllRows()">Tout s√©lectionner</button>
          <button class="btn btn-ghost btn-sm" onclick="App.clearSelection()">D√©s√©lectionner</button>
        </div>
        <div style="overflow:auto;max-height:65vh" id="registre-table-wrap"></div>
      </div>

      <!-- Panneau rappels (masqu√© par d√©faut) -->
      <div id="reg-reminder-panel" style="display:none">
        <div class="card" style="margin-top:16px">
          <div class="card-hdr">
            <span>üîî</span><h3>Rappels E-mail ‚Äî Contr√¥les √† venir ou √©chus</h3>
            <div class="ml flex" style="gap:8px">
              <button class="btn btn-ghost btn-sm" onclick="App.closeReminderPanel()">‚úï Fermer</button>
              <button class="btn btn-primary btn-sm" onclick="App.sendAllReminders()">üìß G√©n√©rer tous les e-mails</button>
            </div>
          </div>
          <div class="card-body">
            <div class="form-grid" style="margin-bottom:16px">
              <div class="form-group">
                <label>Destinataire(s) par d√©faut</label>
                <input type="email" id="remind-to" placeholder="rt@ucpa.fr; rm2s@ucpa.fr" multiple>
              </div>
              <div class="form-group">
                <label>D√©lai d'alerte (jours avant √©ch√©ance)</label>
                <select id="remind-delay">
                  <option value="30">30 jours</option>
                  <option value="60" selected>60 jours</option>
                  <option value="90">90 jours</option>
                  <option value="0">√âchus seulement</option>
                </select>
              </div>
            </div>
            <div id="remind-list"></div>
          </div>
        </div>
      </div>

    </div>

    <!-- OBSERVATIONS -->
    <div id="page-observations" class="page">
      <div class="card">
        <div class="card-hdr">
          <span>üëÅ</span><h3>Observations de S√©curit√©</h3>
          <div class="ml flex" style="gap:8px">
            <button class="btn btn-secondary btn-sm" onclick="App.exportObsExcel()">üìä Export Excel</button>
            <label class="btn btn-ghost btn-sm" style="cursor:pointer" onclick="document.getElementById('obs-excel-input').click()">üì• Import Excel</label>
            <input type="file" id="obs-excel-input" accept=".xlsx,.xls" onchange="ExcelImport.importObs(event)" style="display:none">
            <button class="btn btn-primary btn-sm" onclick="App.openObsModal()">+ Nouvelle observation</button>
          </div>
        </div>
        <div class="card-body" id="obs-list">
          <div class="empty-state"><div class="icon">üëÅ</div><div>Aucune observation enregistr√©e</div></div>
        </div>
      </div>
    </div>

    <!-- VEILLE -->
    <div id="page-veille" class="page">
      <div class="card">
        <div class="card-hdr"><span>üì°</span><h3>Veille R√©glementaire</h3>
          <div class="ml flex" style="gap:8px">
            <button class="btn btn-secondary btn-sm" onclick="App.exportVeilleExcel()">üìä Export Excel</button>
            <label class="btn btn-ghost btn-sm" style="cursor:pointer" onclick="document.getElementById('veille-excel-input').click()">üì• Import Excel</label>
            <input type="file" id="veille-excel-input" accept=".xlsx,.xls" onchange="ExcelImport.importVeille(event)" style="display:none">
            <button class="btn btn-primary btn-sm" onclick="App.openVeilleModal()">+ Ajouter</button>
          </div>
        </div>
        <div class="card-body" id="veille-list">
          <div class="empty-state"><div class="icon">üì°</div><div>Aucune veille enregistr√©e</div></div>
        </div>
      </div>
    </div>

    <!-- PMR -->
    <div id="page-pmr" class="page">
      <!-- Barre actions -->
      <div class="card" style="margin-bottom:16px">
        <div class="card-hdr">
          <span>‚ôø</span><h3>Registre Public d'Accessibilit√© PMR</h3>
          <div style="font-size:11px;color:var(--muted);margin-left:4px">‚Äî Conforme Art. R.111-19-8 Code de la Construction</div>
          <div class="ml flex" style="gap:8px">
            <button class="btn btn-ghost btn-sm" onclick="App.exportPMRExcel()">üìä Excel</button>
            <button class="btn btn-secondary btn-sm" onclick="App.exportPMRPDF()">üìÑ Export PDF A4</button>
          </div>
        </div>
      </div>

      <!-- KPIs conformit√© -->
      <div class="pmr-header-grid" id="pmr-kpi-bar"></div>

      <!-- Informations g√©n√©rales -->
      <div class="pmr-global-card">
        <div class="pmr-global-title">üìã Informations G√©n√©rales du Registre</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Pr√©sence du registre √† l'accueil</label>
            <select class="pmr-status-sel" id="pmr-presence" onchange="App.savePMR()">
              <option value="">‚Äî</option><option value="ok">‚úÖ Conforme ‚Äî Registre pr√©sent</option>
              <option value="partial">‚ö† Partiel ‚Äî En cours de constitution</option>
              <option value="ko">‚ùå Non conforme ‚Äî Absent</option>
            </select>
          </div>
          <div class="form-group">
            <label>Date de mise √† jour du registre</label>
            <input type="date" id="pmr-date" onchange="App.savePMR()">
          </div>
          <div class="form-group">
            <label>Attestation d'accessibilit√© (Art. D.111-19-46)</label>
            <select class="pmr-status-sel" id="pmr-attestation" onchange="App.savePMR()">
              <option value="">‚Äî</option><option value="ok">‚úÖ D√©livr√©e et affich√©e</option>
              <option value="partial">‚ö† En cours de d√©livrance</option>
              <option value="ko">‚ùå Manquante</option>
            </select>
          </div>
          <div class="form-group">
            <label>Agenda d'Accessibilit√© Programm√© (Ad'AP)</label>
            <select class="pmr-status-sel" id="pmr-adap" onchange="App.savePMR()">
              <option value="">‚Äî</option><option value="ok">‚úÖ Valid√© ‚Äî Engagements respect√©s</option>
              <option value="partial">‚ö† En cours</option>
              <option value="ko">‚ùå Non r√©alis√©</option>
              <option value="na">N/A ‚Äî ERP conforme avant 2015</option>
            </select>
          </div>
          <div class="form-group">
            <label>Responsable accessibilit√©</label>
            <input type="text" id="pmr-responsable" placeholder="Nom et fonction" onchange="App.savePMR()">
          </div>
          <div class="form-group">
            <label>Prochaine v√©rification programm√©e</label>
            <input type="date" id="pmr-prochaine-verif" onchange="App.savePMR()">
          </div>
        </div>
      </div>

      <!-- D√©tail par domaine -->
      <div class="card">
        <div class="card-hdr">
          <span>‚ôø</span><h3>√âvaluation D√©taill√©e ‚Äî Conformit√© par domaine</h3>
          <div style="font-size:11px;color:var(--muted);margin-left:4px">Arr√™t√© du 8 d√©cembre 2014 ¬∑ Art. R.111-19-8 CCH</div>
        </div>
        <div class="card-body">
          <!-- En-t√™te colonnes -->
          <div style="display:grid;grid-template-columns:2fr 130px 1fr 1fr;gap:10px;padding:0 0 8px;border-bottom:2px solid var(--border);margin-bottom:4px">
            <div style="font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-family:'DM Mono',monospace">Exigence r√©glementaire</div>
            <div style="font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-family:'DM Mono',monospace">Conformit√©</div>
            <div style="font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-family:'DM Mono',monospace">Observations / Travaux</div>
            <div style="font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-family:'DM Mono',monospace">√âch√©ance travaux</div>
          </div>
          <div id="pmr-detail-body"></div>
        </div>
      </div>
    </div>

    <!-- PREVENTION -->
    <div id="page-prevention" class="page">
      <div class="card">
        <div class="card-hdr">
          <span>‚ö†</span><h3>Plan de Pr√©vention</h3>
          <div class="ml"><button class="btn btn-primary btn-sm" onclick="App.exportPreventionPDF()">üìÑ Exporter sign√©</button></div>
        </div>
        <div class="card-body">
          <div class="form-grid" id="prev-form">
            <div class="form-group"><label>Entreprise ext√©rieure</label><input type="text" id="prev-entreprise" onchange="App.savePrev()"></div>
            <div class="form-group"><label>Nature des travaux</label><input type="text" id="prev-nature" onchange="App.savePrev()"></div>
            <div class="form-group"><label>Responsable chantier</label><input type="text" id="prev-responsable" onchange="App.savePrev()"></div>
            <div class="form-group"><label>Date d√©but</label><input type="date" id="prev-debut" onchange="App.savePrev()"></div>
            <div class="form-group"><label>Date fin</label><input type="date" id="prev-fin" onchange="App.savePrev()"></div>
            <div class="form-group"><label>Effectif</label><input type="number" id="prev-effectif" onchange="App.savePrev()"></div>
          </div>
          <div class="sep"></div>
          <div class="section-title">Checklist risques</div>
          <div id="prev-checklist"></div>
          <div class="sep"></div>
          <div class="section-title">Signature</div>
          <div class="form-group" style="margin-bottom:10px">
            <label>Nom du signataire</label>
            <input type="text" id="prev-signataire" placeholder="Nom Pr√©nom" onchange="App.savePrev()">
          </div>
          <canvas id="sig-canvas" width="500" height="120"></canvas>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="btn btn-ghost btn-sm" onclick="App.clearSig()">üóë Effacer</button>
            <span id="sig-ts" style="font-size:11px;color:var(--muted);margin-left:auto;align-self:center;font-family:'DM Mono',monospace"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- PERMIS DE FEU -->
    <div id="page-permisfeu" class="page">
      <div class="card">
        <div class="card-hdr">
          <span>üî•</span><h3>Permis de Feu</h3>
          <div class="ml"><button class="btn btn-primary btn-sm" onclick="App.exportPermisfeuPDF()">üìÑ Valider & Exporter</button></div>
        </div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group"><label>N¬∞ Permis</label><input type="text" id="pf-num" onchange="App.savePF()"></div>
            <div class="form-group"><label>Date</label><input type="date" id="pf-date" onchange="App.savePF()"></div>
            <div class="form-group"><label>Entreprise</label><input type="text" id="pf-entreprise" onchange="App.savePF()"></div>
            <div class="form-group"><label>Localisation travaux</label><input type="text" id="pf-local" onchange="App.savePF()"></div>
          </div>
          <div class="sep"></div>
          <div class="section-title">V√©rifications obligatoires</div>
          <div id="pf-checklist"></div>
          <div class="sep"></div>
          <div class="section-title">Signature responsable</div>
          <div class="form-group" style="margin-bottom:10px">
            <label>Nom signataire</label><input type="text" id="pf-signataire" onchange="App.savePF()">
          </div>
          <canvas id="sig-canvas-pf" width="500" height="100"></canvas>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="btn btn-ghost btn-sm" onclick="App.clearSigPF()">üóë Effacer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MAINTENANCE -->
    <div id="page-maintenance" class="page">
      <div class="card">
        <div class="card-hdr">
          <span>üîß</span><h3>Maintenance & Anomalies</h3>
          <div class="ml flex" style="gap:8px">
            <button class="btn btn-secondary btn-sm" onclick="App.exportMaintenanceExcel()">üìä Export Excel</button>
            <label class="btn btn-ghost btn-sm" style="cursor:pointer" onclick="document.getElementById('maint-excel-input').click()">üì• Import Excel</label>
            <input type="file" id="maint-excel-input" accept=".xlsx,.xls" onchange="ExcelImport.importMaintenance(event)" style="display:none">
            <button class="btn btn-primary btn-sm" onclick="App.openMaintModal()">+ Anomalie</button>
          </div>
        </div>
        <div class="card-body" id="maint-list">
          <div class="empty-state"><div class="icon">üîß</div><div>Aucune anomalie enregistr√©e</div></div>
        </div>
      </div>
    </div>

    <!-- RONDES -->
    <div id="page-rondes" class="page">
      <div class="card">
        <div class="card-hdr">
          <span>üîÑ</span><h3>Gammes & Rondes</h3>
          <div class="ml flex" style="gap:8px">
            <button class="btn btn-secondary btn-sm" onclick="App.exportRondesExcel()">üìä Export Excel</button>
            <label class="btn btn-ghost btn-sm" style="cursor:pointer" onclick="document.getElementById('rondes-excel-input').click()">üì• Import Excel</label>
            <input type="file" id="rondes-excel-input" accept=".xlsx,.xls" onchange="ExcelImport.importRondes(event)" style="display:none">
            <button class="btn btn-primary btn-sm" onclick="App.openRondeModal()">+ Ronde</button>
          </div>
        </div>
        <div class="card-body" id="rondes-list">
          <div class="empty-state"><div class="icon">üîÑ</div><div>Aucune ronde enregistr√©e</div></div>
        </div>
      </div>
    </div>

    <!-- SANITAIRE -->
    <div id="page-sanitaire" class="page">

      <!-- Barre actions + s√©lecteur de ronde -->
      <div class="card" style="margin-bottom:16px">
        <div class="card-hdr">
          <span>üíß</span><h3>Carnet Sanitaire ‚Äî Rondes ECS</h3>
          <div style="font-size:11px;color:var(--muted);margin-left:4px">Arr√™t√© 1er f√©v. 2010 ¬∑ Circulaire DGS/EA4 2010-448 ¬∑ Protocole l√©gionellose UCPA</div>
          <div class="ml flex" style="gap:8px">
            <button class="btn btn-ghost btn-sm" onclick="ECS.exportExcel()">üìä Excel</button>
            <button class="btn btn-ghost btn-sm" onclick="ECS.exportPDF()">üìÑ PDF</button>
            <button class="btn btn-primary btn-sm" onclick="ECS.saveReleve()">üíæ Enregistrer le relev√©</button>
          </div>
        </div>
        <!-- M√©tadonn√©es de la ronde -->
        <div class="card-body" style="padding-top:12px;padding-bottom:12px">
          <div class="form-grid">
            <div class="form-group">
              <label>Date & heure de la ronde</label>
              <input type="datetime-local" id="ecs-datetime" value="">
            </div>
            <div class="form-group">
              <label>Op√©rateur</label>
              <input type="text" id="ecs-operateur" placeholder="Nom et pr√©nom">
            </div>
            <div class="form-group">
              <label>Fr√©quence</label>
              <select id="ecs-frequence">
                <option value="hebdo">Hebdomadaire</option>
                <option value="mensuel">Mensuelle</option>
                <option value="trimestriel">Trimestrielle</option>
                <option value="annuel">Annuelle</option>
                <option value="incident">Suite incident</option>
              </select>
            </div>
            <div class="form-group">
              <label>Observations g√©n√©rales</label>
              <input type="text" id="ecs-obs-general" placeholder="Observations globales‚Ä¶">
            </div>
          </div>
        </div>
      </div>

      <!-- Layout 2 colonnes -->
      <div class="ecs-layout">

        <!-- Gauche : formulaire de saisie -->
        <div id="ecs-form-wrap"></div>

        <!-- Droite : r√©sum√© + historique -->
        <div class="ecs-side-panel">

          <!-- R√©sum√© anomalies ronde en cours -->
          <div class="ecs-summary-card">
            <div class="ecs-summary-title">üìä R√©sum√© ‚Äî Ronde en cours</div>
            <div id="ecs-summary-body">
              <div style="font-size:12px;color:var(--muted)">Saisissez des mesures pour voir le r√©sum√©.</div>
            </div>
          </div>

          <!-- Purges r√©seau -->
          <div class="card">
            <div class="card-hdr"><span>üîµ</span><h3 style="font-size:13px">Purges r√©seau</h3>
              <button class="btn btn-ghost btn-sm ml" onclick="App.addPurgeRow()">+ Purge</button>
            </div>
            <div class="card-body" style="padding:12px">
              <div style="display:grid;grid-template-columns:110px 1fr 1fr 36px;gap:6px;padding-bottom:6px;margin-bottom:6px;border-bottom:1px solid var(--border)">
                <div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-family:'DM Mono',monospace">Date</div>
                <div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-family:'DM Mono',monospace">Circuit</div>
                <div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-family:'DM Mono',monospace">Op√©rateur</div>
                <div></div>
              </div>
              <div id="purge-rows"></div>
            </div>
          </div>

          <!-- Historique des rondes -->
          <div class="card">
            <div class="card-hdr">
              <span>üìã</span><h3 style="font-size:13px">Historique des rondes</h3>
              <span id="ecs-history-count" style="font-size:11px;color:var(--muted);margin-left:4px"></span>
            </div>
            <div class="card-body" style="padding:12px;max-height:350px;overflow-y:auto">
              <div id="ecs-history-body"></div>
            </div>
          </div>

        </div>
      </div>

    </div>

    <!-- RH -->
    <div id="page-rh" class="page">
      <div class="card">
        <div class="card-hdr">
          <span>üë§</span><h3>RH ‚Äî Habilitations</h3>
          <div class="ml flex" style="gap:8px">
            <button class="btn btn-secondary btn-sm" onclick="App.exportRHExcel()">üìä Export Excel</button>
            <label class="btn btn-ghost btn-sm" style="cursor:pointer" onclick="document.getElementById('rh-excel-input').click()">üì• Import Excel</label>
            <input type="file" id="rh-excel-input" accept=".xlsx,.xls" onchange="ExcelImport.importRH(event)" style="display:none">
            <button class="btn btn-primary btn-sm" onclick="App.openRHModal()">+ Collaborateur</button>
          </div>
        </div>
        <div class="card-body" id="rh-list">
          <div class="empty-state"><div class="icon">üë§</div><div>Aucune habilitation enregistr√©e</div></div>
        </div>
      </div>
    </div>

    <!-- CONTRATS -->
    <div id="page-contrats" class="page">
      <div class="card">
        <div class="card-hdr">
          <span>üìã</span><h3>Contrats R√©glementaires</h3>
          <div class="ml flex" style="gap:8px">
            <button class="btn btn-secondary btn-sm" onclick="App.exportContratsExcel()">üìä Export Excel</button>
            <label class="btn btn-ghost btn-sm" style="cursor:pointer" onclick="document.getElementById('contrats-excel-input').click()">üì• Import Excel</label>
            <input type="file" id="contrats-excel-input" accept=".xlsx,.xls" onchange="ExcelImport.importContrats(event)" style="display:none">
            <button class="btn btn-primary btn-sm" onclick="App.openContratModal()">+ Contrat</button>
          </div>
        </div>
        <div class="card-body" id="contrats-list">
          <div class="empty-state"><div class="icon">üìã</div><div>Aucun contrat enregistr√©</div></div>
        </div>
      </div>
    </div>

    <!-- CHECKLISTS METIER -->
    <div id="page-checklists" class="page">
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px">
        <button class="btn btn-secondary" onclick="App.showChecklist('organisation')">üìã Organisation</button>
        <button class="btn btn-secondary" onclick="App.showChecklist('financier')">üí∞ Financier</button>
        <button class="btn btn-secondary" onclick="App.showChecklist('performance')">üìä Performance</button>
        <button class="btn btn-secondary" onclick="App.showChecklist('gmao')">üñ• GMAO</button>
        <button class="btn btn-secondary" onclick="App.showChecklist('conformite')">‚úÖ Conformit√© ERP</button>
      </div>
      <div id="checklist-panel"></div>
    </div>

    <!-- INVESTISSEMENTS -->
    <div id="page-investissements" class="page">
      <div class="kpi-grid" id="inv-kpi-grid"></div>
      <div class="card">
        <div class="card-hdr">
          <span>üí∞</span><h3>Suivi des Investissements GER</h3>
          <div class="ml flex" style="gap:8px">
            <select id="inv-annee-filter" class="centre-selector" style="width:100px" onchange="App.renderInvestissements()">
              <option value="">Toutes ann√©es</option>
              <option value="2024">2024</option>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
              <option value="2027">2027</option>
              <option value="2028">2028</option>
            </select>
            <select id="inv-cat-filter" class="centre-selector" style="width:160px" onchange="App.renderInvestissements()">
              <option value="">Toutes cat√©gories</option>
              <option value="GER">GER</option>
              <option value="IMMOBILIER">IMMOBILIER</option>
              <option value="MOBILIER">MOBILIER</option>
              <option value="TRANSITION ECOLOGIQUE">TRANSITION √âCOLO</option>
              <option value="INFORMATIQUE">INFORMATIQUE</option>
              <option value="MARQUES DESTINATION">MARQUES DESTINATION</option>
            </select>
            <select id="inv-statut-filter" class="centre-selector" style="width:140px" onchange="App.renderInvestissements()">
              <option value="">Tous statuts</option>
              <option value="Pas commenc√©">Pas commenc√©</option>
              <option value="En cours">En cours</option>
              <option value="Terminer">Termin√©</option>
              <option value="Projet">Projet</option>
              <option value="Report">Report</option>
              <option value="Devis sign√©">Devis sign√©</option>
            </select>
            <button class="btn btn-primary btn-sm" onclick="App.openInvModal()">+ Investissement</button>
            <button class="btn btn-secondary btn-sm" onclick="App.exportInvExcel()">üìä Export Excel</button>
            <button class="btn btn-secondary btn-sm" onclick="App.exportInvPDF()">üìÑ Export PDF</button>
            <label class="btn btn-ghost btn-sm" style="cursor:pointer" onclick="document.getElementById('inv-excel-input').click()">üì• Import Excel</label>
            <input type="file" id="inv-excel-input" accept=".xlsx,.xls,.csv" onchange="App.handleInvImport(event)" style="display:none">
          </div>
        </div>
        <div style="overflow:auto;max-height:65vh" id="inv-table-wrap"></div>
      </div>
    </div>

    <!-- TACHES -->
    <div id="page-taches" class="page">
      <div class="card">
        <div class="card-hdr">
          <span>üìå</span><h3>T√¢ches & Actions</h3>
          <div class="ml flex" style="gap:8px">
            <button class="btn btn-secondary btn-sm" onclick="App.exportTachesExcel()">üìä Export Excel</button>
            <label class="btn btn-ghost btn-sm" style="cursor:pointer" onclick="document.getElementById('taches-excel-input').click()">üì• Import Excel</label>
            <input type="file" id="taches-excel-input" accept=".xlsx,.xls" onchange="ExcelImport.importTaches(event)" style="display:none">
            <button class="btn btn-primary btn-sm" onclick="App.openTacheModal()">+ T√¢che</button>
          </div>
        </div>
        <div class="card-body" id="taches-list">
          <div class="empty-state"><div class="icon">üìå</div><div>Aucune t√¢che enregistr√©e</div></div>
        </div>
      </div>
    </div>

    <!-- GED DOCUMENTS -->
    <div id="page-ged" class="page">
      <div class="ged-layout">
        <!-- Arborescence -->
        <div class="ged-tree-panel">
          <div class="ged-tree-head">üìÅ Arborescence</div>
          <div class="ged-tree-body" id="ged-tree-body"></div>
        </div>
        <!-- Contenu dossier -->
        <div class="ged-content-panel">
          <div class="ged-content-head">
            <span id="ged-folder-icon">üìÇ</span>
            <h3 id="ged-folder-title">S√©lectionnez un dossier</h3>
            <div class="ml flex" style="gap:8px">
              <button class="btn btn-primary btn-sm" id="ged-add-btn" onclick="GED.openAddDoc()" style="display:none">+ Lier un document</button>
            </div>
          </div>
          <div class="ged-breadcrumb" id="ged-breadcrumb" style="display:none"></div>
          <div class="ged-content-body" id="ged-content-body">
            <div class="ged-section-placeholder">
              <div class="icon">üìÅ</div>
              <h3>Gestion √âlectronique des Documents</h3>
              <div style="font-size:13px;color:var(--muted)">S√©lectionnez un dossier dans l'arborescence<br>pour consulter ou lier des documents Drive.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ADMIN CENTRES -->
    <div id="page-admin" class="page">

      <!-- KPIs -->
      <div class="admin-kpi-bar">
        <div class="admin-kpi">
          <div class="admin-kpi-val" id="adm-kpi-sud">‚Äî</div>
          <div class="admin-kpi-label">Centres Alpes Sud</div>
        </div>
        <div class="admin-kpi">
          <div class="admin-kpi-val" id="adm-kpi-nord">‚Äî</div>
          <div class="admin-kpi-label">Centres Alpes Nord</div>
        </div>
        <div class="admin-kpi">
          <div class="admin-kpi-val" id="adm-kpi-total">‚Äî</div>
          <div class="admin-kpi-label">Total centres</div>
        </div>
      </div>

      <!-- Alpes Sud -->
      <div class="card">
        <div class="card-hdr">
          <span>‚öôÔ∏è</span>
          <h3>Gestion des Centres</h3>
          <span class="admin-region-badge sud">‚ñ≤ Alpes Sud</span>
          <div class="ml flex" style="gap:8px">
            <button class="btn btn-ghost btn-sm" onclick="Admin.importCentres('SUD')">üì• Import liste</button>
            <button class="btn btn-primary btn-sm" onclick="Admin.openAddModal('SUD')">+ Ajouter un centre</button>
          </div>
        </div>
        <div class="card-body">
          <div class="admin-centres-grid" id="admin-list-sud"></div>
        </div>
      </div>

      <!-- Alpes Nord -->
      <div class="card">
        <div class="card-hdr">
          <span>‚öôÔ∏è</span>
          <h3>Gestion des Centres</h3>
          <span class="admin-region-badge nord">‚ñ≤ Alpes Nord</span>
          <div class="ml flex" style="gap:8px">
            <button class="btn btn-ghost btn-sm" onclick="Admin.importCentres('NORD')">üì• Import liste</button>
            <button class="btn btn-primary btn-sm" onclick="Admin.openAddModal('NORD')">+ Ajouter un centre</button>
          </div>
        </div>
        <div class="card-body">
          <div class="admin-centres-grid" id="admin-list-nord"></div>
        </div>
      </div>

    </div><!-- /page-admin -->

  </div><!-- /content -->
</div><!-- /main -->

<!-- MODAL -->
<div class="modal-overlay" id="modal-overlay" onclick="App.closeModal(event)">
  <div class="modal" id="modal-inner">
    <h2 id="modal-title">Titre</h2>
    <div id="modal-body"></div>
    <div style="margin-top:20px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="App.closeModal()">Annuler</button>
      <button class="btn btn-primary" id="modal-save" onclick="App.saveModal()">Enregistrer</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA LAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CENTRES est rempli dynamiquement par Auth.startSession() selon la r√©gion connect√©e
const CENTRES = [];

const CONTROLES_TEMPLATE = [
  {catId:"1",groupe:"Renseignements",libelle:"Renseignements sur l'√©tablissement",periodicite:null},
  {catId:"2",groupe:"Commissions s√©curit√©",libelle:"PV commissions de s√©curit√©",periodicite:null},
  {catId:"3.1",groupe:"Formations",libelle:"Formations ‚Äì Extincteurs & √©vacuation",periodicite:"Annuel"},
  {catId:"3.2",groupe:"Formations",libelle:"Formations ‚Äì Centrale incendie",periodicite:"Annuel"},
  {catId:"4.1",groupe:"Lutte incendie",libelle:"Extincteurs",periodicite:"Annuel"},
  {catId:"4.2",groupe:"Lutte incendie",libelle:"SSI",periodicite:"Annuel"},
  {catId:"4.3",groupe:"Lutte incendie",libelle:"SSI Triennale",periodicite:"Triennal"},
  {catId:"4.4",groupe:"Lutte incendie",libelle:"DAS",periodicite:"Annuel"},
  {catId:"4.5",groupe:"Lutte incendie",libelle:"RIA",periodicite:"Annuel"},
  {catId:"4.6",groupe:"Lutte incendie",libelle:"Colonne s√®che / PEI",periodicite:null},
  {catId:"4.7",groupe:"Lutte incendie",libelle:"Sprinkler",periodicite:null},
  {catId:"4.8",groupe:"Lutte incendie",libelle:"D√©senfumage",periodicite:"Annuel"},
  {catId:"5.1",groupe:"√âlectrique",libelle:"V√©rif. √©lectrique Q18",periodicite:"Annuel"},
  {catId:"5.2",groupe:"√âlectrique",libelle:"V√©rif. √©lectrique Q19",periodicite:"Annuel"},
  {catId:"5.3",groupe:"√âlectrique",libelle:"BAES/BAEH/Ambiance",periodicite:"Annuel"},
  {catId:"6.1",groupe:"M√©canique",libelle:"Ascenseurs / Monte-charge",periodicite:"Annuel"},
  {catId:"6.2",groupe:"M√©canique",libelle:"Quinquennal VRE+CTQ",periodicite:"Quinquennal"},
  {catId:"6.3",groupe:"M√©canique",libelle:"Portes auto et barri√®res",periodicite:null},
  {catId:"6.4",groupe:"M√©canique",libelle:"Compacteurs",periodicite:null},
  {catId:"7.1",groupe:"Gaz",libelle:"Contr√¥le r√©seaux gaz",periodicite:"Annuel"},
  {catId:"7.2",groupe:"Gaz",libelle:"Maintenance gaz/fioul ‚Äì chaudi√®res",periodicite:"Annuel"},
  {catId:"7.3",groupe:"Gaz",libelle:"Appareils cuisson feux vifs",periodicite:"Annuel"},
  {catId:"7.4",groupe:"Gaz",libelle:"Ramonage conduits chaufferies",periodicite:"Annuel"},
  {catId:"8.1",groupe:"Gaz frigorig√®ne",libelle:"Performance √©nerg√©tique > 12 kW",periodicite:null},
  {catId:"8.2",groupe:"Gaz frigorig√®ne",libelle:"√âtanch√©it√© gaz frigorig√®ne",periodicite:"Annuel"},
  {catId:"9",groupe:"EPC/EPI",libelle:"V√©rifications EPC / EPI",periodicite:null},
  {catId:"10.1",groupe:"QAI/Ventilation",libelle:"QAI ‚Äì D√©graissage hottes cuisine",periodicite:"Annuel"},
  {catId:"10.2",groupe:"QAI/Ventilation",libelle:"QAI ‚Äì Nettoyage r√©seaux ventilation",periodicite:null},
  {catId:"11",groupe:"Installations sportives",libelle:"Installations sportives",periodicite:null},
  {catId:"12",groupe:"D√©fibrillateurs",libelle:"D√©fibrillateurs",periodicite:null},
  {catId:"13",groupe:"Radon",libelle:"Radon",periodicite:null},
  {catId:"14",groupe:"Divers",libelle:"Divers",periodicite:null},
  {catId:"15.1",groupe:"Carnet sanitaire",libelle:"Carnet sanitaire ‚Äì L√©gionellose",periodicite:"Semestriel"},
  {catId:"15.2",groupe:"Carnet sanitaire",libelle:"Carnet sanitaire ‚Äì Disconnecteur",periodicite:"Annuel"},
  {catId:"16",groupe:"Bac √† graisse",libelle:"Entretien bac √† graisse",periodicite:"Annuel"},
  {catId:"17",groupe:"Citerne gaz",libelle:"S√©curit√© citerne gaz",periodicite:"40 mois"},
];

// ‚îÄ‚îÄ PMR ‚Äî Structure r√©glementaire compl√®te ‚îÄ‚îÄ
// Conforme √† l'arr√™t√© du 8 d√©cembre 2014 et Art. R.111-19-8 CCH
const PMR_SECTIONS = [
  {
    id: 'cheminements', icon: 'üö∂', label: 'Cheminements Ext√©rieurs',
    ref: 'Art. 1 √† 6 ‚Äî Arr. 8/12/2014',
    items: [
      { id:'che_1', label:'Largeur minimale du cheminement', ref:'‚â• 1,40 m (‚â• 1,20 m avec √©largissement)', note:'R√©tr√©cissement ponctuel tol√©r√© √† 0,90 m si impossible' },
      { id:'che_2', label:'Pente longitudinale', ref:'‚â§ 5% (8% exceptionnellement, 12% si < 2m)', note:'Palier de repos de 1,20m tous les 10m si > 5%' },
      { id:'che_3', label:'Pente transversale (d√©vers)', ref:'‚â§ 2%', note:'' },
      { id:'che_4', label:'Rev√™tement non glissant et non meuble', ref:'Sol stable, non glissant, sans obstacle', note:'Bande d\'√©veil de vigilance aux travers√©es pi√©tonnes' },
      { id:'che_5', label:'Ressauts et seuils', ref:'Hauteur ‚â§ 2 cm (bord arrondi ou chanfrein 1/3)', note:'Maximum 4 cm avec chanfrein double pente ‚â§ 33%' },
      { id:'che_6', label:'Espaces de man≈ìuvre et de retournement', ref:'‚åÄ 1,50 m disponible', note:'En haut/bas de rampe et √† chaque changement de direction' },
    ]
  },
  {
    id: 'stationnement', icon: 'üÖø', label: 'Stationnement',
    ref: 'Art. 3 ‚Äî Arr. 8/12/2014',
    items: [
      { id:'sta_1', label:'Nombre de places PMR', ref:'1 place / 50 places (min. 1)', note:'Signalisation verticale et marquage au sol obligatoires' },
      { id:'sta_2', label:'Dimensions des emplacements', ref:'3,30 m √ó 5,00 m minimum', note:'' },
      { id:'sta_3', label:'Proximit√© entr√©e principale / ascenseur', ref:'Acc√®s direct ou cheminement adapt√©', note:'Distance raisonnable selon configuration du site' },
      { id:'sta_4', label:'Signal√©tique et marquage', ref:'Pictogramme T3 (ISO 7001)', note:'Panneau B6d + marquage horizontal' },
    ]
  },
  {
    id: 'acces_entree', icon: 'üö™', label: 'Acc√®s et Entr√©es',
    ref: 'Art. 7 √† 9 ‚Äî Arr. 8/12/2014',
    items: [
      { id:'acc_1', label:'Largeur de passage de la porte principale', ref:'‚â• 0,90 m (vantail ‚â• 0,83 m utile)', note:'' },
      { id:'acc_2', label:'Hauteur du seuil', ref:'‚â§ 2 cm', note:'Ressaut √† bords arrondis ou chanfrein ‚â§ 1/3' },
      { id:'acc_3', label:'Poign√©e / dispositif de man≈ìuvre', ref:'√Ä 0,80 m ‚â§ h ‚â§ 1,30 m du sol', note:'Man≈ìuvrable en poing ferm√© sans pr√©hension fine' },
      { id:'acc_4', label:'Espace de man≈ìuvre c√¥t√© poign√©e (tirant)', ref:'‚â• 0,50 m en dehors du d√©battement', note:'Espace libre ‚â• 1,20 m √ó 1,40 m devant la porte' },
      { id:'acc_5', label:'Contraste visuel porte/paroi', ref:'Contraste suffisant (facteur de r√©flexion ‚â• 30%)', note:'' },
      { id:'acc_6', label:'Dispositif de protection du verre', ref:'Bande de signalisation √† 1,10 m et 1,70 m', note:'Si surface vitr√©e dans la porte ou les parois' },
    ]
  },
  {
    id: 'accueil', icon: 'üè®', label: 'Espaces d\'Accueil',
    ref: 'Art. 14 ‚Äî Arr. 8/12/2014',
    items: [
      { id:'accu_1', label:'Plan de travail accessible (banque d\'accueil)', ref:'Section ‚â• 0,60 m √ó 0,80 m √† h = 0,80 m max.', note:'Vide de jambes h ‚â• 0,70 m, p ‚â• 0,30 m' },
      { id:'accu_2', label:'Boucle √† induction magn√©tique (BIM)', ref:'Obligatoire si accueil sonoris√©', note:'Pictogramme "T" affich√© au guichet' },
      { id:'accu_3', label:'Cheminement accessible jusqu\'√† l\'accueil', ref:'Depuis l\'entr√©e principale ‚Äî largeur ‚â• 1,40 m', note:'' },
      { id:'accu_4', label:'Zone d\'attente accessible', ref:'Espace ‚åÄ 1,50 m disponible dans la zone d\'attente', note:'' },
    ]
  },
  {
    id: 'circulations', icon: 'üõ§', label: 'Circulations Int√©rieures Horizontales',
    ref: 'Art. 10 √† 12 ‚Äî Arr. 8/12/2014',
    items: [
      { id:'cir_1', label:'Largeur minimale des couloirs', ref:'‚â• 1,40 m (r√©tr√©cissement √† 1,20 m admis)', note:'Espace de retournement ‚åÄ 1,50 m tous les 10 m' },
      { id:'cir_2', label:'Rev√™tements de sol', ref:'Non glissant, sans ressaut > 2 cm', note:'' },
      { id:'cir_3', label:'√âl√©ments en saillie dans couloir', ref:'Obstacles d√©tectables √† la canne si h < 2,20 m', note:'Bandeau de protection ou potelet d√©tectable √† la canne' },
      { id:'cir_4', label:'Signal√©tique directionnelle', ref:'Hauteur 1,40 m ‚Äì 1,70 m, contrast√©', note:'Braille et relief pour les personnes d√©ficientes visuelles' },
    ]
  },
  {
    id: 'escaliers', icon: 'ü™ú', label: 'Escaliers',
    ref: 'Art. 13 ‚Äî Arr. 8/12/2014',
    items: [
      { id:'esc_1', label:'Largeur minimale entre mains courantes', ref:'‚â• 1,20 m', note:'' },
      { id:'esc_2', label:'Mains courantes des deux c√¥t√©s', ref:'Continues, √† h = 0,90 m (+ h = 0,70 m recommand√©e)', note:'D√©passant de 0,28 m en haut, 0,30 m + hauteur marche en bas' },
      { id:'esc_3', label:'Contremarches visibles (nez de marche)', ref:'Contrast√©s sur 2 √† 3 cm en haut de marche', note:'Nez de marche antid√©rapants' },
      { id:'esc_4', label:'Signalisation en haut et en bas d\'escalier', ref:'Bande d\'√©veil de vigilance ‚â• 0,50 m de large', note:'Perpendiculaire √† l\'axe de circulation' },
      { id:'esc_5', label:'Hauteur / giron des marches', ref:'Hauteur ‚â§ 17 cm ‚Äî Giron ‚â• 28 cm', note:'' },
    ]
  },
  {
    id: 'ascenseurs', icon: 'üõó', label: 'Ascenseurs et √âquipements de Franchissement',
    ref: 'Norme EN 81-70 ¬∑ Art. R.125-2-2 CCH',
    items: [
      { id:'asc_1', label:'Dimensions cabine', ref:'1,00 m √ó 1,30 m minimum (pr√©f√©rable 1,10 m √ó 1,40 m)', note:'' },
      { id:'asc_2', label:'Dimensions palier de d√©barquement', ref:'1,50 m √ó 1,50 m hors d√©battement portes', note:'' },
      { id:'asc_3', label:'Commandes (int√©rieur et palier)', ref:'√Ä h = 0,90 m ‚Äì 1,10 m, relief + braille + sonorisation', note:'Pas plus de 0,45 m du c√¥t√© de l\'entr√©e' },
      { id:'asc_4', label:'Miroir dans la cabine', ref:'Du sol au plafond si profondeur > largeur', note:'Permet de voir l\'arri√®re sans se retourner' },
      { id:'asc_5', label:'Temps de maintien portes ouvertes', ref:'‚â• 5 secondes (param√©trable)', note:'' },
    ]
  },
  {
    id: 'sanitaires', icon: 'üöª', label: 'Sanitaires et Vestiaires PMR',
    ref: 'Art. 16 ‚Äî Arr. 8/12/2014',
    items: [
      { id:'san_1', label:'Pr√©sence de sanitaires PMR', ref:'‚â• 1 WC accessible si WC public', note:'Ou 1 WC mixte accessible si s√©paration H/F' },
      { id:'san_2', label:'Dimensions du cabinet', ref:'1,50 m √ó 2,10 m (hors rayon de giration)', note:'Espace de giration ‚åÄ 1,50 m devant cuvette' },
      { id:'san_3', label:'Barre d\'appui lat√©rale rabattable', ref:'√Ä h = 0,70 m ‚Äì 0,80 m, √† 0,40 m de l\'axe cuvette', note:'D√©passe en avant de 0,20 m le bord avant cuvette' },
      { id:'san_4', label:'Dispositif de commande de chasse', ref:'√Ä h ‚â§ 0,80 m ou lat√©ral entre 0,80 et 1,30 m', note:'' },
      { id:'san_5', label:'Lavabo accessible (si cabinet s√©par√©)', ref:'Bord sup√©rieur ‚â§ 0,85 m, vide de jambes h ‚â• 0,70 m', note:'Robinetterie man≈ìuvrable au poing ferm√©' },
      { id:'san_6', label:'Dispositif d\'appel en cas de chute', ref:'Alarme accessible depuis sol (bouton ‚â§ 0,40 m)', note:'' },
      { id:'san_7', label:'Vestiaires accessibles (si vestiaires)', ref:'‚â• 1 box accessible, banc √† h = 0,45 m ‚Äì 0,50 m', note:'Pat√®re √† h ‚â§ 1,30 m, espace ‚åÄ 1,50 m' },
    ]
  },
  {
    id: 'hebergement', icon: 'üõè', label: 'Chambres / H√©bergement Accessible',
    ref: 'Art. 17 ‚Äî Arr. 8/12/2014 (ERP cat√©gorie h√©bergement)',
    items: [
      { id:'heb_1', label:'Quota de chambres accessibles', ref:'Si ‚â• 20 chambres : 1/20 accessibles, min. 1', note:'' },
      { id:'heb_2', label:'Espace libre autour du lit', ref:'‚â• 0,90 m sur un grand c√¥t√© et au pied du lit', note:'Espace retournement ‚åÄ 1,50 m dans la chambre' },
      { id:'heb_3', label:'Hauteur du lit', ref:'Entre 0,40 m et 0,50 m du sol', note:'' },
      { id:'heb_4', label:'Salle de bain attenante accessible', ref:'Espace ‚åÄ 1,50 m, douche de plain-pied ou bac √† rebord ‚â§ 2 cm', note:'Si√®ge de douche rabattable conseill√©' },
      { id:'heb_5', label:'Accessoires (interrupteurs, prises)', ref:'Entre 0,90 m et 1,30 m du sol', note:'T√©l√©phone, TV, thermostat √† port√©e depuis le lit' },
    ]
  },
  {
    id: 'restauration', icon: 'üçΩ', label: 'Restauration et Espaces Collectifs',
    ref: 'Art. 14 ‚Äî Arr. 8/12/2014',
    items: [
      { id:'res_1', label:'Cheminement accessible jusqu\'√† la salle', ref:'Largeur ‚â• 1,40 m depuis l\'entr√©e', note:'' },
      { id:'res_2', label:'Tables accessibles en fauteuil roulant', ref:'h plan de travail ‚â§ 0,80 m, vide dessous h ‚â• 0,70 m', note:'‚â• 2% des places ou au moins 1 table accessible' },
      { id:'res_3', label:'Acc√®s au self / buffet', ref:'Plan de pr√©sentation ‚â§ 0,80 m, passage ‚â• 1,40 m', note:'' },
      { id:'res_4', label:'√âclairage suffisant', ref:'‚â• 100 lux en tout point de l\'espace', note:'' },
    ]
  },
  {
    id: 'sport', icon: '‚õ∑', label: '√âquipements et Espaces Sportifs',
    ref: 'Art. 19 ‚Äî Arr. 8/12/2014',
    items: [
      { id:'spo_1', label:'Cheminement vers les √©quipements sportifs', ref:'Adapt√© fauteuil ‚Äî largeur ‚â• 1,40 m', note:'Depuis accueil / d√©pose-minute' },
      { id:'spo_2', label:'Vestiaires sportifs accessibles', ref:'‚â• 1 vestiaire PMR ou mixte accessible', note:'Box ‚â• 1,50 m √ó 1,50 m, banc h = 0,45 m ‚Äì 0,50 m' },
      { id:'spo_3', label:'Acc√®s aux zones sportives (piste, terrain)', ref:'Plan horizontal ou acc√®s rampe ‚â§ 5%', note:'' },
      { id:'spo_4', label:'Tribunes/gradins : emplacements fauteuils', ref:'Si > 10 places : 1 emplacement PMR / 100', note:'Accompagnateur √† c√¥t√©, visibilit√© √©quivalente' },
    ]
  },
  {
    id: 'securite_evac', icon: 'üö®', label: 'S√©curit√© et √âvacuation',
    ref: 'Art. 68 ‚Äî R√®glement de s√©curit√© ERP',
    items: [
      { id:'sec_1', label:'Espaces d\'attente s√©curis√©s (EAS)', ref:'Obligatoires en √©tage si impossibilit√© d\'√©vacuation directe', note:'Signal√©s, r√©sistants au feu, communication avec secours' },
      { id:'sec_2', label:'Signalisation d\'√©vacuation accessible', ref:'Pictogrammes + sonorisation pour d√©ficients visuels', note:'Syst√®me de guidage sonore si n√©cessaire' },
      { id:'sec_3', label:'D√©clencheurs manuels d\'alarme', ref:'√Ä h = 0,90 m ‚Äì 1,30 m, accessible depuis cheminement', note:'' },
      { id:'sec_4', label:'Syst√®me d\'alerte sonore ET visuel', ref:'Flash lumineux si locaux √† forte nuisance sonore', note:'' },
    ]
  },
  {
    id: 'signalisation', icon: 'ü™ß', label: 'Signal√©tique et Communication',
    ref: 'Art. 20 ‚Äî Arr. 8/12/2014',
    items: [
      { id:'sig_1', label:'Hauteur d\'affichage des informations', ref:'Entre 1,40 m et 1,60 m du sol', note:'' },
      { id:'sig_2', label:'Contraste visuel des panneaux', ref:'Rapport de contraste ‚â• 70%', note:'Fond clair / texte fonc√© ou invers√©' },
      { id:'sig_3', label:'Pictogrammes normalis√©s', ref:'ISO 7001 pour les pictogrammes d\'accessibilit√©', note:'' },
      { id:'sig_4', label:'Information en Braille et relief (ERP 1√®re √† 4√®me cat.)', ref:'Noms des locaux importants en braille', note:'En compl√©ment ‚Äî non obligatoire pour toute la signalisation' },
      { id:'sig_5', label:'Site internet accessible (RGAA)', ref:'Recommand√© ‚Äî Obligatoire organismes publics', note:'WCAG 2.1 niveau AA' },
    ]
  },
];

const PMR_FIELDS = ["Cheminement ext√©rieur","Stationnement PMR","Accueil","Sanitaires PMR","Signal√©tique","Circulation int√©rieure","Acc√®s sportifs","√âquipements d'assistance"];

// ‚îÄ‚îÄ ECS ‚Äî Sections et points de mesure ‚îÄ‚îÄ
// Conforme au protocole UCPA et arr√™t√© du 1er f√©vrier 2010 (l√©gionelle)
const ECS_SECTIONS = [
  {
    id:'arrivee', label:'Arriv√©e Eau Froide', icon:'üö∞', badge:'Alimentation',
    rows:[
      { id:'af_pression',  label:'Pression arriv√©e r√©seau',              unit:'bar',  ref:'3 < P < 4.5 bar',       min:3,    max:4.5  },
      { id:'af_temp',      label:'Temp√©rature eau froide (compteur)',    unit:'¬∞C',   ref:'T < 18¬∞C id√©al (< 25¬∞C)',        maxV:25  },
    ]
  },
  {
    id:'primaire', label:'Circuit Primaire Chaud', icon:'üî•', badge:'Chaudi√®res',
    rows:[
      { id:'pr_temp_chaud_1', label:'Temp√©rature d√©part chaudi√®re n¬∞1',  unit:'¬∞C',  ref:'70¬∞C < T < 80¬∞C', min:70, max:80 },
      { id:'pr_temp_chaud_2', label:'Temp√©rature d√©part chaudi√®re n¬∞2',  unit:'¬∞C',  ref:'70¬∞C < T < 80¬∞C', min:70, max:80 },
      { id:'pr_temp_chaud_3', label:'Temp√©rature d√©part chaudi√®re n¬∞3',  unit:'¬∞C',  ref:'70¬∞C < T < 80¬∞C', min:70, max:80 },
      { id:'pr_circ_1',       label:'Circulateur primaire n¬∞1 (B/M)',    unit:'',    ref:'Marche', type:'bool' },
      { id:'pr_circ_2',       label:'Circulateur primaire n¬∞2 (B/M)',    unit:'',    ref:'Marche', type:'bool' },
      { id:'pr_fuites',       label:'Absence de fuites apparentes',      unit:'',    ref:'Aucune fuite', type:'bool' },
      { id:'pr_echangeur',    label:'Temp√©rature sortie √©changeur',      unit:'¬∞C',  ref:'T > 55¬∞C',      minV:55  },
    ]
  },
  {
    id:'ballons', label:'Ballons ECS', icon:'ü´ô', badge:'Stockage',
    rows:[
      { id:'ba_purge_1',   label:'Chasse rapide ballon n¬∞1 effectu√©e',   unit:'',   ref:'Hebdomadaire', type:'bool' },
      { id:'ba_purge_2',   label:'Chasse rapide ballon n¬∞2 effectu√©e',   unit:'',   ref:'Hebdomadaire', type:'bool' },
      { id:'ba_purge_3',   label:'Chasse rapide ballon n¬∞3 effectu√©e',   unit:'',   ref:'Hebdomadaire', type:'bool' },
      { id:'ba_temp_1',    label:'Temp√©rature ballon n¬∞1',               unit:'¬∞C', ref:'55¬∞C < T < 65¬∞C', min:55, max:65 },
      { id:'ba_temp_2',    label:'Temp√©rature ballon n¬∞2',               unit:'¬∞C', ref:'55¬∞C < T < 65¬∞C', min:55, max:65 },
      { id:'ba_temp_3',    label:'Temp√©rature ballon n¬∞3',               unit:'¬∞C', ref:'55¬∞C < T < 65¬∞C', min:55, max:65 },
      { id:'ba_dep_aller', label:'Temp√©rature d√©part distribution (aller)', unit:'¬∞C', ref:'T ‚â§ 60¬∞C',  maxV:60 },
      { id:'ba_dep_retour',label:'Temp√©rature retour distribution',      unit:'¬∞C', ref:'Œî < 5¬∞C / T > 50¬∞C', minV:50 },
    ]
  },
  {
    id:'pompes', label:'Pompes de Circulation ECS', icon:'‚öôÔ∏è', badge:'Hydraulique',
    rows:[
      { id:'po_circ_1',    label:'Pompe de bouclage n¬∞1 (B/M)',          unit:'',   ref:'Marche', type:'bool' },
      { id:'po_circ_2',    label:'Pompe de bouclage n¬∞2 (B/M)',          unit:'',   ref:'Marche', type:'bool' },
      { id:'po_debit',     label:'D√©bit bouclage mesur√©',                unit:'L/h', ref:'Selon dimensionnement' },
    ]
  },
  {
    id:'adoucisseur', label:'Adoucisseur & Traitement', icon:'üß™', badge:'Qualit√© eau',
    rows:[
      { id:'ad_th_dur',    label:'TH eau dure (avant adoucisseur)',      unit:'¬∞f', ref:'TH selon source' },
      { id:'ad_ph',        label:'pH eau trait√©e',                        unit:'',   ref:'6.5 < pH < 8.5', min:6.5, max:8.5 },
      { id:'ad_th_ecs',    label:'TH eau ECS adoucie',                   unit:'¬∞f', ref:'TH < 10¬∞f',       maxV:10 },
      { id:'ad_th_cuis',   label:'TH eau cuisines adoucie',              unit:'¬∞f', ref:'TH < 8¬∞f',        maxV:8  },
      { id:'ad_sel',       label:'Niveau sel adoucisseur',                unit:'',   ref:'> 1/3 du bac', type:'bool' },
      { id:'ad_desor',     label:'D√©sinfection r√©siduelle (si injection)', unit:'mg/L', ref:'Selon protocole' },
    ]
  },
  {
    id:'usage', label:'Points d\'Usage ‚Äî Temp√©ratures aux robinets', icon:'üöø', badge:'Contr√¥le final',
    rows:[
      { id:'us_chambre',   label:'ECS chambre / salle de bain',          unit:'¬∞C', ref:'50¬∞C < T < 55¬∞C (mitigeur)', min:50, max:55 },
      { id:'us_douche',    label:'ECS douche collective',                unit:'¬∞C', ref:'55¬∞C < T < 60¬∞C (avant mitigeur)', min:55, max:60 },
      { id:'us_cuisine',   label:'ECS cuisine / plonge',                 unit:'¬∞C', ref:'T ‚â• 55¬∞C',       minV:55 },
      { id:'us_af_chambre',label:'Eau froide chambre / lavabo',          unit:'¬∞C', ref:'T < 25¬∞C',        maxV:25 },
      { id:'us_af_ext',    label:'Eau froide point le plus √©loign√©',     unit:'¬∞C', ref:'T < 25¬∞C',        maxV:25 },
    ]
  },
  {
    id:'compteurs', label:'Compteurs & Index', icon:'üìä', badge:'√ânergie',
    rows:[
      { id:'ct_eau_froid',  label:'Index compteur eau froide',           unit:'m¬≥',  ref:'Relev√© mensuel' },
      { id:'ct_eau_chaude', label:'Index compteur eau chaude',           unit:'m¬≥',  ref:'Relev√© mensuel' },
      { id:'ct_gaz',        label:'Index compteur gaz',                  unit:'m¬≥',  ref:'Relev√© mensuel' },
      { id:'ct_elec',       label:'Index compteur √©lectricit√©',          unit:'kWh', ref:'Relev√© mensuel' },
    ]
  },
];


const PREV_RISKS = ["Travail en hauteur","Risque √©lectrique","Levage / manutention","Points chauds","Produits chimiques","Espace confin√©","Co-activit√©","Bruit / vibrations"];
const PF_CHECKS = ["Extincteur pr√©sent et v√©rifi√©","Combustibles √©loign√©s (>5m)","Ventilation assur√©e","B√¢che ignifug√©e si n√©cessaire","Surveillance post-travaux (1h)","Carnet de s√©curit√© consult√©","Accord responsable site","Zone balis√©e"];

const CHECKLIST_DEFS = {
  organisation:{label:"Organisation",items:[
    "Nombre ETP maintenance","Ratio m¬≤ / ETP","Ratio lits / ETP","Responsable technique identifi√©",
    "Polyvalence √©quipe","Taux sous-traitance","Heures suppl√©mentaires","Taux absent√©isme","Plan de formation r√©glementaire √† jour"
  ]},
  financier:{label:"Financier",items:[
    "Masse salariale maintenance","Co√ªt maintenance ‚Ç¨/m¬≤","Co√ªt maintenance ‚Ç¨/lit","R√©partition pr√©ventif / curatif",
    "Budget gros entretien","D√©penses √©nerg√©tiques","√âvolution co√ªts sur 3 ans","Investissements vs correctif"
  ]},
  performance:{label:"Performance Op√©rationnelle",items:[
    "Taux pr√©ventif vs curatif","Nombre interventions mensuelles","D√©lai moyen traitement","Backlog",
    "Taux urgences","Taux r√©ouverture","Taux conformit√© r√©glementaire"
  ]},
  gmao:{label:"GMAO",items:[
    "% √©quipements int√©gr√©s","Plan pr√©ventif param√©tr√©","% interventions saisies","Historique exploitable",
    "Utilisation mobile","Dashboard r√©gional actif"
  ]},
  conformite:{label:"Conformit√© ERP",items:[
    "Registre s√©curit√© √† jour","Commission s√©curit√© sans r√©serve","Lev√©e observations","Contr√¥les planifi√©s",
    "Dossier amiante","Dossier accessibilit√©","SSI maintenu","Contrats r√©glementaires actifs"
  ]}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const App = {
  centre: 'ALL',
  page: 'dashboard',
  modalType: null,
  sigCanvas: null, sigCtx: null, sigDrawing: false,
  sigCanvasPF: null, sigCtxPF: null, sigDrawingPF: false,

  // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
  init() {
    // Note: centre-select est peupl√© par Auth.startSession() ‚Äî ne pas le repeupler ici

    // Init data stores
    if (!this.load('registre')) this.save('registre', this.buildInitRegistre());
    if (!this.load('pmr')) this.save('pmr', {});
    if (!this.load('observations')) this.save('observations', []);
    if (!this.load('veille')) this.save('veille', []);
    if (!this.load('maintenance')) this.save('maintenance', []);
    if (!this.load('rondes')) this.save('rondes', []);
    if (!this.load('rh')) this.save('rh', []);
    if (!this.load('contrats')) this.save('contrats', []);
    if (!this.load('taches')) this.save('taches', []);
    if (!this.load('sanitaire')) this.save('sanitaire', {ecs:[], purges:[], releves:[]});
    if (!this.load('prevention')) this.save('prevention', {risques:{}});
    if (!this.load('permisfeu')) this.save('permisfeu', {checks:{}});
    if (!this.load('checklists')) this.save('checklists', {});
    if (!this.load('matrix')) this.save('matrix', {});
    if (!this.load('investissements')) this.save('investissements', []);
    if (!this.load('syntheses')) this.save('syntheses', {});
    if (!this.load('ged'))       this.save('ged', {});

    // Populate registre groupe filter (reset first to avoid duplicates)
    const gf = document.getElementById('reg-groupe-filter');
    gf.innerHTML = '<option value="">Tous les groupes</option>';
    const groups = [...new Set(CONTROLES_TEMPLATE.map(c=>c.groupe))];
    groups.forEach(g => {const o=document.createElement('option');o.value=g;o.textContent=g;gf.appendChild(o);});

    // Signature canvases
    this.initSig();
    this.initSigPF();

    // Init prev/pf checklists
    this.renderPrevChecklist();
    this.renderPFChecklist();

    this.renderAll();
    this.nav('dashboard');
  },

  buildInitRegistre() {
    const r = {};
    CENTRES.forEach(c => {
      r[c] = CONTROLES_TEMPLATE.map(t => ({...t, id:`${c}-${t.catId}`, dateRealisation:'', resultat:'', organisme:'', prochainControle:'', observations:''}));
    });
    return r;
  },

  // ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ (pr√©fix√© par r√©gion pour isolation des donn√©es)
  _storagePrefix: 'ucpa_sud_',
  save(key, val) { try { localStorage.setItem(this._storagePrefix+key, JSON.stringify(val)); } catch(e) {} },
  load(key) { try { const v=localStorage.getItem(this._storagePrefix+key); return v?JSON.parse(v):null; } catch(e){return null;} },

  // ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
  nav(page) {
    this.page = page;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const el = document.getElementById('page-'+page);
    if (el) el.classList.add('active');
    const ni = document.querySelector(`[data-page="${page}"]`);
    if (ni) ni.classList.add('active');
    this.renderPage(page);
    // Update topbar title
    const titles = {
      dashboard:'Dashboard KPIs', synthese:'Fiche Synth√®se Centre', matrix:'Matrice Conformit√©', registre:'Registre de S√©curit√©',
      observations:'Observations', veille:'Veille R√©glementaire', pmr:'Registre PMR',
      prevention:'Plan de Pr√©vention', permisfeu:'Permis de Feu', maintenance:'Maintenance & Anomalies',
      rondes:'Gammes & Rondes', sanitaire:'Carnet Sanitaire', rh:'RH Habilitations',
      contrats:'Contrats', checklists:'Check-lists M√©tier', taches:'T√¢ches',
      investissements:'Suivi des Investissements', ged:'GED ‚Äî Documents',
      admin:'Administration ‚Äî Gestion des Centres'
    };
    document.getElementById('page-title').textContent = titles[page] || page;
    const centre = this.centre === 'ALL' ? 'Tous les centres' : this.centre.replace('VILLAGE SPORTIF ','');
    document.getElementById('page-sub').textContent = ' ¬∑ ' + centre;
  },

  selectCentre(val) {
    this.centre = val;
    this.renderConformanceBadge();
    this.renderAll();
    this.nav(this.page);
  },

  renderPage(p) {
    switch(p) {
      case 'dashboard': this.renderDashboard(); break;
      case 'synthese':  this.renderSynthese(); break;
      case 'matrix': this.renderMatrix(); break;
      case 'registre': this.renderRegistre(); break;
      case 'observations': this.renderList('observations', 'obs-list', this.renderObsItem.bind(this)); break;
      case 'veille': this.renderList('veille', 'veille-list', this.renderVeilleItem.bind(this)); break;
      case 'pmr': this.loadPMR(); break;
      case 'prevention': this.loadPrev(); break;
      case 'permisfeu': this.loadPF(); break;
      case 'maintenance': this.renderList('maintenance', 'maint-list', this.renderMaintItem.bind(this)); break;
      case 'rondes': this.renderList('rondes', 'rondes-list', this.renderRondeItem.bind(this)); break;
      case 'sanitaire': this.renderSanitaire(); break;
      case 'rh': this.renderRH(); break;
      case 'contrats': this.renderList('contrats', 'contrats-list', this.renderContratItem.bind(this)); break;
      case 'taches': this.renderList('taches', 'taches-list', this.renderTacheItem.bind(this)); break;
      case 'investissements': this.renderInvestissements(); break;
      case 'ged': GED.render(); break;
      case 'admin': Admin.render(); break;
    }
  },

  renderAll() {
    this.renderConformanceBadge();
    this.updateBadges();
  },

  // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
  getRegistreForCentre(c) {
    const all = this.load('registre') || {};
    if (c === 'ALL') {
      const merged = {};
      CONTROLES_TEMPLATE.forEach(t => {
        merged[t.catId] = { ...t, dateRealisation:'', resultat:'', organisme:'', prochainControle:'', observations:'' };
      });
      return Object.values(merged);
    }
    return all[c] || [];
  },

  isExpired(dateStr) {
    if (!dateStr) return false;
    return new Date(dateStr) < new Date();
  },
  isSoonExpiring(dateStr, days=30) {
    if (!dateStr) return false;
    const d = new Date(dateStr);
    const now = new Date();
    const diff = (d - now) / (1000*60*60*24);
    return diff >= 0 && diff <= days;
  },
  fmtDate(d) {
    if (!d) return '‚Äî';
    const dt = new Date(d);
    return isNaN(dt) ? d : dt.toLocaleDateString('fr-FR');
  },
  today() { return new Date().toISOString().split('T')[0]; },
  uuid() { return Math.random().toString(36).substr(2,9); },

  // ‚îÄ‚îÄ CONFORMANCE BADGE ‚îÄ‚îÄ
  renderConformanceBadge() {
    const badge = document.getElementById('conf-badge');
    const dot = document.getElementById('conf-dot');
    const txt = document.getElementById('conf-text');
    if (this.centre === 'ALL') {
      dot.style.background = 'var(--muted)';
      txt.textContent = CENTRES.length + ' centres ‚Äî Vue globale';
      txt.style.color = 'var(--muted)';
      return;
    }
    const rows = this.getRegistreForCentre(this.centre);
    const withDate = rows.filter(r => r.dateRealisation);
    const expired = rows.filter(r => this.isExpired(r.prochainControle));
    const total = rows.filter(r => r.periodicite).length;
    const filled = rows.filter(r => r.periodicite && r.dateRealisation).length;
    const pct = total > 0 ? Math.round(filled/total*100) : 0;
    if (expired.length > 0) {
      dot.style.background = 'var(--red)'; txt.style.color = 'var(--red)';
      txt.textContent = `${expired.length} contr√¥le(s) √©chu(s)`;
    } else if (pct >= 80) {
      dot.style.background = 'var(--green)'; txt.style.color = 'var(--green)';
      txt.textContent = `Conformit√© ${pct}%`;
    } else {
      dot.style.background = 'var(--amber)'; txt.style.color = 'var(--amber)';
      txt.textContent = `Conformit√© ${pct}%`;
    }
  },

  updateBadges() {
    // Registre: expired
    const rows = this.centre==='ALL'
      ? CENTRES.flatMap(c => this.getRegistreForCentre(c))
      : this.getRegistreForCentre(this.centre);
    const expCount = rows.filter(r => this.isExpired(r.prochainControle)).length;
    const rb = document.getElementById('badge-registre');
    rb.style.display = expCount > 0 ? '' : 'none';
    rb.textContent = expCount;

    // RH: expiring soon
    const rh = this.load('rh') || [];
    const rhExp = rh.filter(r => this.isSoonExpiring(r.expiration) || this.isExpired(r.expiration)).length;
    const rhb = document.getElementById('badge-rh');
    rhb.style.display = rhExp > 0 ? '' : 'none';
    rhb.textContent = rhExp;
  },

  // ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
  renderDashboard() {
    const allRows = this.centre==='ALL'
      ? CENTRES.flatMap(c => this.getRegistreForCentre(c))
      : this.getRegistreForCentre(this.centre);
    const periodic = allRows.filter(r => r.periodicite);
    const filled = periodic.filter(r => r.dateRealisation);
    const expired = allRows.filter(r => this.isExpired(r.prochainControle));
    const soon = allRows.filter(r => !this.isExpired(r.prochainControle) && this.isSoonExpiring(r.prochainControle, 60));
    const rh = this.load('rh') || [];
    const rhExp = rh.filter(r => this.isExpired(r.expiration) || this.isSoonExpiring(r.expiration));
    const maint = this.load('maintenance') || [];
    const open = maint.filter(m => m.statut !== 'Cl√¥tur√©');
    const pct = periodic.length > 0 ? Math.round(filled.length/periodic.length*100) : 0;

    // KPIs
    const grid = document.getElementById('kpi-grid');
    grid.innerHTML = `
      <div class="kpi ${pct>=80?'ok':pct>=50?'warn':'danger'}">
        <div class="kpi-label">Conformit√© registre</div>
        <div class="kpi-val">${pct}%</div>
        <div class="kpi-sub">${filled.length}/${periodic.length} contr√¥les renseign√©s</div>
      </div>
      <div class="kpi ${expired.length>0?'danger':'ok'}">
        <div class="kpi-label">Contr√¥les √©chus</div>
        <div class="kpi-val">${expired.length}</div>
        <div class="kpi-sub">d√©passement d'√©ch√©ance</div>
      </div>
      <div class="kpi ${soon.length>0?'warn':'ok'}">
        <div class="kpi-label">√âch√©ances < 60j</div>
        <div class="kpi-val">${soon.length}</div>
        <div class="kpi-sub">√† planifier</div>
      </div>
      <div class="kpi ${rhExp.length>0?'warn':'ok'}">
        <div class="kpi-label">Habilitations RH</div>
        <div class="kpi-val">${rhExp.length}</div>
        <div class="kpi-sub">√† renouveler</div>
      </div>
      <div class="kpi ${open.length>0?'warn':'ok'}">
        <div class="kpi-label">Anomalies ouvertes</div>
        <div class="kpi-val">${open.length}</div>
        <div class="kpi-sub">en cours de traitement</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Centres pilot√©s</div>
        <div class="kpi-val">${this.centre==='ALL'?13:1}</div>
        <div class="kpi-sub">R√©gion Alpes Sud</div>
      </div>
    `;

    // Alerts
    const az = document.getElementById('alerts-zone');
    az.innerHTML = '';
    if (expired.length > 0) az.innerHTML += `<div class="alert-banner danger">‚ö† ${expired.length} contr√¥le(s) r√©glementaire(s) d√©pass√©(s) ‚Äî action imm√©diate requise</div>`;
    if (soon.length > 0) az.innerHTML += `<div class="alert-banner warn">‚è∞ ${soon.length} contr√¥le(s) √† √©ch√©ance dans moins de 60 jours</div>`;
    if (rhExp.length > 0) az.innerHTML += `<div class="alert-banner warn">üë§ ${rhExp.length} habilitation(s) RH expir√©e(s) ou expirant bient√¥t</div>`;

    // Urgent list
    const ul = document.getElementById('urgent-list');
    const urgents = [...expired.slice(0,5).map(r => ({...r, type:'Contr√¥le √©chu', icon:'üî•', color:'var(--red)'})),
                     ...soon.slice(0,3).map(r => ({...r, type:'√âch√©ance proche', icon:'‚è∞', color:'var(--amber)'}))];
    if (urgents.length === 0) {
      ul.innerHTML = '<div class="empty-state"><div class="icon">‚úÖ</div><div>Aucune action urgente</div></div>';
    } else {
      ul.innerHTML = `<table><thead><tr><th>Type</th><th>Centre</th><th>Contr√¥le</th><th>√âch√©ance</th><th>Action</th></tr></thead><tbody>
        ${urgents.map(u => `<tr>
          <td><span style="color:${u.color}">${u.icon} ${u.type}</span></td>
          <td style="font-size:11px;color:var(--muted)">${(u.id||'').split('-')[0]||'‚Äî'}</td>
          <td>${u.libelle}</td>
          <td style="font-family:'DM Mono',monospace;font-size:12px;color:${u.color}">${this.fmtDate(u.prochainControle)}</td>
          <td><button class="btn btn-secondary btn-sm" onclick="App.nav('registre')">Renseigner</button></td>
        </tr>`).join('')}
      </tbody></table>`;
    }

    // Group progress
    const gp = document.getElementById('group-progress');
    const groups = {};
    allRows.forEach(r => {
      if (!r.periodicite) return;
      if (!groups[r.groupe]) groups[r.groupe] = {total:0, done:0};
      groups[r.groupe].total++;
      if (r.dateRealisation) groups[r.groupe].done++;
    });
    gp.innerHTML = Object.entries(groups).map(([g, v]) => {
      const pct = v.total ? Math.round(v.done/v.total*100) : 0;
      const col = pct>=80?'var(--green)':pct>=50?'var(--amber)':'var(--red)';
      return `<div style="margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px">
          <span>${g}</span><span style="font-family:'DM Mono';font-size:11px;color:var(--muted)">${v.done}/${v.total}</span>
        </div>
        <div style="background:var(--bg3);border-radius:4px;height:6px">
          <div style="width:${pct}%;height:6px;border-radius:4px;background:${col};transition:width 0.5s"></div>
        </div>
      </div>`;
    }).join('');
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚îÄ‚îÄ FICHE SYNTH√àSE CENTRE ‚îÄ‚îÄ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  renderSynthese() {
    const el = document.getElementById('synthese-container');
    if (!el) return;

    // Si aucun centre s√©lectionn√© ‚Üí invite √† choisir
    if (this.centre === 'ALL') {
      el.innerHTML = `
        <div class="card">
          <div class="card-body">
            <div class="synth-empty">
              <div class="icon">üè¢</div>
              <div style="font-size:15px;font-weight:700;margin-bottom:8px">S√©lectionnez un centre</div>
              <div style="font-size:13px;color:var(--muted)">Choisissez un centre dans le s√©lecteur en haut √† gauche<br>pour acc√©der √† sa fiche synth√®se.</div>
            </div>
          </div>
        </div>`;
      return;
    }

    const all = this.load('syntheses') || {};
    const d   = all[this.centre] || {};

    // Alertes commission de s√©curit√©
    let alertHTML = '';
    if (d.prochaine_commission) {
      const days = Math.round((new Date(d.prochaine_commission) - new Date()) / 86400000);
      if (days < 0) alertHTML = `<div class="alert-banner danger" style="margin-bottom:16px">üî¥ Commission de s√©curit√© √©chue depuis ${Math.abs(days)} jour(s) ‚Äî action requise</div>`;
      else if (days <= 90) alertHTML = `<div class="alert-banner warn" style="margin-bottom:16px">üü° Commission de s√©curit√© dans ${days} jour(s) ‚Äî pr√©parer le dossier</div>`;
    }

    el.innerHTML = `
      ${alertHTML}

      <!-- Barre d'actions -->
      <div class="card" style="margin-bottom:16px">
        <div class="card-hdr">
          <span>üè¢</span>
          <h3>${d.nom || this.centre.replace('VILLAGE SPORTIF ','')}</h3>
          <span style="font-size:11px;color:var(--muted);margin-left:4px">${d.nature ? '¬∑ ' + d.nature : ''}</span>
          <div class="ml flex" style="gap:8px">
            <button class="btn btn-ghost btn-sm" onclick="App.exportSynthesePDF()">üìÑ Exporter PDF</button>
            <button class="btn btn-primary btn-sm" onclick="App.saveSynthese()">üíæ Enregistrer</button>
          </div>
        </div>
      </div>

      <!-- Ligne 1 : Identification + Contacts -->
      <div class="synth-grid" style="margin-bottom:16px">

        <!-- Identification -->
        <div class="synth-card synth-span2" style="grid-column:span 2">
          <div class="synth-card-title"><span class="sticon">üìç</span> Identification & Localisation</div>
          <div class="synth-grid-3">
            <div class="synth-field"><label>Nom du centre</label>
              <input id="s-nom" value="${d.nom||''}">
            </div>
            <div class="synth-field"><label>Adresse</label>
              <input id="s-adresse" value="${d.adresse||''}">
            </div>
            <div class="synth-field"><label>Code postal</label>
              <input id="s-cp" value="${d.cp||''}">
            </div>
            <div class="synth-field"><label>Ville</label>
              <input id="s-ville" value="${d.ville||''}">
            </div>
            <div class="synth-field"><label>Date de construction</label>
              <input id="s-date_construction" type="number" min="1900" max="2035" placeholder="AAAA" value="${d.date_construction||''}">
            </div>
            <div class="synth-field"><label>Date de la derni√®re r√©novation</label>
              <input id="s-date_renovation" type="number" min="1900" max="2035" placeholder="AAAA" value="${d.date_renovation||''}">
            </div>
          </div>
        </div>
      </div>

      <!-- Ligne 2 : Contacts (4 colonnes) -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px;margin-bottom:16px">

        <div class="synth-card">
          <div class="synth-card-title"><span class="sticon">üë§</span> Directeur de Centre</div>
          <div class="synth-field"><label>Nom ‚Äî Pr√©nom</label><input id="s-dc_nom" value="${d.dc_nom||''}"></div>
          <div class="synth-field"><label>T√©l√©phone</label><input id="s-dc_tel" type="tel" value="${d.dc_tel||''}"></div>
          <div class="synth-field"><label>Email</label><input id="s-dc_email" type="email" value="${d.dc_email||''}"></div>
        </div>

        <div class="synth-card">
          <div class="synth-card-title"><span class="sticon">üåê</span> Directeur de R√©gion</div>
          <div class="synth-field"><label>Nom ‚Äî Pr√©nom</label><input id="s-dr_nom" value="${d.dr_nom||''}"></div>
          <div class="synth-field"><label>T√©l√©phone</label><input id="s-dr_tel" type="tel" value="${d.dr_tel||''}"></div>
          <div class="synth-field"><label>Email</label><input id="s-dr_email" type="email" value="${d.dr_email||''}"></div>
        </div>

        <div class="synth-card">
          <div class="synth-card-title"><span class="sticon">üîß</span> RM2S</div>
          <div class="synth-field"><label>Nom ‚Äî Pr√©nom</label><input id="s-rm2s_nom" value="${d.rm2s_nom||''}"></div>
          <div class="synth-field"><label>T√©l√©phone</label><input id="s-rm2s_tel" type="tel" value="${d.rm2s_tel||''}"></div>
          <div class="synth-field"><label>Email</label><input id="s-rm2s_email" type="email" value="${d.rm2s_email||''}"></div>
        </div>

        <div class="synth-card">
          <div class="synth-card-title"><span class="sticon">‚ö°</span> RT ‚Äî Resp. Technique</div>
          <div class="synth-field"><label>Nom ‚Äî Pr√©nom</label><input id="s-rt_nom" value="${d.rt_nom||''}"></div>
          <div class="synth-field"><label>T√©l√©phone</label><input id="s-rt_tel" type="tel" value="${d.rt_tel||''}"></div>
          <div class="synth-field"><label>Email</label><input id="s-rt_email" type="email" value="${d.rt_email||''}"></div>
        </div>
      </div>

      <!-- Ligne 3 : Caract√©ristiques du site + ERP + Technique -->
      <div class="synth-grid" style="margin-bottom:16px">

        <div class="synth-card">
          <div class="synth-card-title"><span class="sticon">üèó</span> Caract√©ristiques du Site</div>
          <div class="synth-field"><label>Nature du site</label>
            <select id="s-nature">
              <option value="">‚Äî</option>
              ${['Propri√©taire','Locataire','DSP','Concession','PPP','Mise √† disposition'].map(v=>`<option ${d.nature===v?'selected':''}>${v}</option>`).join('')}
            </select>
          </div>
          <div class="synth-field"><label>Dur√©e du bail (si locataire)</label>
            <input id="s-bail" value="${d.bail||''}" placeholder="Ex : 9 ans ‚Äî 2020/2029">
          </div>
          <div class="synth-field"><label>Nombre de b√¢timents</label>
            <input id="s-nb_batiments" type="number" min="1" value="${d.nb_batiments||''}">
          </div>
          <div class="synth-field"><label>Surface utile (m¬≤)</label>
            <input id="s-surface" type="number" value="${d.surface||''}">
          </div>
          <div class="synth-field"><label>Capacit√© maximale d'accueil</label>
            <input id="s-capacite" type="number" value="${d.capacite||''}">
          </div>
          <div class="synth-field"><label>Typologie de l'√©tablissement</label>
            <input id="s-typo" value="${d.typo||''}" placeholder="Ex : Centre de vacances sportif">
          </div>
        </div>

        <div class="synth-card">
          <div class="synth-card-title"><span class="sticon">üìã</span> Classification ERP</div>
          <div class="synth-field">
            <label>Types ERP <span style="font-size:9px;color:var(--muted);font-weight:400;text-transform:none;letter-spacing:0">(s√©lection multiple)</span></label>
            <div class="erp-type-grid" id="erp-type-grid">
              ${[
                ['OA','OA','H√¥tels & pensions de famille'],
                ['L','L','Salles de r√©unions & spectacles'],
                ['N','N','Restaurants & d√©bits de boissons'],
                ['R','R','Enseignement & formation'],
                ['X','X','√âtablissements sportifs'],
                ['PA','PA','√âtablissements de plein air'],
                ['M','M','Magasins & centres commerciaux'],
                ['CTS','CTS','Chapiteaux & tentes'],
                ['EF','EF','√âtablissements flottants'],
                ['U','U','Sanitaires & soins'],
                ['W','W','Administrations & banques'],
                ['Y','Y','Mus√©es'],
              ].map(([v,code,label]) => {
                const sel = Array.isArray(d.erp_types) ? d.erp_types.includes(v) : (d.erp_type === v);
                return `<div class="erp-type-item${sel?' selected':''}" onclick="App.toggleERPType('${v}',this)">
                  <div class="erp-type-checkbox">${sel?'‚úì':''}</div>
                  <span class="erp-type-code">${code}</span>
                  <span class="erp-type-label">${label}</span>
                </div>`;
              }).join('')}
            </div>
            <div class="erp-types-selected" id="erp-types-preview">
              ${(() => {
                const types = Array.isArray(d.erp_types) ? d.erp_types : (d.erp_type ? [d.erp_type] : []);
                return types.length ? '<strong>' + types.join(' + ') + '</strong>' : '<span style="color:var(--muted)">Aucun type s√©lectionn√©</span>';
              })()}
            </div>
          </div>
          <div class="synth-field"><label>Cat√©gorie ERP</label>
            <select id="s-erp_cat">
              <option value="">‚Äî</option>
              ${[['1','1√®re cat√©gorie ‚Äî > 1 500 personnes'],['2','2√®me cat√©gorie ‚Äî 701 √† 1 500'],['3','3√®me cat√©gorie ‚Äî 301 √† 700'],['4','4√®me cat√©gorie ‚Äî ‚â§ 300'],['5','5√®me cat√©gorie ‚Äî sous seuil']].map(([v,l])=>`<option value="${v}" ${d.erp_cat===v?'selected':''}>${l}</option>`).join('')}
            </select>
          </div>
          <div class="synth-field"><label>Type de Syst√®me de S√©curit√© Incendie (SSI)</label>
            <select id="s-ssi">
              <option value="">‚Äî</option>
              ${['Type A','Type B','Type C','Type D','Type E','Aucun'].map(v=>`<option ${d.ssi===v?'selected':''}>${v}</option>`).join('')}
            </select>
          </div>
          <div class="synth-field"><label>Prochaine commission de s√©curit√©</label>
            <input id="s-prochaine_commission" type="date" value="${d.prochaine_commission||''}">
          </div>
          <div class="synth-field" style="margin-top:12px">
            ${d.prochaine_commission ? (() => {
              const days = Math.round((new Date(d.prochaine_commission) - new Date()) / 86400000);
              const cls  = days < 0 ? 'ko' : days <= 90 ? 'warn' : 'ok';
              const txt  = days < 0 ? `√âchue ‚Äî ${Math.abs(days)}j` : `Dans ${days} jour(s)`;
              return `<span class="synth-badge ${cls}">${txt}</span>`;
            })() : ''}
          </div>
        </div>
      </div>

      <!-- Ligne 4 : Technique -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px">

        <div class="synth-card">
          <div class="synth-card-title"><span class="sticon">‚ö°</span> Alimentation √âlectrique</div>
          <div class="synth-field"><label>Puissance souscrite (kVA)</label>
            <input id="s-puissance_kva" type="number" value="${d.puissance_kva||''}">
          </div>
          <div class="synth-field"><label>Num√©ro PDL</label>
            <input id="s-num_pdl" value="${d.num_pdl||''}" placeholder="14 chiffres">
          </div>
        </div>

        <div class="synth-card">
          <div class="synth-card-title"><span class="sticon">üî•</span> Chauffage</div>
          <div class="synth-field"><label>Mode de chauffage</label>
            <select id="s-chauffage">
              <option value="">‚Äî</option>
              ${['Gaz naturel','Fioul','√âlectrique','Bois / Granul√©s','Pompe √† chaleur','G√©othermie','R√©seau de chaleur','Mixte'].map(v=>`<option ${d.chauffage===v?'selected':''}>${v}</option>`).join('')}
            </select>
          </div>
          <div class="synth-field"><label>Puissance chaudi√®res (kW)</label>
            <input id="s-puissance_chaud" type="number" value="${d.puissance_chaud||''}">
          </div>
        </div>

        <div class="synth-card">
          <div class="synth-card-title"><span class="sticon">üìê</span> Surfaces & Capacit√©s</div>
          <div class="synth-stat-row">
            <span>Surface utile</span>
            <span class="synth-stat-val">${d.surface ? d.surface+' m¬≤' : '‚Äî'}</span>
          </div>
          <div class="synth-stat-row">
            <span>Capacit√© max.</span>
            <span class="synth-stat-val">${d.capacite ? d.capacite+' pers.' : '‚Äî'}</span>
          </div>
          <div class="synth-stat-row">
            <span>B√¢timents</span>
            <span class="synth-stat-val">${d.nb_batiments || '‚Äî'}</span>
          </div>
          <div class="synth-stat-row">
            <span>Construction</span>
            <span class="synth-stat-val">${d.date_construction || '‚Äî'}</span>
          </div>
          <div class="synth-stat-row">
            <span>R√©novation</span>
            <span class="synth-stat-val">${d.date_renovation || '‚Äî'}</span>
          </div>
        </div>
      </div>
    `;
  },

  // Gestion multi-s√©lection types ERP
  toggleERPType(code, el) {
    el.classList.toggle('selected');
    const chk = el.querySelector('.erp-type-checkbox');
    const isNow = el.classList.contains('selected');
    chk.textContent = isNow ? '‚úì' : '';

    // Mettre √† jour la pr√©visualisation
    const selected = [...document.querySelectorAll('#erp-type-grid .erp-type-item.selected')]
      .map(i => i.querySelector('.erp-type-code').textContent.trim());
    const preview = document.getElementById('erp-types-preview');
    if (preview) {
      preview.innerHTML = selected.length
        ? '<strong>' + selected.join(' + ') + '</strong>'
        : '<span style="color:var(--muted)">Aucun type s√©lectionn√©</span>';
    }
  },

  saveSynthese() {
    if (this.centre === 'ALL') {
      alert('S√©lectionnez un centre sp√©cifique pour enregistrer sa fiche.');
      return;
    }
    const all = this.load('syntheses') || {};
    const fields = [
      'nom','adresse','cp','ville','date_construction','date_renovation',
      'dc_nom','dc_tel','dc_email',
      'dr_nom','dr_tel','dr_email',
      'rm2s_nom','rm2s_tel','rm2s_email',
      'rt_nom','rt_tel','rt_email',
      'nature','bail','nb_batiments','surface','capacite','typo',
      'erp_cat','ssi','prochaine_commission',
      'puissance_kva','num_pdl','chauffage','puissance_chaud'
    ];
    const d = {};
    fields.forEach(f => {
      const el = document.getElementById('s-' + f);
      if (el) d[f] = el.value;
    });
    // Multi-s√©lection types ERP
    d.erp_types = [...document.querySelectorAll('#erp-type-grid .erp-type-item.selected')]
      .map(i => i.querySelector('.erp-type-code').textContent.trim());
    all[this.centre] = d;
    this.save('syntheses', all);

    // Feedback visuel
    const btn = document.querySelector('[onclick="App.saveSynthese()"]');
    if (btn) {
      const orig = btn.innerHTML;
      btn.innerHTML = '‚úÖ Enregistr√©';
      btn.style.background = 'var(--green)';
      setTimeout(() => { btn.innerHTML = orig; btn.style.background = ''; }, 2000);
    }

    // Re-render pour actualiser le badge commission
    this.renderSynthese();
  },

  exportSynthesePDF() {
    if (!window.jspdf) { alert('jsPDF non disponible'); return; }
    if (this.centre === 'ALL') { alert('S√©lectionnez un centre.'); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const all = this.load('syntheses') || {};
    const d   = all[this.centre] || {};
    const nom = d.nom || this.centre.replace('VILLAGE SPORTIF ','');
    let y = 20;

    // En-t√™te UCPA
    doc.setFillColor(232, 84, 26);
    doc.rect(0, 0, 210, 12, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(10); doc.setFont('helvetica','bold');
    doc.text('UCPA ¬∑ Fiche Synth√®se Centre', 14, 8);
    doc.text(new Date().toLocaleDateString('fr-FR'), 196, 8, {align:'right'});
    doc.setTextColor(30, 30, 30);
    y = 22;

    // Titre centre
    doc.setFontSize(16); doc.setFont('helvetica','bold');
    doc.text(nom, 14, y); y += 8;
    if (d.adresse) { doc.setFontSize(10); doc.setFont('helvetica','normal'); doc.text(`${d.adresse}, ${d.cp||''} ${d.ville||''}`, 14, y); y += 6; }
    y += 4;

    const section = (title) => {
      doc.setFillColor(245, 245, 245);
      doc.rect(14, y-4, 182, 7, 'F');
      doc.setFontSize(9); doc.setFont('helvetica','bold');
      doc.setTextColor(232, 84, 26);
      doc.text(title.toUpperCase(), 16, y); y += 7;
      doc.setTextColor(30, 30, 30);
      doc.setFont('helvetica','normal');
    };
    const row = (label, value) => {
      if (!value) return;
      doc.setFontSize(9); doc.setFont('helvetica','bold');
      doc.text(label + ' :', 16, y);
      doc.setFont('helvetica','normal');
      doc.text(String(value), 80, y); y += 6;
      if (y > 270) { doc.addPage(); y = 20; }
    };

    section('Identification'); y += 2;
    row('Nature du site', d.nature);
    const erpTypes = Array.isArray(d.erp_types) ? d.erp_types.join(' + ') : (d.erp_type || '');
    row('Type(s) ERP', erpTypes);
    row('Cat√©gorie ERP', d.erp_cat);
    row('Superficie', d.surface ? d.surface+' m¬≤' : ''); row('Capacit√© max.', d.capacite ? d.capacite+' personnes' : '');
    row('Nombre de b√¢timents', d.nb_batiments); row('Construction', d.date_construction);
    row('Derni√®re r√©novation', d.date_renovation); row('Bail', d.bail);
    row('Prochaine commission', d.prochaine_commission ? new Date(d.prochaine_commission).toLocaleDateString('fr-FR') : '');
    y += 4;

    section('Contacts'); y += 2;
    const contacts = [['Directeur de Centre','dc'],['Directeur de R√©gion','dr'],['RM2S','rm2s'],['RT','rt']];
    contacts.forEach(([label, prefix]) => {
      if (d[prefix+'_nom']) {
        doc.setFontSize(9); doc.setFont('helvetica','bold'); doc.text(label+' :', 16, y); y += 5;
        doc.setFont('helvetica','normal');
        row('  Nom', d[prefix+'_nom']); row('  T√©l.', d[prefix+'_tel']); row('  Email', d[prefix+'_email']);
        y += 2;
      }
    });

    section('Technique'); y += 2;
    row('SSI', d.ssi); row('Chauffage', d.chauffage);
    row('Puissance chaudi√®res', d.puissance_chaud ? d.puissance_chaud+' kW' : '');
    row('Puissance souscrite', d.puissance_kva ? d.puissance_kva+' kVA' : '');
    row('N¬∞ PDL', d.num_pdl);

    doc.save(`UCPA_Synthese_${nom.replace(/\s/g,'_')}.pdf`);
  },

  // ‚îÄ‚îÄ MATRIX ‚îÄ‚îÄ
  renderMatrix() {
    const wrap = document.getElementById('matrix-wrap');
    const groups = [...new Set(CONTROLES_TEMPLATE.map(c=>c.groupe))];
    const matrix = this.load('matrix') || {};

    const statuses = ['', 'ok', 'warn', 'ko', 'na'];
    const icons = {'':'‚Äî','ok':'‚úì','warn':'~','ko':'‚úó','na':'N/A'};
    const cls = {'':'mce-na','ok':'mce-ok','warn':'mce-warn','ko':'mce-ko','na':'mce-na'};

    let html = `<table class="matrix-table"><thead><tr>
      <th class="domain-col">Domaine / Libell√©</th>
      ${CENTRES.map(c => `<th style="font-size:9px;max-width:70px;word-break:break-word">${c.replace('VILLAGE SPORTIF ','VS ').replace('CENTRE AQUATIQUE ','CA ')}</th>`).join('')}
    </tr></thead><tbody>`;

    groups.forEach(g => {
      const items = CONTROLES_TEMPLATE.filter(t=>t.groupe===g);
      items.forEach(t => {
        html += `<tr>
          <td class="domain-col" style="font-size:11px">${t.catId} ¬∑ ${t.libelle}</td>
          ${CENTRES.map(c => {
            const key = `${c}::${t.catId}`;
            const val = (matrix[key]||'');
            return `<td style="text-align:center;padding:4px">
              <div class="mce ${cls[val]}" onclick="App.cycleMatrix('${key}')" title="${c}\n${t.libelle}">${icons[val]}</div>
            </td>`;
          }).join('')}
        </tr>`;
      });
    });

    html += '</tbody></table>';
    wrap.innerHTML = html;
  },

  cycleMatrix(key) {
    const matrix = this.load('matrix') || {};
    const vals = ['', 'ok', 'warn', 'ko', 'na'];
    const cur = matrix[key]||'';
    matrix[key] = vals[(vals.indexOf(cur)+1)%vals.length];
    this.save('matrix', matrix);
    this.renderMatrix();
  },

  // ‚îÄ‚îÄ REGISTRE ‚îÄ‚îÄ
  // ‚îÄ‚îÄ REGISTRE ‚Äî √©tat interne s√©lection ‚îÄ‚îÄ
  _regSelected: new Set(),   // cl√©s "centre::idx" des lignes s√©lectionn√©es

  renderRegistre() {
    const wrap        = document.getElementById('registre-table-wrap');
    const centres     = this.centre === 'ALL' ? CENTRES : [this.centre];
    const groupFilter = document.getElementById('reg-groupe-filter')?.value || '';
    const statFilter  = document.getElementById('reg-statut-filter')?.value || '';
    const search      = (document.getElementById('reg-search')?.value || '').toLowerCase();
    const reg         = this.load('registre') || {};

    // Peupler filtre groupe une seule fois
    const filterEl = document.getElementById('reg-groupe-filter');
    if (filterEl && filterEl.options.length <= 1) {
      const groups = [...new Set(CONTROLES_TEMPLATE.map(c => c.groupe))];
      groups.forEach(g => {
        const o = document.createElement('option'); o.value = g; o.textContent = g;
        filterEl.appendChild(o);
      });
      if (groupFilter) filterEl.value = groupFilter;
    }

    // KPIs globaux
    let kTotal=0, kOk=0, kSoon=0, kExp=0, kEmpty=0;
    centres.forEach(c => {
      (reg[c] || []).forEach(r => {
        kTotal++;
        if (!r.prochainControle) kEmpty++;
        else if (this.isExpired(r.prochainControle)) kExp++;
        else if (this.isSoonExpiring(r.prochainControle, 60)) kSoon++;
        else kOk++;
      });
    });
    const kEl = document.getElementById('reg-kpi-strip');
    if (kEl) kEl.innerHTML = `
      <div class="reg-kpi"><div class="reg-kpi-val blue">${kTotal}</div><div class="reg-kpi-label">Total</div></div>
      <div class="reg-kpi"><div class="reg-kpi-val ok">${kOk}</div><div class="reg-kpi-label">Conformes</div></div>
      <div class="reg-kpi"><div class="reg-kpi-val warn">${kSoon}</div><div class="reg-kpi-label">‚â§ 60 jours</div></div>
      <div class="reg-kpi"><div class="reg-kpi-val ko">${kExp}</div><div class="reg-kpi-label">√âchus</div></div>
      <div class="reg-kpi"><div class="reg-kpi-val" style="color:var(--muted)">${kEmpty}</div><div class="reg-kpi-label">Non renseign√©s</div></div>`;

    // Table
    let html = `<table><thead><tr>
      <th style="width:28px"><input type="checkbox" class="reg-select-cb" id="reg-select-all" onchange="App.toggleSelectAll(this.checked)" title="Tout s√©lectionner"></th>
      <th>Cat.</th><th>Groupe</th><th>Libell√©</th><th>P√©riodicit√©</th>
      <th>Dernier contr√¥le</th><th>R√©sultat</th><th>Organisme</th>
      <th>Prochain contr√¥le</th><th>Observations</th><th>√âtat</th>
    </tr></thead><tbody>`;

    centres.forEach(c => {
      let rows = (reg[c] || []);

      // Filtres
      if (groupFilter) rows = rows.filter(r => r.groupe === groupFilter);
      if (statFilter === 'expired') rows = rows.filter(r => this.isExpired(r.prochainControle));
      else if (statFilter === 'soon') rows = rows.filter(r => !this.isExpired(r.prochainControle) && this.isSoonExpiring(r.prochainControle, 60));
      else if (statFilter === 'ok') rows = rows.filter(r => r.prochainControle && !this.isExpired(r.prochainControle) && !this.isSoonExpiring(r.prochainControle, 60));
      else if (statFilter === 'empty') rows = rows.filter(r => !r.prochainControle);
      if (search) rows = rows.filter(r => (r.libelle+r.organisme+r.groupe).toLowerCase().includes(search));

      // Trouver indices r√©els dans reg[c] pour chaque row filtr√©
      const indexedRows = rows.map(r => ({ r, idx: (reg[c]||[]).indexOf(r) }));

      if (centres.length > 1) {
        html += `<tr><td colspan="11" style="background:var(--bg3);font-weight:700;font-size:11px;color:var(--accent);letter-spacing:1px;padding:8px 12px">${c.replace('VILLAGE SPORTIF ','VS ')}</td></tr>`;
      }

      indexedRows.forEach(({ r, idx }) => {
        const key     = c + '::' + idx;
        const expired = this.isExpired(r.prochainControle);
        const soon    = this.isSoonExpiring(r.prochainControle, 60);
        const sel     = this._regSelected.has(key);
        const rowClass= sel ? 'row-selected' : expired ? 'row-expired' : soon ? 'row-soon' : '';

        // Calcul jours restants
        let daysLabel = '';
        if (r.prochainControle) {
          const d = Math.round((new Date(r.prochainControle) - new Date()) / 86400000);
          if (d < 0) daysLabel = `<span class="pill pill-ko" style="font-size:9px">√âCHU ${Math.abs(d)}j</span>`;
          else if (d <= 60) daysLabel = `<span class="pill pill-warn" style="font-size:9px">${d}j</span>`;
          else daysLabel = `<span class="pill pill-ok" style="font-size:9px">${d}j</span>`;
        }

        html += `<tr class="${rowClass}" id="reg-row-${key.replace('::','_')}">
          <td><input type="checkbox" class="reg-select-cb" data-key="${key}" onchange="App.toggleRowSelect('${key}',this.checked)" ${sel?'checked':''}></td>
          <td style="font-family:'DM Mono';font-size:10px;color:var(--muted)">${r.catId}</td>
          <td style="font-size:11px;color:var(--muted);white-space:nowrap">${r.groupe}</td>
          <td style="font-size:12px;font-weight:500">${r.libelle}</td>
          <td>${r.periodicite?`<span class="pill pill-na" style="font-size:10px">${r.periodicite}</span>`:'‚Äî'}</td>
          <td><input class="editable-cell" type="date" value="${r.dateRealisation||''}"
            onchange="App.updateRegistreField('${c}',${idx},'dateRealisation',this.value)" style="width:126px"></td>
          <td>
            <select class="editable-cell" style="width:120px" onchange="App.updateRegistreField('${c}',${idx},'resultat',this.value)">
              <option value="">‚Äî</option>
              <option value="Favorable" ${r.resultat==='Favorable'?'selected':''}>‚úì Favorable</option>
              <option value="R√©serves"  ${r.resultat==='R√©serves'?'selected':''}>~ R√©serves</option>
              <option value="D√©favorable" ${r.resultat==='D√©favorable'?'selected':''}>‚úó D√©favorable</option>
              <option value="Non concern√©" ${r.resultat==='Non concern√©'?'selected':''}>‚óã N/C</option>
            </select>
          </td>
          <td><input class="editable-cell" type="text" value="${r.organisme||''}" placeholder="Organisme"
            onchange="App.updateRegistreField('${c}',${idx},'organisme',this.value)" style="width:110px"></td>
          <td style="color:${expired?'var(--red)':soon?'var(--amber)':'var(--text)'}">
            <input class="editable-cell" type="date" value="${r.prochainControle||''}"
            onchange="App.updateRegistreField('${c}',${idx},'prochainControle',this.value)" style="width:126px;color:inherit"></td>
          <td><input class="editable-cell" type="text" value="${r.observations||''}" placeholder="Observations"
            onchange="App.updateRegistreField('${c}',${idx},'observations',this.value)" style="width:140px"></td>
          <td style="white-space:nowrap">${daysLabel}</td>
        </tr>`;
      });
    });
    html += '</tbody></table>';
    wrap.innerHTML = html;
    this._updateBulkBar();
  },

  updateRegistreField(centre, idx, field, val) {
    const reg = this.load('registre') || {};
    if (reg[centre] && reg[centre][idx]) {
      reg[centre][idx][field] = val;
      this.save('registre', reg);
      this.renderAll();
    }
  },

  addRegistreRow() {
    if (this.centre === 'ALL') { alert('S√©lectionnez un centre pour ajouter une ligne.'); return; }
    const reg = this.load('registre') || {};
    if (!reg[this.centre]) reg[this.centre] = [];
    reg[this.centre].push({catId:'‚Äî', groupe:'Divers', libelle:'Nouveau contr√¥le', periodicite:'', dateRealisation:'', resultat:'', organisme:'', prochainControle:'', observations:''});
    this.save('registre', reg);
    this.renderRegistre();
  },

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // S√âLECTION DE LIGNES
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  toggleRowSelect(key, checked) {
    if (checked) this._regSelected.add(key);
    else this._regSelected.delete(key);
    this._updateBulkBar();
  },

  toggleSelectAll(checked) {
    document.querySelectorAll('.reg-select-cb[data-key]').forEach(cb => {
      cb.checked = checked;
      this.toggleRowSelect(cb.dataset.key, checked);
    });
  },

  selectAllRows()  { this.toggleSelectAll(true); },
  clearSelection() { this._regSelected.clear(); this.renderRegistre(); },

  _updateBulkBar() {
    const bar = document.getElementById('reg-bulk-bar');
    if (!bar) return;
    const n = this._regSelected.size;
    bar.style.display = n > 0 ? 'flex' : 'none';
    const ct = document.getElementById('reg-sel-count');
    if (ct) ct.textContent = `${n} ligne${n>1?'s':''} s√©lectionn√©e${n>1?'s':''}`;
  },

  // Actions group√©es sur la s√©lection
  bulkSetResult(resultat) {
    if (!this._regSelected.size) return;
    const reg = this.load('registre') || {};
    this._regSelected.forEach(key => {
      const [centre, idx] = key.split('::');
      if (reg[centre] && reg[centre][+idx]) reg[centre][+idx].resultat = resultat;
    });
    this.save('registre', reg);
    this.renderRegistre();
    this.renderAll();
  },

  bulkSetDate() {
    const date = prompt('Entrez la date du dernier contr√¥le (AAAA-MM-JJ) :');
    if (!date) return;
    const reg = this.load('registre') || {};
    this._regSelected.forEach(key => {
      const [centre, idx] = key.split('::');
      if (reg[centre] && reg[centre][+idx]) reg[centre][+idx].dateRealisation = date;
    });
    this.save('registre', reg);
    this.renderRegistre();
    this.renderAll();
  },

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // SAISIE DE MASSE ‚Äî modal multi-centres
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  openBulkModal() {
    const groups = [...new Set(CONTROLES_TEMPLATE.map(c => c.groupe))];
    App.openModal('‚úèÔ∏è Saisie de masse ‚Äî Mise √† jour multi-centres', `
      <div style="font-size:12px;color:var(--muted2);margin-bottom:14px">
        Mettez √† jour un ou plusieurs contr√¥les sur plusieurs centres en une seule op√©ration.
      </div>

      <div class="bulk-panel">
        <div class="bulk-panel-title">1. S√©lectionner les centres concern√©s</div>
        <div style="margin-bottom:8px;display:flex;gap:6px">
          <button class="btn btn-ghost btn-sm" onclick="App._bulkSelectAll(true)">Tout s√©lectionner</button>
          <button class="btn btn-ghost btn-sm" onclick="App._bulkSelectAll(false)">Tout d√©cocher</button>
        </div>
        <div class="bulk-centre-list">
          ${CENTRES.map(c => `
            <div class="bulk-centre-item" id="bci-${c.replace(/\s/g,'_')}" onclick="App._bulkToggleCentre('${c.replace(/'/g,"\\'")}',this)">
              <input type="checkbox" class="bulk-cb" data-centre="${c}" onchange="App._bulkCbChange(this)">
              <span>${c.replace('VILLAGE SPORTIF ','VS ').replace('CENTRE AQUATIQUE ','CA ').replace('CENTRE NAUTIQUE ','CN ')}</span>
            </div>`).join('')}
        </div>
      </div>

      <div class="bulk-panel">
        <div class="bulk-panel-title">2. S√©lectionner le contr√¥le √† mettre √† jour</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Groupe</label>
            <select id="bulk-groupe" onchange="App._bulkUpdateControle()">
              <option value="">‚Äî Tous les groupes ‚Äî</option>
              ${groups.map(g=>`<option value="${g}">${g}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label>Contr√¥le</label>
            <select id="bulk-controle">
              <option value="">‚Äî Choisir le contr√¥le ‚Äî</option>
              ${CONTROLES_TEMPLATE.map(t=>`<option value="${t.catId}">[${t.catId}] ${t.libelle}</option>`).join('')}
            </select>
          </div>
        </div>
      </div>

      <div class="bulk-panel">
        <div class="bulk-panel-title">3. Valeurs √† appliquer</div>
        <div class="bulk-fields-grid">
          <div class="form-group">
            <label>Date du dernier contr√¥le</label>
            <input type="date" id="bulk-date" value="${this.today()}">
          </div>
          <div class="form-group">
            <label>R√©sultat</label>
            <select id="bulk-resultat">
              <option value="">‚Äî Inchang√© ‚Äî</option>
              <option value="Favorable">‚úì Favorable</option>
              <option value="R√©serves">~ R√©serves</option>
              <option value="D√©favorable">‚úó D√©favorable</option>
              <option value="Non concern√©">‚óã Non concern√©</option>
            </select>
          </div>
          <div class="form-group">
            <label>Organisme intervenant</label>
            <input type="text" id="bulk-organisme" placeholder="Bureau de contr√¥le‚Ä¶">
          </div>
          <div class="form-group">
            <label>Prochain contr√¥le</label>
            <input type="date" id="bulk-next">
          </div>
          <div class="form-group" style="grid-column:span 2">
            <label>Observations</label>
            <input type="text" id="bulk-obs" placeholder="Observations communes √† tous les centres s√©lectionn√©s‚Ä¶">
          </div>
        </div>
      </div>

      <div id="bulk-progress" style="display:none">
        <div class="bulk-progress-bar"><div class="bulk-progress-fill" id="bulk-progress-fill" style="width:0%"></div></div>
        <div id="bulk-progress-text" style="font-size:11px;color:var(--muted);margin-top:4px;text-align:center"></div>
      </div>`, 'bulk_masse');

    document.getElementById('modal-save').textContent = '‚úÖ Appliquer sur tous les centres s√©lectionn√©s';
  },

  _bulkSelectAll(checked) {
    document.querySelectorAll('.bulk-cb').forEach(cb => {
      cb.checked = checked;
      const item = cb.closest('.bulk-centre-item');
      if (item) item.classList.toggle('selected', checked);
    });
  },

  _bulkToggleCentre(centre, itemEl) {
    itemEl.classList.toggle('selected');
    const cb = itemEl.querySelector('.bulk-cb');
    if (cb) cb.checked = itemEl.classList.contains('selected');
  },

  _bulkCbChange(cb) {
    const item = cb.closest('.bulk-centre-item');
    if (item) item.classList.toggle('selected', cb.checked);
  },

  _bulkUpdateControle() {
    const groupe = document.getElementById('bulk-groupe')?.value;
    const sel    = document.getElementById('bulk-controle');
    if (!sel) return;
    const filtered = groupe
      ? CONTROLES_TEMPLATE.filter(t => t.groupe === groupe)
      : CONTROLES_TEMPLATE;
    sel.innerHTML = '<option value="">‚Äî Choisir le contr√¥le ‚Äî</option>' +
      filtered.map(t => `<option value="${t.catId}">[${t.catId}] ${t.libelle}</option>`).join('');
  },

  _applyBulkMasse() {
    const catId    = document.getElementById('bulk-controle')?.value;
    const date     = document.getElementById('bulk-date')?.value     || '';
    const resultat = document.getElementById('bulk-resultat')?.value || '';
    const orgName  = document.getElementById('bulk-organisme')?.value || '';
    const next     = document.getElementById('bulk-next')?.value     || '';
    const obs      = document.getElementById('bulk-obs')?.value      || '';

    if (!catId) { alert('S√©lectionnez un contr√¥le √† mettre √† jour.'); return false; }

    const selected = [...document.querySelectorAll('.bulk-cb:checked')].map(cb => cb.dataset.centre);
    if (!selected.length) { alert('S√©lectionnez au moins un centre.'); return false; }

    const reg = this.load('registre') || {};
    let updated = 0;

    // Barre de progression
    const prog = document.getElementById('bulk-progress');
    const fill = document.getElementById('bulk-progress-fill');
    const txt  = document.getElementById('bulk-progress-text');
    if (prog) prog.style.display = '';

    selected.forEach((c, i) => {
      if (!reg[c]) return;
      const idx = reg[c].findIndex(r => r.catId === catId);
      if (idx === -1) return;
      if (date)     reg[c][idx].dateRealisation  = date;
      if (resultat) reg[c][idx].resultat         = resultat;
      if (orgName)  reg[c][idx].organisme        = orgName;
      if (next)     reg[c][idx].prochainControle = next;
      if (obs)      reg[c][idx].observations     = obs;
      updated++;
      if (fill) fill.style.width = Math.round((i+1)/selected.length*100) + '%';
      if (txt)  txt.textContent  = `${i+1}/${selected.length} centres mis √† jour‚Ä¶`;
    });

    this.save('registre', reg);
    this.renderRegistre();
    this.renderAll();

    const label = CONTROLES_TEMPLATE.find(t=>t.catId===catId)?.libelle || catId;
    alert(`‚úÖ Mise √† jour effectu√©e sur ${updated} centre(s) :\n¬´ ${label} ¬ª`);
    this.closeModal();
    return true;
  },

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // RAPPELS E-MAIL
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  openReminderPanel() {
    const panel = document.getElementById('reg-reminder-panel');
    if (!panel) return;
    panel.style.display = panel.style.display === 'none' ? '' : 'none';
    if (panel.style.display !== 'none') this.renderReminders();
  },

  closeReminderPanel() {
    const panel = document.getElementById('reg-reminder-panel');
    if (panel) panel.style.display = 'none';
  },

  renderReminders() {
    const listEl   = document.getElementById('remind-list');
    if (!listEl) return;
    const delayEl  = document.getElementById('remind-delay');
    const delay    = parseInt(delayEl?.value || '60');
    const centres  = this.centre === 'ALL' ? CENTRES : [this.centre];
    const reg      = this.load('registre') || {};

    // Collecter tous les contr√¥les concern√©s
    const alerts = [];
    centres.forEach(c => {
      (reg[c] || []).forEach(r => {
        if (!r.prochainControle) return;
        const days = Math.round((new Date(r.prochainControle) - new Date()) / 86400000);
        const isExp  = days < 0;
        const isSoon = !isExp && days <= delay;
        if (!isExp && !isSoon) return;
        alerts.push({ centre: c, row: r, days, isExp });
      });
    });

    // Trier : √©chus en premier, puis par urgence
    alerts.sort((a,b) => a.days - b.days);

    if (!alerts.length) {
      listEl.innerHTML = '<div class="empty-state"><div class="icon">‚úÖ</div><div>Aucun contr√¥le √©chu ou √† √©ch√©ance dans le d√©lai s√©lectionn√©</div></div>';
      return;
    }

    listEl.innerHTML = alerts.map(({ centre, row, days, isExp }) => {
      const nom   = centre.replace('VILLAGE SPORTIF ','').replace('CENTRE AQUATIQUE ','CA ').replace('CENTRE NAUTIQUE ','CN ');
      const label = days < 0 ? `√âCHU depuis ${Math.abs(days)} jour(s)` : `Dans ${days} jour(s)`;
      const cls   = isExp ? 'urgent' : 'soon';
      return `<div class="remind-item ${cls}">
        <div class="remind-info">
          <div class="remind-title">[${row.catId}] ${row.libelle}</div>
          <div class="remind-meta">${nom} ¬∑ Prochain : ${this.fmtDate(row.prochainControle)} ¬∑ Org. : ${row.organisme||'Non renseign√©'}</div>
        </div>
        <span class="remind-days ${isExp?'urgent':'soon'}">${label}</span>
        <button class="btn btn-ghost btn-sm" onclick="App.sendOneReminder('${centre.replace(/'/g,"\\'")}','${row.catId}')" title="Envoyer e-mail de rappel">üìß</button>
      </div>`;
    }).join('');
  },

  sendOneReminder(centre, catId) {
    const reg  = this.load('registre') || {};
    const row  = (reg[centre]||[]).find(r => r.catId === catId);
    if (!row) return;
    const to   = document.getElementById('remind-to')?.value || '';
    const nom  = centre.replace('VILLAGE SPORTIF ','');
    const days = Math.round((new Date(row.prochainControle) - new Date()) / 86400000);
    const sujet = encodeURIComponent(`[UCPA] Rappel contr√¥le r√©glementaire ‚Äî ${row.libelle} ‚Äî ${nom}`);
    const corps = encodeURIComponent(
      `Bonjour,\n\nCe message est un rappel automatique g√©n√©r√© depuis l'ERP UCPA.\n\n` +
      `CENTRE : ${nom}\n` +
      `CONTR√îLE : [${catId}] ${row.libelle}\n` +
      `GROUPE : ${row.groupe}\n` +
      `P√âRIODICIT√â : ${row.periodicite || 'Non d√©finie'}\n` +
      `PROCHAIN CONTR√îLE : ${this.fmtDate(row.prochainControle)} (${days < 0 ? '√âCHU depuis '+Math.abs(days)+' jour(s)' : 'dans '+days+' jour(s)'})\n` +
      `ORGANISME HABITUEL : ${row.organisme || 'Non renseign√©'}\n` +
      `R√âSULTAT DERNIER CONTR√îLE : ${row.resultat || '‚Äî'}\n\n` +
      `Merci de prendre les dispositions n√©cessaires pour planifier cette v√©rification.\n\nCordialement,\nERP UCPA ‚Äî Module Registre de S√©curit√©`
    );
    window.open(`mailto:${to}?subject=${sujet}&body=${corps}`);
  },

  sendAllReminders() {
    const listEl = document.getElementById('remind-list');
    if (!listEl) return;
    const btns = listEl.querySelectorAll('.remind-item');
    if (!btns.length) { alert('Aucun rappel √† envoyer.'); return; }
    const to   = document.getElementById('remind-to')?.value || '';
    const delay = parseInt(document.getElementById('remind-delay')?.value || '60');
    const centres = this.centre === 'ALL' ? CENTRES : [this.centre];
    const reg  = this.load('registre') || {};

    // Construire un e-mail group√©
    let body = 'Bonjour,\n\nVoici le r√©capitulatif des contr√¥les r√©glementaires √† planifier :\n\n';
    let count = 0;
    centres.forEach(c => {
      const nom = c.replace('VILLAGE SPORTIF ','');
      (reg[c]||[]).forEach(r => {
        if (!r.prochainControle) return;
        const d = Math.round((new Date(r.prochainControle) - new Date()) / 86400000);
        if (d > delay) return;
        const status = d < 0 ? `‚ö† √âCHU DEPUIS ${Math.abs(d)}j` : `‚Üí Dans ${d} jour(s)`;
        body += `‚Ä¢ [${r.catId}] ${r.libelle} ‚Äî ${nom} ‚Äî ${this.fmtDate(r.prochainControle)} ‚Äî ${status}\n`;
        count++;
      });
    });
    if (!count) { alert('Aucun contr√¥le dans le d√©lai s√©lectionn√©.'); return; }
    body += `\nTotal : ${count} contr√¥le(s) concern√©(s).\n\nCordialement,\nERP UCPA ‚Äî Module Registre de S√©curit√©`;

    const sujet = encodeURIComponent(`[UCPA] Rappels contr√¥les r√©glementaires ‚Äî ${count} contr√¥le(s) √† planifier`);
    window.open(`mailto:${to}?subject=${sujet}&body=${encodeURIComponent(body)}`);
  },

  // ‚îÄ‚îÄ GENERIC LIST RENDER ‚îÄ‚îÄ
  renderList(key, elId, renderFn) {
    const items = this.load(key) || [];
    const filtered = this.centre==='ALL' ? items : items.filter(i => !i.centre || i.centre===this.centre);
    const el = document.getElementById(elId);
    if (filtered.length === 0) {
      el.innerHTML = '<div class="empty-state"><div class="icon">üìÇ</div><div>Aucun √©l√©ment</div></div>';
    } else {
      el.innerHTML = '<table><thead><tr>' + renderFn(null, true) + '</tr></thead><tbody>' +
        filtered.map((item, i) => renderFn(item, false, i)).join('') + '</tbody></table>';
    }
  },

  renderObsItem(item, header, i) {
    if (header) return '<th>Date</th><th>Centre</th><th>Cat√©gorie</th><th>Description</th><th>Statut</th><th></th>';
    return `<tr>
      <td style="font-family:'DM Mono';font-size:11px">${this.fmtDate(item.date)}</td>
      <td style="font-size:11px;color:var(--muted)">${item.centre||'‚Äî'}</td>
      <td>${item.categorie||'‚Äî'}</td>
      <td>${item.description||'‚Äî'}</td>
      <td><span class="pill pill-${item.statut==='Cl√¥tur√©'?'ok':item.statut==='En cours'?'warn':'ko'}">${item.statut||'Ouvert'}</span></td>
      <td><button class="btn btn-ghost btn-sm" onclick="App.deleteItem('observations',${i})">üóë</button></td>
    </tr>`;
  },
  renderVeilleItem(item, header, i) {
    if (header) return '<th>Date</th><th>R√©f√©rence</th><th>Objet</th><th>Impact</th><th></th>';
    return `<tr>
      <td style="font-family:'DM Mono';font-size:11px">${this.fmtDate(item.date)}</td>
      <td style="color:var(--accent)">${item.reference||'‚Äî'}</td>
      <td>${item.objet||'‚Äî'}</td>
      <td><span class="pill pill-${item.impact==='Majeur'?'ko':item.impact==='Mineur'?'warn':'na'}">${item.impact||'‚Äî'}</span></td>
      <td><button class="btn btn-ghost btn-sm" onclick="App.deleteItem('veille',${i})">üóë</button></td>
    </tr>`;
  },
  renderMaintItem(item, header, i) {
    if (header) return '<th>Date</th><th>Centre</th><th>√âquipement</th><th>Description</th><th>Priorit√©</th><th>Statut</th><th></th>';
    return `<tr>
      <td style="font-family:'DM Mono';font-size:11px">${this.fmtDate(item.date)}</td>
      <td style="font-size:11px;color:var(--muted)">${item.centre||'‚Äî'}</td>
      <td>${item.equipement||'‚Äî'}</td>
      <td>${item.description||'‚Äî'}</td>
      <td><span class="pill pill-${item.priorite==='Urgente'?'ko':item.priorite==='Haute'?'warn':'na'}">${item.priorite||'‚Äî'}</span></td>
      <td><span class="pill pill-${item.statut==='Cl√¥tur√©'?'ok':'warn'}">${item.statut||'Ouvert'}</span></td>
      <td><button class="btn btn-ghost btn-sm" onclick="App.deleteItem('maintenance',${i})">üóë</button></td>
    </tr>`;
  },
  renderRondeItem(item, header, i) {
    if (header) return '<th>Date</th><th>Centre</th><th>Type</th><th>Agent</th><th>Observations</th><th></th>';
    return `<tr>
      <td style="font-family:'DM Mono';font-size:11px">${this.fmtDate(item.date)}</td>
      <td style="font-size:11px;color:var(--muted)">${item.centre||'‚Äî'}</td>
      <td>${item.type||'‚Äî'}</td>
      <td>${item.agent||'‚Äî'}</td>
      <td>${item.observations||'‚Äî'}</td>
      <td><button class="btn btn-ghost btn-sm" onclick="App.deleteItem('rondes',${i})">üóë</button></td>
    </tr>`;
  },
  renderContratItem(item, header, i) {
    if (header) return '<th>Prestataire</th><th>Objet</th><th>Centre</th><th>D√©but</th><th>Fin</th><th>Statut</th><th></th>';
    const expired = this.isExpired(item.fin);
    const soon = this.isSoonExpiring(item.fin, 90);
    return `<tr>
      <td style="font-weight:600">${item.prestataire||'‚Äî'}</td>
      <td>${item.objet||'‚Äî'}</td>
      <td style="font-size:11px;color:var(--muted)">${item.centre||'‚Äî'}</td>
      <td style="font-family:'DM Mono';font-size:11px">${this.fmtDate(item.debut)}</td>
      <td style="font-family:'DM Mono';font-size:11px;color:${expired?'var(--red)':soon?'var(--amber)':'var(--text)'}">${this.fmtDate(item.fin)}</td>
      <td><span class="pill pill-${expired?'ko':soon?'warn':'ok'}">${expired?'√âchu':soon?'Bient√¥t':'Actif'}</span></td>
      <td><button class="btn btn-ghost btn-sm" onclick="App.deleteItem('contrats',${i})">üóë</button></td>
    </tr>`;
  },
  renderTacheItem(item, header, i) {
    if (header) return '<th>Titre</th><th>Centre</th><th>Priorit√©</th><th>√âch√©ance</th><th>Statut</th><th></th>';
    const expired = this.isExpired(item.echeance);
    return `<tr>
      <td>${item.titre||'‚Äî'}</td>
      <td style="font-size:11px;color:var(--muted)">${item.centre||'‚Äî'}</td>
      <td><span class="pill pill-${item.priorite==='Urgente'?'ko':item.priorite==='Haute'?'warn':'na'}">${item.priorite||'‚Äî'}</span></td>
      <td style="font-family:'DM Mono',monospace;font-size:11px;color:${expired?'var(--red)':'var(--text)'}">${this.fmtDate(item.echeance)}</td>
      <td><span class="pill pill-${item.statut==='Termin√©'?'ok':'warn'}">${item.statut||'En cours'}</span></td>
      <td><button class="btn btn-ghost btn-sm" onclick="App.deleteItem('taches',${i})">üóë</button></td>
    </tr>`;
  },

  deleteItem(key, idx) {
    if (!confirm('Supprimer cet √©l√©ment ?')) return;
    const arr = this.load(key) || [];
    arr.splice(idx, 1);
    this.save(key, arr);
    this.renderPage(this.page);
    this.renderAll();
  },

  // ‚îÄ‚îÄ PMR ‚îÄ‚îÄ
  renderPMRGrid() {
    // Compatibilit√© descendante ‚Äî non utilis√© dans le nouveau PMR
  },

  // ‚îÄ‚îÄ RENDER PMR d√©taill√© ‚îÄ‚îÄ
  _pmrStatusOpts(val) {
    return `
      <option value="" ${!val?'selected':''}>‚Äî √Ä √©valuer</option>
      <option value="ok" ${val==='ok'?'selected':''}>‚úÖ Conforme</option>
      <option value="partial" ${val==='partial'?'selected':''}>‚ö†Ô∏è Partiel</option>
      <option value="ko" ${val==='ko'?'selected':''}>‚ùå Non conforme</option>
      <option value="na" ${val==='na'?'selected':''}>N/A</option>`;
  },

  renderPMRDetail() {
    const body = document.getElementById('pmr-detail-body');
    if (!body) return;
    const pmr = this.load('pmr') || {};
    const c   = this.centre === 'ALL' ? CENTRES[0] : this.centre;
    const d   = pmr[c] || {};

    body.innerHTML = PMR_SECTIONS.map(section => `
      <div class="pmr-section">
        <div class="pmr-section-title">
          <span>${section.icon}</span> ${section.label}
          <span class="stbadge">${section.ref}</span>
        </div>
        ${section.items.map(item => `
          <div class="pmr-item-row">
            <div>
              <div class="pmr-item-label">${item.label}</div>
              <div class="pmr-item-ref">${item.ref}</div>
              ${item.note ? `<div class="pmr-item-note">‚Ñπ ${item.note}</div>` : ''}
            </div>
            <select class="pmr-status-sel" id="pmr-${item.id}" onchange="App.savePMR()">
              ${this._pmrStatusOpts(d['status_'+item.id])}
            </select>
            <input class="pmr-obs-input" type="text" id="pmr-obs-${item.id}"
              placeholder="Observations / actions‚Ä¶"
              value="${(d['obs_'+item.id]||'').replace(/"/g,'&quot;')}"
              onchange="App.savePMR()">
            <input class="pmr-date-input" type="date" id="pmr-ech-${item.id}"
              value="${d['ech_'+item.id]||''}"
              onchange="App.savePMR()" title="√âch√©ance travaux">
          </div>`).join('')}
      </div>`).join('');

    // KPIs
    this._renderPMRKPIs(d);
  },

  _renderPMRKPIs(d) {
    const bar = document.getElementById('pmr-kpi-bar');
    if (!bar) return;
    let total=0, ok=0, partial=0, ko=0;
    PMR_SECTIONS.forEach(s => s.items.forEach(item => {
      total++;
      const v = d['status_'+item.id];
      if (v==='ok') ok++;
      else if (v==='partial') partial++;
      else if (v==='ko') ko++;
    }));
    const pct = total ? Math.round(ok/total*100) : 0;
    bar.innerHTML = `
      <div class="pmr-kpi"><div class="pmr-kpi-val ok">${ok}</div><div class="pmr-kpi-label">Conformes</div></div>
      <div class="pmr-kpi"><div class="pmr-kpi-val warn">${partial}</div><div class="pmr-kpi-label">Partiels</div></div>
      <div class="pmr-kpi"><div class="pmr-kpi-val ko">${ko}</div><div class="pmr-kpi-label">Non conformes</div></div>
      <div class="pmr-kpi"><div class="pmr-kpi-val ${pct>=80?'ok':pct>=50?'warn':'ko'}">${pct}%</div><div class="pmr-kpi-label">Taux conformit√©</div></div>`;
  },

  loadPMR() {
    const pmr = this.load('pmr') || {};
    const c   = this.centre === 'ALL' ? CENTRES[0] : this.centre;
    const d   = pmr[c] || {};

    // Champs globaux
    ['presence','date','attestation','adap','responsable','prochaine-verif'].forEach(f => {
      const el = document.getElementById('pmr-'+f);
      if (el) el.value = d[f] || '';
    });

    // Rendu tableau d√©taill√©
    this.renderPMRDetail();
  },

  savePMR() {
    const pmr = this.load('pmr') || {};
    const c   = this.centre === 'ALL' ? CENTRES[0] : this.centre;
    if (!pmr[c]) pmr[c] = {};

    // Champs globaux
    ['presence','date','attestation','adap','responsable','prochaine-verif'].forEach(f => {
      const el = document.getElementById('pmr-'+f);
      if (el) pmr[c][f] = el.value;
    });

    // Items d√©taill√©s
    PMR_SECTIONS.forEach(s => s.items.forEach(item => {
      const sel = document.getElementById('pmr-'+item.id);
      const obs = document.getElementById('pmr-obs-'+item.id);
      const ech = document.getElementById('pmr-ech-'+item.id);
      if (sel) pmr[c]['status_'+item.id] = sel.value;
      if (obs) pmr[c]['obs_'+item.id]    = obs.value;
      if (ech) pmr[c]['ech_'+item.id]    = ech.value;
    }));

    this.save('pmr', pmr);
    this._renderPMRKPIs(pmr[c]);
  },

  // ‚îÄ‚îÄ PREVENTION ‚îÄ‚îÄ
  renderPrevChecklist() {
    const el = document.getElementById('prev-checklist');
    const prev = this.load('prevention') || {risques:{}};
    el.innerHTML = PREV_RISKS.map((r, i) => `
      <div class="checklist-item">
        <div class="cl-check ${prev.risques[i]?'checked':''}" id="prev-risk-${i}" onclick="App.togglePrevRisk(${i})">${prev.risques[i]?'‚úì':''}</div>
        <span class="cl-label">${r}</span>
        <input class="cl-val" type="text" placeholder="Notes" id="prev-risk-note-${i}" value="${prev.notes&&prev.notes[i]||''}" onchange="App.savePrev()">
      </div>`).join('');
  },

  togglePrevRisk(i) {
    const prev = this.load('prevention') || {risques:{}, notes:{}};
    prev.risques[i] = !prev.risques[i];
    this.save('prevention', prev);
    const el = document.getElementById('prev-risk-'+i);
    el.classList.toggle('checked', !!prev.risques[i]);
    el.textContent = prev.risques[i] ? '‚úì' : '';
  },

  loadPrev() {
    const prev = this.load('prevention') || {};
    ['entreprise','nature','responsable','debut','fin','effectif','signataire'].forEach(f => {
      const el = document.getElementById('prev-'+f);
      if (el) el.value = prev[f] || '';
    });
    this.renderPrevChecklist();
    this.clearSig(); // reset canvas
  },

  savePrev() {
    const prev = this.load('prevention') || {risques:{}, notes:{}};
    ['entreprise','nature','responsable','debut','fin','effectif','signataire'].forEach(f => {
      const el = document.getElementById('prev-'+f);
      if (el) prev[f] = el.value;
    });
    PREV_RISKS.forEach((r, i) => {
      const n = document.getElementById('prev-risk-note-'+i);
      if (!prev.notes) prev.notes = {};
      if (n) prev.notes[i] = n.value;
    });
    this.save('prevention', prev);
  },

  // ‚îÄ‚îÄ PERMIS FEU ‚îÄ‚îÄ
  renderPFChecklist() {
    const el = document.getElementById('pf-checklist');
    const pf = this.load('permisfeu') || {checks:{}};
    el.innerHTML = PF_CHECKS.map((c, i) => `
      <div class="checklist-item">
        <div class="cl-check ${pf.checks[i]?'checked':''}" id="pf-check-${i}" onclick="App.togglePFCheck(${i})">${pf.checks[i]?'‚úì':''}</div>
        <span class="cl-label">${c}</span>
      </div>`).join('');
  },

  togglePFCheck(i) {
    const pf = this.load('permisfeu') || {checks:{}};
    pf.checks[i] = !pf.checks[i];
    this.save('permisfeu', pf);
    const el = document.getElementById('pf-check-'+i);
    el.classList.toggle('checked', !!pf.checks[i]);
    el.textContent = pf.checks[i] ? '‚úì' : '';
  },

  loadPF() {
    const pf = this.load('permisfeu') || {};
    ['num','date','entreprise','local','signataire'].forEach(f => {
      const el = document.getElementById('pf-'+f);
      if (el) el.value = pf[f] || '';
    });
    this.renderPFChecklist();
  },

  savePF() {
    const pf = this.load('permisfeu') || {checks:{}};
    ['num','date','entreprise','local','signataire'].forEach(f => {
      const el = document.getElementById('pf-'+f);
      if (el) pf[f] = el.value;
    });
    this.save('permisfeu', pf);
  },

  // ‚îÄ‚îÄ SANITAIRE ‚îÄ‚îÄ
  renderSanitaire() {
    // Init datetime si vide
    const dt = document.getElementById('ecs-datetime');
    if (dt && !dt.value) dt.value = new Date().toISOString().slice(0,16);
    ECS.renderForm();
    ECS.renderHistory();
    // Purges
    const san = this.load('sanitaire') || {ecs:[], purges:[], releves:[]};
    const purgeEl = document.getElementById('purge-rows');
    if (purgeEl) {
      purgeEl.innerHTML = san.purges.length ? san.purges.map((p,i) => `
        <div class="purge-row">
          <input class="purge-input" type="date" value="${p.date||''}" onchange="App.updateSanitaire('purges',${i},'date',this.value)">
          <input class="purge-input" type="text" placeholder="Circuit" value="${p.circuit||''}" onchange="App.updateSanitaire('purges',${i},'circuit',this.value)">
          <input class="purge-input" type="text" placeholder="Op√©rateur" value="${p.agent||''}" onchange="App.updateSanitaire('purges',${i},'agent',this.value)">
          <button class="btn btn-ghost btn-sm" onclick="App.deletePurgeRow(${i})" style="padding:4px 6px">üóë</button>
        </div>`).join('') : '<div style="color:var(--muted);font-size:12px;padding:4px 0">Aucune purge enregistr√©e</div>';
    }
  },

  addECSRow() { /* Compatibilit√© ‚Äî non utilis√© dans nouveau ECS */ },
  addPurgeRow() { const s=this.load('sanitaire')||{ecs:[],purges:[],releves:[]}; s.purges.push({date:this.today(),circuit:'',agent:''}); this.save('sanitaire',s); this.renderSanitaire(); },
  deleteECSRow(i) { const s=this.load('sanitaire')||{ecs:[],purges:[],releves:[]}; s.ecs.splice(i,1); this.save('sanitaire',s); this.renderSanitaire(); },
  deletePurgeRow(i) { const s=this.load('sanitaire')||{ecs:[],purges:[],releves:[]}; s.purges.splice(i,1); this.save('sanitaire',s); this.renderSanitaire(); },
  updateSanitaire(arr, i, field, val) {
    const s=this.load('sanitaire')||{ecs:[],purges:[],releves:[]};
    if (s[arr] && s[arr][i]) s[arr][i][field]=val;
    this.save('sanitaire',s);
  },

  // ‚îÄ‚îÄ RH ‚îÄ‚îÄ
  renderRH() {
    const rh = this.load('rh') || [];
    const filtered = this.centre==='ALL' ? rh : rh.filter(r => !r.centre || r.centre===this.centre);
    const el = document.getElementById('rh-list');
    if (!filtered.length) {
      el.innerHTML='<div class="empty-state"><div class="icon">üë§</div><div>Aucune habilitation</div></div>';
      return;
    }
    el.innerHTML = `<table><thead><tr><th>Nom</th><th>Poste</th><th>Centre</th><th>Habilitation</th><th>Date obtention</th><th>Expiration</th><th>Statut</th><th></th></tr></thead><tbody>
      ${filtered.map((r,i) => {
        const exp = this.isExpired(r.expiration);
        const soon = this.isSoonExpiring(r.expiration, 30);
        return `<tr>
          <td style="font-weight:600">${r.nom||'‚Äî'}</td>
          <td>${r.poste||'‚Äî'}</td>
          <td style="font-size:11px;color:var(--muted)">${r.centre||'‚Äî'}</td>
          <td style="color:var(--accent)">${r.habilitation||'‚Äî'}</td>
          <td style="font-family:'DM Mono';font-size:11px">${this.fmtDate(r.dateObtention)}</td>
          <td style="font-family:'DM Mono';font-size:11px;color:${exp?'var(--red)':soon?'var(--amber)':'var(--text)'}">${this.fmtDate(r.expiration)}</td>
          <td><span class="pill pill-${exp?'ko':soon?'warn':'ok'}">${exp?'√âchu':soon?'Bient√¥t':'Valide'}</span></td>
          <td><button class="btn btn-ghost btn-sm" onclick="App.deleteItem('rh',${i})">üóë</button></td>
        </tr>`;
      }).join('')}
    </tbody></table>`;
  },

  // ‚îÄ‚îÄ CHECKLISTS METIER ‚îÄ‚îÄ
  showChecklist(type) {
    const def = CHECKLIST_DEFS[type];
    if (!def) return;
    const cl = this.load('checklists') || {};
    const c = this.centre==='ALL' ? 'ALL' : this.centre;
    const key = `${c}::${type}`;
    if (!cl[key]) cl[key] = {};
    const panel = document.getElementById('checklist-panel');
    panel.innerHTML = `<div class="card">
      <div class="card-hdr">
        <span>‚úì</span><h3>${def.label}</h3>
        <div class="ml flex" style="gap:8px">
          <button class="btn btn-secondary btn-sm" onclick="App.exportChecklistPDF('${type}')">üìÑ Export PDF</button>
        </div>
      </div>
      <div class="card-body">
        ${def.items.map((item, i) => `
          <div class="checklist-item">
            <div class="cl-check ${cl[key][i]?'checked':''}" id="cl-${type}-${i}" onclick="App.toggleChecklist('${type}',${i})">${cl[key][i]?'‚úì':''}</div>
            <span class="cl-label">${item}</span>
            <input class="cl-val" type="text" placeholder="Valeur / commentaire" 
              value="${cl[key]['v_'+i]||''}"
              onchange="App.saveChecklistVal('${type}',${i},this.value)">
          </div>`).join('')}
      </div>
    </div>`;
  },

  toggleChecklist(type, i) {
    const cl = this.load('checklists') || {};
    const c = this.centre==='ALL' ? 'ALL' : this.centre;
    const key = `${c}::${type}`;
    if (!cl[key]) cl[key] = {};
    cl[key][i] = !cl[key][i];
    this.save('checklists', cl);
    const el = document.getElementById(`cl-${type}-${i}`);
    if (el) { el.classList.toggle('checked',!!cl[key][i]); el.textContent=cl[key][i]?'‚úì':''; }
  },

  saveChecklistVal(type, i, val) {
    const cl = this.load('checklists') || {};
    const c = this.centre==='ALL' ? 'ALL' : this.centre;
    const key = `${c}::${type}`;
    if (!cl[key]) cl[key] = {};
    cl[key]['v_'+i] = val;
    this.save('checklists', cl);
  },

  // ‚îÄ‚îÄ SIGNATURE ‚îÄ‚îÄ
  initSig() {
    const canvas = document.getElementById('sig-canvas');
    if (!canvas) return;
    this.sigCanvas = canvas;
    this.sigCtx = canvas.getContext('2d');
    this.sigCtx.strokeStyle = '#000';
    this.sigCtx.lineWidth = 2;
    this.sigCtx.lineCap = 'round';
    const draw = (e, type) => {
      const rect = canvas.getBoundingClientRect();
      const x = (e.touches?e.touches[0].clientX:e.clientX)-rect.left;
      const y = (e.touches?e.touches[0].clientY:e.clientY)-rect.top;
      if (type==='start') { this.sigDrawing=true; this.sigCtx.beginPath(); this.sigCtx.moveTo(x,y); document.getElementById('sig-ts').textContent='Sign√© le '+new Date().toLocaleString('fr-FR'); }
      else if (type==='move' && this.sigDrawing) { this.sigCtx.lineTo(x,y); this.sigCtx.stroke(); }
      else this.sigDrawing=false;
    };
    canvas.addEventListener('mousedown',e=>draw(e,'start'));
    canvas.addEventListener('mousemove',e=>draw(e,'move'));
    canvas.addEventListener('mouseup',e=>draw(e,'end'));
    canvas.addEventListener('touchstart',e=>{e.preventDefault();draw(e,'start')},{passive:false});
    canvas.addEventListener('touchmove',e=>{e.preventDefault();draw(e,'move')},{passive:false});
    canvas.addEventListener('touchend',e=>draw(e,'end'));
  },
  clearSig() { if(this.sigCtx) { this.sigCtx.clearRect(0,0,500,120); document.getElementById('sig-ts').textContent=''; } },

  initSigPF() {
    const canvas = document.getElementById('sig-canvas-pf');
    if (!canvas) return;
    this.sigCanvasPF = canvas;
    this.sigCtxPF = canvas.getContext('2d');
    this.sigCtxPF.strokeStyle = '#000';
    this.sigCtxPF.lineWidth = 2;
    this.sigCtxPF.lineCap = 'round';
    const draw = (e, type) => {
      const rect = canvas.getBoundingClientRect();
      const x = (e.touches?e.touches[0].clientX:e.clientX)-rect.left;
      const y = (e.touches?e.touches[0].clientY:e.clientY)-rect.top;
      if (type==='start') { this.sigDrawingPF=true; this.sigCtxPF.beginPath(); this.sigCtxPF.moveTo(x,y); }
      else if (type==='move' && this.sigDrawingPF) { this.sigCtxPF.lineTo(x,y); this.sigCtxPF.stroke(); }
      else this.sigDrawingPF=false;
    };
    canvas.addEventListener('mousedown',e=>draw(e,'start'));
    canvas.addEventListener('mousemove',e=>draw(e,'move'));
    canvas.addEventListener('mouseup',e=>draw(e,'end'));
    canvas.addEventListener('touchstart',e=>{e.preventDefault();draw(e,'start')},{passive:false});
    canvas.addEventListener('touchmove',e=>{e.preventDefault();draw(e,'move')},{passive:false});
    canvas.addEventListener('touchend',e=>draw(e,'end'));
  },
  clearSigPF() { if(this.sigCtxPF) this.sigCtxPF.clearRect(0,0,500,100); },

  // ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ
  openModal(title, bodyHTML, type) {
    this.modalType = type;
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-body').innerHTML = bodyHTML;
    document.getElementById('modal-overlay').classList.add('open');
  },
  closeModal(e) {
    if (e && e.target !== document.getElementById('modal-overlay')) return;
    document.getElementById('modal-overlay').classList.remove('open');
    this.modalType = null;
  },
  saveModal() {
    const handlers = {
      obs: () => {
        const items = this.load('observations') || [];
        items.unshift({
          id: this.uuid(), date: this.today(),
          centre: document.getElementById('m-centre').value,
          categorie: document.getElementById('m-categorie').value,
          description: document.getElementById('m-description').value,
          statut: document.getElementById('m-statut').value
        });
        this.save('observations', items);
        this.renderPage('observations');
      },
      veille: () => {
        const items = this.load('veille') || [];
        items.unshift({
          id: this.uuid(), date: this.today(),
          reference: document.getElementById('m-reference').value,
          objet: document.getElementById('m-objet').value,
          impact: document.getElementById('m-impact').value
        });
        this.save('veille', items);
        this.renderPage('veille');
      },
      maint: () => {
        const items = this.load('maintenance') || [];
        items.unshift({
          id: this.uuid(), date: this.today(),
          centre: document.getElementById('m-centre').value,
          equipement: document.getElementById('m-equipement').value,
          description: document.getElementById('m-description').value,
          priorite: document.getElementById('m-priorite').value,
          statut: 'Ouvert'
        });
        this.save('maintenance', items);
        this.renderPage('maintenance');
        this.renderAll();
      },
      ronde: () => {
        const items = this.load('rondes') || [];
        items.unshift({
          id: this.uuid(), date: this.today(),
          centre: document.getElementById('m-centre').value,
          type: document.getElementById('m-type').value,
          agent: document.getElementById('m-agent').value,
          observations: document.getElementById('m-observations').value
        });
        this.save('rondes', items);
        this.renderPage('rondes');
      },
      rh: () => {
        const items = this.load('rh') || [];
        items.unshift({
          id: this.uuid(),
          centre: document.getElementById('m-centre').value,
          nom: document.getElementById('m-nom').value,
          poste: document.getElementById('m-poste').value,
          habilitation: document.getElementById('m-habilitation').value,
          dateObtention: document.getElementById('m-dateObtention').value,
          expiration: document.getElementById('m-expiration').value
        });
        this.save('rh', items);
        this.renderRH();
        this.renderAll();
      },
      contrat: () => {
        const items = this.load('contrats') || [];
        items.unshift({
          id: this.uuid(),
          centre: document.getElementById('m-centre').value,
          prestataire: document.getElementById('m-prestataire').value,
          objet: document.getElementById('m-objet').value,
          debut: document.getElementById('m-debut').value,
          fin: document.getElementById('m-fin').value
        });
        this.save('contrats', items);
        this.renderList('contrats', 'contrats-list', this.renderContratItem.bind(this));
        this.renderAll();
      },
      tache: () => {
        const items = this.load('taches') || [];
        items.unshift({
          id: this.uuid(),
          centre: document.getElementById('m-centre').value,
          titre: document.getElementById('m-titre').value,
          priorite: document.getElementById('m-priorite').value,
          echeance: document.getElementById('m-echeance').value,
          statut: 'En cours'
        });
        this.save('taches', items);
        this.renderList('taches', 'taches-list', this.renderTacheItem.bind(this));
      },
      investissement: () => {
        const items = this.load('investissements') || [];
        items.unshift({
          id: this.uuid(),
          annee: document.getElementById('m-annee').value,
          centre: document.getElementById('m-centre').value,
          categorie: document.getElementById('m-categorie').value,
          typeInv: document.getElementById('m-typeinv').value,
          description: document.getElementById('m-description').value,
          coutEstime: parseFloat(document.getElementById('m-cout-estime').value)||0,
          coutReel: parseFloat(document.getElementById('m-cout-reel').value)||0,
          statut: document.getElementById('m-statut').value,
          priorite: document.getElementById('m-priorite').value,
          sanctuarise: document.getElementById('m-sanctu').value,
          observations: document.getElementById('m-observations').value
        });
        this.save('investissements', items);
        this.renderInvestissements();
      }
    };
    if (this.modalType && handlers[this.modalType]) handlers[this.modalType]();
    // Cas sp√©ciaux admin (g√©r√©s directement par Admin, retournent false si pas trait√©)
    else if (this.modalType && this.modalType.startsWith('admin_')) {
      Admin.saveFromModal(this.modalType);
      return;
    }
    // Cas GED
    else if (this.modalType && this.modalType.startsWith('ged_')) {
      GED.saveFromModal(this.modalType);
      return;
    }
    // Cas saisie de masse
    else if (this.modalType === 'bulk_masse') {
      this._applyBulkMasse();
      return;
    }
    document.getElementById('modal-overlay').classList.remove('open');
    this.modalType = null;
  },

  centreOptions(pre='') {
    return `<option value="">‚Äî Tous ‚Äî</option>` + CENTRES.map(c => `<option value="${c}" ${pre===c?'selected':''}>${c.replace('VILLAGE SPORTIF ','VS ')}</option>`).join('');
  },

  openObsModal() {
    this.openModal('Nouvelle Observation', `
      <div class="form-grid">
        <div class="form-group"><label>Centre</label><select id="m-centre">${this.centreOptions(this.centre==='ALL'?'':this.centre)}</select></div>
        <div class="form-group"><label>Cat√©gorie</label>
          <select id="m-categorie"><option>S√©curit√© incendie</option><option>Accessibilit√©</option><option>√âquipement</option><option>Structure</option><option>Autre</option></select>
        </div>
        <div class="form-group full" style="grid-column:span 2"><label>Description</label><textarea id="m-description" rows="3"></textarea></div>
        <div class="form-group"><label>Statut</label>
          <select id="m-statut"><option>Ouvert</option><option>En cours</option><option>Cl√¥tur√©</option></select>
        </div>
      </div>`, 'obs');
  },

  openVeilleModal() {
    this.openModal('Veille R√©glementaire', `
      <div class="form-grid">
        <div class="form-group"><label>R√©f√©rence</label><input type="text" id="m-reference" placeholder="D√©cret n¬∞..."></div>
        <div class="form-group"><label>Impact</label>
          <select id="m-impact"><option>Majeur</option><option>Mineur</option><option>Informatif</option></select>
        </div>
        <div class="form-group full" style="grid-column:span 2"><label>Objet</label><textarea id="m-objet" rows="3"></textarea></div>
      </div>`, 'veille');
  },

  openMaintModal() {
    this.openModal('Nouvelle Anomalie', `
      <div class="form-grid">
        <div class="form-group"><label>Centre</label><select id="m-centre">${this.centreOptions(this.centre==='ALL'?'':this.centre)}</select></div>
        <div class="form-group"><label>Priorit√©</label>
          <select id="m-priorite"><option>Normale</option><option>Haute</option><option>Urgente</option></select>
        </div>
        <div class="form-group"><label>√âquipement</label><input type="text" id="m-equipement"></div>
        <div class="form-group full" style="grid-column:span 2"><label>Description</label><textarea id="m-description" rows="3"></textarea></div>
      </div>`, 'maint');
  },

  openRondeModal() {
    this.openModal('Enregistrer une Ronde', `
      <div class="form-grid">
        <div class="form-group"><label>Centre</label><select id="m-centre">${this.centreOptions(this.centre==='ALL'?'':this.centre)}</select></div>
        <div class="form-group"><label>Type</label>
          <select id="m-type"><option>Ronde s√©curit√©</option><option>Ronde technique</option><option>Ronde ouverture</option><option>Ronde fermeture</option></select>
        </div>
        <div class="form-group"><label>Agent</label><input type="text" id="m-agent"></div>
        <div class="form-group full" style="grid-column:span 2"><label>Observations</label><textarea id="m-observations" rows="2"></textarea></div>
      </div>`, 'ronde');
  },

  openRHModal() {
    this.openModal('Nouveau Collaborateur', `
      <div class="form-grid">
        <div class="form-group"><label>Nom Pr√©nom</label><input type="text" id="m-nom"></div>
        <div class="form-group"><label>Poste</label><input type="text" id="m-poste"></div>
        <div class="form-group"><label>Centre</label><select id="m-centre">${this.centreOptions(this.centre==='ALL'?'':this.centre)}</select></div>
        <div class="form-group"><label>Habilitation</label>
          <select id="m-habilitation"><option>B1V</option><option>B2V</option><option>BR</option><option>BC</option><option>H0V</option><option>CACES R489</option><option>CACES R486</option><option>SST</option><option>SSI Exploitant</option><option>Autre</option></select>
        </div>
        <div class="form-group"><label>Date obtention</label><input type="date" id="m-dateObtention"></div>
        <div class="form-group"><label>Expiration</label><input type="date" id="m-expiration"></div>
      </div>`, 'rh');
  },

  openContratModal() {
    this.openModal('Nouveau Contrat', `
      <div class="form-grid">
        <div class="form-group"><label>Prestataire</label><input type="text" id="m-prestataire"></div>
        <div class="form-group"><label>Objet</label><input type="text" id="m-objet"></div>
        <div class="form-group"><label>Centre</label><select id="m-centre">${this.centreOptions(this.centre==='ALL'?'':this.centre)}</select></div>
        <div class="form-group"><label>D√©but</label><input type="date" id="m-debut"></div>
        <div class="form-group"><label>Fin</label><input type="date" id="m-fin"></div>
      </div>`, 'contrat');
  },

  openTacheModal() {
    this.openModal('Nouvelle T√¢che', `
      <div class="form-grid">
        <div class="form-group full" style="grid-column:span 2"><label>Titre</label><input type="text" id="m-titre"></div>
        <div class="form-group"><label>Centre</label><select id="m-centre">${this.centreOptions(this.centre==='ALL'?'':this.centre)}</select></div>
        <div class="form-group"><label>Priorit√©</label>
          <select id="m-priorite"><option>Normale</option><option>Haute</option><option>Urgente</option></select>
        </div>
        <div class="form-group"><label>√âch√©ance</label><input type="date" id="m-echeance"></div>
      </div>`, 'tache');
  },

  // ‚îÄ‚îÄ CSV IMPORT ‚îÄ‚îÄ
  importCSV() { document.getElementById('csv-input').click(); },
  handleCSV(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result;
      const lines = text.split('\n');
      if (lines.length < 2) return;
      const headers = lines[0].split(';').map(h=>h.trim().replace(/^\uFEFF/,''));
      const items = [];
      for (let i=1;i<lines.length;i++) {
        const vals = lines[i].split(';');
        if (vals.length < 2) continue;
        const obj = {};
        headers.forEach((h,j) => obj[h.toLowerCase().replace(/[^a-z]/g,'')] = (vals[j]||'').trim());
        items.push(obj);
      }
      // Try to map to registre or observations
      alert(`${items.length} lignes import√©es. Les donn√©es seront int√©gr√©es au registre.`);
      // Map to observations if has statut column
      if (headers.some(h => h.toLowerCase().includes('statut'))) {
        const obs = this.load('observations') || [];
        items.forEach(item => {
          obs.push({
            id: this.uuid(), date: item.date||this.today(),
            centre: item.centre||'', categorie: item.catgorie||item.libelle||'',
            description: item.observations||item.libelle||'', statut: item.statut||'Ouvert'
          });
        });
        this.save('observations', obs);
      }
      event.target.value = '';
      this.renderAll();
    };
    reader.readAsText(file, 'utf-8');
  },

  // ‚îÄ‚îÄ EXCEL EXPORTS (SheetJS) ‚îÄ‚îÄ
  exportToExcel(data, headers, filename, sheetname) {
    if (!window.XLSX) { alert('SheetJS non disponible'); return; }
    const ws_data = [headers, ...data];
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, sheetname || 'Export');
    XLSX.writeFile(wb, filename + '_' + this.today() + '.xlsx');
  },

  exportRegistreExcel() {
    if (!window.XLSX) { alert('SheetJS non disponible'); return; }
    const wb = XLSX.utils.book_new();
    const reg = this.load('registre') || {};
    const centres = this.centre==='ALL' ? CENTRES : [this.centre];
    const headers = ['Centre','Cat.','Groupe','Libell√©','P√©riodicit√©','Dernier contr√¥le','R√©sultat','Organisme','Prochain contr√¥le','Observations'];
    const allRows = [headers];
    centres.forEach(c => {
      const rows = reg[c] || [];
      rows.forEach(r => allRows.push([c, r.catId, r.groupe, r.libelle, r.periodicite||'', r.dateRealisation||'', r.resultat||'', r.organisme||'', r.prochainControle||'', r.observations||'']));
    });
    const ws = XLSX.utils.aoa_to_sheet(allRows);
    ws['!cols'] = [{wch:30},{wch:6},{wch:20},{wch:40},{wch:12},{wch:14},{wch:14},{wch:20},{wch:14},{wch:30}];
    XLSX.utils.book_append_sheet(wb, ws, 'Registre S√©curit√©');
    XLSX.writeFile(wb, `UCPA_AlpesSud_Registre_${this.today()}.xlsx`);
  },

  exportObsExcel() {
    const items = (this.load('observations')||[]).filter(i=>this.centre==='ALL'||!i.centre||i.centre===this.centre);
    this.exportToExcel(items.map(i=>[i.date||'',i.centre||'',i.categorie||'',i.description||'',i.statut||'']),
      ['Date','Centre','Cat√©gorie','Description','Statut'], 'UCPA_AlpesSud_Observations', 'Observations');
  },

  exportMaintenanceExcel() {
    const items = (this.load('maintenance')||[]).filter(i=>this.centre==='ALL'||!i.centre||i.centre===this.centre);
    this.exportToExcel(items.map(i=>[i.date||'',i.centre||'',i.equipement||'',i.description||'',i.priorite||'',i.statut||'']),
      ['Date','Centre','√âquipement','Description','Priorit√©','Statut'], 'UCPA_AlpesSud_Maintenance', 'Maintenance');
  },

  exportRondesExcel() {
    const items = (this.load('rondes')||[]).filter(i=>this.centre==='ALL'||!i.centre||i.centre===this.centre);
    this.exportToExcel(items.map(i=>[i.date||'',i.centre||'',i.type||'',i.agent||'',i.observations||'']),
      ['Date','Centre','Type','Agent','Observations'], 'UCPA_AlpesSud_Rondes', 'Rondes');
  },

  exportRHExcel() {
    const items = (this.load('rh')||[]).filter(i=>this.centre==='ALL'||!i.centre||i.centre===this.centre);
    this.exportToExcel(items.map(i=>[i.centre||'',i.nom||'',i.poste||'',i.habilitation||'',i.dateObtention||'',i.expiration||'']),
      ['Centre','Nom','Poste','Habilitation','Date obtention','Expiration'], 'UCPA_AlpesSud_Habilitations', 'RH Habilitations');
  },

  exportContratsExcel() {
    const items = (this.load('contrats')||[]).filter(i=>this.centre==='ALL'||!i.centre||i.centre===this.centre);
    this.exportToExcel(items.map(i=>[i.centre||'',i.prestataire||'',i.objet||'',i.debut||'',i.fin||'']),
      ['Centre','Prestataire','Objet','D√©but','Fin'], 'UCPA_AlpesSud_Contrats', 'Contrats');
  },

  exportSanitaireExcel() { ECS.exportExcel(); },

  exportTachesExcel() {
    const items = (this.load('taches')||[]).filter(i=>this.centre==='ALL'||!i.centre||i.centre===this.centre);
    this.exportToExcel(items.map(i=>[i.centre||'',i.titre||'',i.priorite||'',i.echeance||'',i.statut||'']),
      ['Centre','Titre','Priorit√©','√âch√©ance','Statut'], 'UCPA_AlpesSud_Taches', 'T√¢ches');
  },

  exportVeilleExcel() {
    const items = this.load('veille')||[];
    this.exportToExcel(items.map(i=>[i.date||'',i.reference||'',i.objet||'',i.impact||'']),
      ['Date','R√©f√©rence','Objet','Impact'], 'UCPA_AlpesSud_Veille', 'Veille R√©glementaire');
  },

  exportMatrixExcel() {
    if (!window.XLSX) { alert('SheetJS non disponible'); return; }
    const matrix = this.load('matrix') || {};
    const icons = {'ok':'Conforme','warn':'R√©serves','ko':'Non conforme','na':'N/A','':'‚Äî'};
    const headers = ['Cat.','Libell√©',...CENTRES.map(c=>c.replace('VILLAGE SPORTIF ','VS ').replace('CENTRE AQUATIQUE ','CA '))];
    const rows = CONTROLES_TEMPLATE.map(t => [t.catId, t.libelle, ...CENTRES.map(c=>icons[matrix[`${c}::${t.catId}`]||''])]);
    this.exportToExcel(rows, headers, 'UCPA_AlpesSud_Matrice', 'Matrice Conformit√©');
  },

  // ‚îÄ‚îÄ INVESTISSEMENTS ‚îÄ‚îÄ
  renderInvestissements() {
    const invs = this.load('investissements') || [];
    const anneeF = document.getElementById('inv-annee-filter')?.value || '';
    const catF = document.getElementById('inv-cat-filter')?.value || '';
    const statutF = document.getElementById('inv-statut-filter')?.value || '';
    const filtered = invs.filter(inv => {
      if (this.centre !== 'ALL' && inv.centre && inv.centre !== this.centre) return false;
      if (anneeF && inv.annee !== anneeF) return false;
      if (catF && inv.categorie !== catF) return false;
      if (statutF && inv.statut !== statutF) return false;
      return true;
    });

    // KPIs
    const totalEst = filtered.reduce((s,i) => s + (parseFloat(i.coutEstime)||0), 0);
    const totalReel = filtered.reduce((s,i) => s + (parseFloat(i.coutReel)||0), 0);
    const termines = filtered.filter(i=>i.statut==='Terminer').length;
    const enCours = filtered.filter(i=>i.statut==='En cours').length;
    const sanctu = filtered.filter(i=>i.sanctuarise==='OUI').length;

    const kpiGrid = document.getElementById('inv-kpi-grid');
    if (kpiGrid) {
      const fmt = v => v >= 1000000 ? (v/1000000).toFixed(2)+'M‚Ç¨' : v >= 1000 ? (v/1000).toFixed(0)+'k‚Ç¨' : v+'‚Ç¨';
      kpiGrid.innerHTML = `
        <div class="kpi"><div class="kpi-label">Budget estim√©</div><div class="kpi-val" style="font-size:24px;color:var(--blue)">${fmt(totalEst)}</div><div class="kpi-sub">${filtered.length} investissements</div></div>
        <div class="kpi"><div class="kpi-label">Co√ªt r√©el</div><div class="kpi-val" style="font-size:24px;color:${totalReel>totalEst?'var(--red)':'var(--green)'}">${fmt(totalReel)}</div><div class="kpi-sub">Engagement actuel</div></div>
        <div class="kpi ok"><div class="kpi-label">Termin√©s</div><div class="kpi-val">${termines}</div><div class="kpi-sub">sur ${filtered.length}</div></div>
        <div class="kpi warn"><div class="kpi-label">En cours</div><div class="kpi-val">${enCours}</div><div class="kpi-sub">projets actifs</div></div>
        <div class="kpi"><div class="kpi-label">Sanctuaris√©s</div><div class="kpi-val" style="color:var(--accent)">${sanctu}</div><div class="kpi-sub">OUI</div></div>
      `;
    }

    const wrap = document.getElementById('inv-table-wrap');
    if (!wrap) return;

    const statusColors = {'Terminer':'ok','En cours':'warn','Pas commenc√©':'na','Projet':'na','Report':'ko','Devis sign√©':'warn'};
    let html = `<table><thead><tr>
      <th>Ann√©e</th><th>Centre</th><th>Cat√©gorie</th><th>Type</th><th>Description</th>
      <th>Budget estim√©</th><th>Co√ªt r√©el</th><th>Sanctu.</th><th>Statut</th><th>Priorit√©</th><th>Observations</th><th></th>
    </tr></thead><tbody>`;

    if (filtered.length === 0) {
      html += `<tr><td colspan="12"><div class="empty-state"><div class="icon">üí∞</div><div>Aucun investissement ‚Äî Importez un fichier Excel ou ajoutez manuellement</div></div></td></tr>`;
    } else {
      filtered.forEach((inv, idx) => {
        const sc = statusColors[inv.statut] || 'na';
        const over = parseFloat(inv.coutReel||0) > parseFloat(inv.coutEstime||0) && parseFloat(inv.coutEstime||0) > 0;
        html += `<tr>
          <td style="font-family:'DM Mono';font-size:11px">${inv.annee||'‚Äî'}</td>
          <td style="font-size:11px;color:var(--muted);max-width:100px">${(inv.centre||'‚Äî').replace('VILLAGE SPORTIF ','VS ')}</td>
          <td><span class="pill pill-na" style="font-size:10px">${inv.categorie||'‚Äî'}</span></td>
          <td style="font-size:11px">${inv.typeInv||'‚Äî'}</td>
          <td style="max-width:200px;font-size:12px">${inv.description||'‚Äî'}</td>
          <td style="font-family:'DM Mono';font-size:12px;text-align:right">${inv.coutEstime?Number(inv.coutEstime).toLocaleString('fr-FR')+'‚Ç¨':'‚Äî'}</td>
          <td style="font-family:'DM Mono';font-size:12px;text-align:right;color:${over?'var(--red)':'var(--text)'}">${inv.coutReel?Number(inv.coutReel).toLocaleString('fr-FR')+'‚Ç¨':'‚Äî'}</td>
          <td style="text-align:center">${inv.sanctuarise==='OUI'?'<span class="pill pill-ok" style="font-size:10px">OUI</span>':'<span style="color:var(--muted);font-size:11px">‚Äî</span>'}</td>
          <td><span class="pill pill-${sc}" style="font-size:10px">${inv.statut||'‚Äî'}</span></td>
          <td style="font-size:11px">${inv.priorite||'‚Äî'}</td>
          <td style="font-size:11px;color:var(--muted);max-width:150px">${inv.observations||'‚Äî'}</td>
          <td><button class="btn btn-ghost btn-sm" onclick="App.deleteInvestissement(${invs.indexOf(inv)})">üóë</button></td>
        </tr>`;
      });
    }
    html += '</tbody></table>';
    wrap.innerHTML = html;
  },

  deleteInvestissement(idx) {
    if (!confirm('Supprimer cet investissement ?')) return;
    const invs = this.load('investissements') || [];
    invs.splice(idx, 1);
    this.save('investissements', invs);
    this.renderInvestissements();
  },

  openInvModal() {
    this.openModal('Nouvel Investissement', `
      <div class="form-grid">
        <div class="form-group"><label>Ann√©e</label>
          <select id="m-annee"><option>2024</option><option selected>2025</option><option>2026</option><option>2027</option><option>2028</option></select>
        </div>
        <div class="form-group"><label>Centre</label><select id="m-centre">${this.centreOptions(this.centre==='ALL'?'':this.centre)}</select></div>
        <div class="form-group"><label>Cat√©gorie</label>
          <select id="m-categorie"><option>GER</option><option>IMMOBILIER</option><option>MOBILIER</option><option>TRANSITION ECOLOGIQUE</option><option>INFORMATIQUE</option><option>MARQUES DESTINATION</option></select>
        </div>
        <div class="form-group"><label>Type investissement</label>
          <select id="m-typeinv"><option>SSI</option><option>Gros Oeuvre</option><option>Cuisine</option><option>Am√©nagement int√©rieur</option><option>CVC</option><option>Espace ext√©rieur</option><option>Piscine</option><option>√âlectricit√©</option><option>Plomberie</option><option>Autre</option></select>
        </div>
        <div class="form-group full" style="grid-column:span 2"><label>Description</label><textarea id="m-description" rows="2"></textarea></div>
        <div class="form-group"><label>Budget estim√© (‚Ç¨)</label><input type="number" id="m-cout-estime" placeholder="0"></div>
        <div class="form-group"><label>Co√ªt r√©el (‚Ç¨)</label><input type="number" id="m-cout-reel" placeholder="0"></div>
        <div class="form-group"><label>Statut</label>
          <select id="m-statut"><option>Pas commenc√©</option><option>En cours</option><option>Terminer</option><option>Projet</option><option>Report</option><option>Devis sign√©</option></select>
        </div>
        <div class="form-group"><label>Priorit√©</label>
          <select id="m-priorite"><option>1 - Urgent</option><option>2 - Important</option><option>3 - Planifi√©</option></select>
        </div>
        <div class="form-group"><label>Sanctuaris√©</label>
          <select id="m-sanctu"><option value="">Non</option><option value="OUI">OUI</option></select>
        </div>
        <div class="form-group full" style="grid-column:span 2"><label>Observations</label><input type="text" id="m-observations" placeholder="Commentaires, r√©f√©rences..."></div>
      </div>`, 'investissement');
  },

  handleInvImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (!window.XLSX) { alert('SheetJS non disponible'); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const wb = XLSX.read(e.target.result, {type:'binary', cellDates:true});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
        const invs = this.load('investissements') || [];
        let count = 0;
        rows.forEach(row => {
          // Try to map common column names
          const inv = {
            id: this.uuid(),
            annee: String(row['Ann√©e']||row['ANNEE']||row['annee']||row['Exercice']||''),
            centre: String(row['Centre']||row['CENTRE']||row['centre']||row['√âtablissement']||''),
            categorie: String(row['Cat√©gorie']||row['CATEGORIE']||row['Type budget']||row['CATEGORIE BUDGET']||'GER'),
            typeInv: String(row['Type']||row['TYPE']||row['Lot']||row['LOT']||row['Type investissement']||''),
            description: String(row['Description']||row['DESCRIPTION']||row['Libell√©']||row['LIBELLE']||row['Objet']||''),
            coutEstime: parseFloat(String(row['Budget estim√©']||row['BUDGET ESTIME']||row['Montant estim√©']||row['Cout estim√©']||row['MONTANT ESTIME']||'0').replace(/\s/g,'').replace(',','.'))||0,
            coutReel: parseFloat(String(row['Co√ªt r√©el']||row['COUT REEL']||row['Montant r√©el']||row['D√©pense r√©elle']||row['MONTANT REEL']||'0').replace(/\s/g,'').replace(',','.'))||0,
            statut: String(row['Statut']||row['STATUT']||row['Avancement']||'Pas commenc√©'),
            priorite: String(row['Priorit√©']||row['PRIORITE']||row['Urgence']||''),
            sanctuarise: String(row['Sanctuaris√©']||row['SANCTUARISE']||row['Sanctu']||''),
            observations: String(row['Observations']||row['OBSERVATIONS']||row['Commentaires']||'')
          };
          if (inv.description || inv.coutEstime > 0) { invs.push(inv); count++; }
        });
        this.save('investissements', invs);
        alert(`${count} investissements import√©s.`);
        event.target.value = '';
        this.renderInvestissements();
      } catch(err) {
        alert('Erreur lors de la lecture du fichier: ' + err.message);
      }
    };
    reader.readAsBinaryString(file);
  },

  exportInvExcel() {
    if (!window.XLSX) { alert('SheetJS non disponible'); return; }
    const invs = this.load('investissements') || [];
    const filtered = invs.filter(inv => this.centre==='ALL' || !inv.centre || inv.centre===this.centre);
    const wb = XLSX.utils.book_new();
    const headers = ['Ann√©e','Centre','Cat√©gorie','Type investissement','Description','Budget estim√© (‚Ç¨)','Co√ªt r√©el (‚Ç¨)','Sanctuaris√©','Statut','Priorit√©','Observations'];
    const rows = filtered.map(i=>[i.annee||'',i.centre||'',i.categorie||'',i.typeInv||'',i.description||'',i.coutEstime||0,i.coutReel||0,i.sanctuarise||'',i.statut||'',i.priorite||'',i.observations||'']);
    const ws = XLSX.utils.aoa_to_sheet([headers,...rows]);
    ws['!cols'] = [{wch:8},{wch:30},{wch:20},{wch:20},{wch:40},{wch:16},{wch:16},{wch:12},{wch:14},{wch:12},{wch:30}];
    // Add summary sheet
    const cats = {};
    filtered.forEach(i => {
      const c = i.categorie||'Autre';
      if(!cats[c]) cats[c]={count:0,estime:0,reel:0};
      cats[c].count++;cats[c].estime+=parseFloat(i.coutEstime||0);cats[c].reel+=parseFloat(i.coutReel||0);
    });
    const sumRows = [['Cat√©gorie','Nb projets','Budget estim√©','Co√ªt r√©el','√âcart'],...Object.entries(cats).map(([c,v])=>[c,v.count,v.estime,v.reel,v.reel-v.estime])];
    const wsSummary = XLSX.utils.aoa_to_sheet(sumRows);
    XLSX.utils.book_append_sheet(wb, ws, 'Investissements');
    XLSX.utils.book_append_sheet(wb, wsSummary, 'Synth√®se');
    XLSX.writeFile(wb, `UCPA_AlpesSud_Investissements_${this.today()}.xlsx`);
  },

  exportInvPDF() {
    if (!window.jspdf) { alert('jsPDF non disponible'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    let y = this.pdfHeader(doc, 'Suivi des Investissements GER');
    const invs = (this.load('investissements')||[]).filter(inv => this.centre==='ALL'||!inv.centre||inv.centre===this.centre);
    doc.setFontSize(7); doc.setTextColor(80,80,80);
    const totalE = invs.reduce((s,i)=>s+(parseFloat(i.coutEstime)||0),0);
    const totalR = invs.reduce((s,i)=>s+(parseFloat(i.coutReel)||0),0);
    doc.setFontSize(9); doc.setFont('helvetica','bold');
    doc.text(`Total estim√©: ${totalE.toLocaleString('fr-FR')}‚Ç¨ | Co√ªt r√©el: ${totalR.toLocaleString('fr-FR')}‚Ç¨ | ${invs.length} investissements`, 14, y); y+=8;
    doc.setFont('helvetica','normal'); doc.setFontSize(7);
    invs.forEach(inv => {
      const line = `${inv.annee||'‚Äî'} | ${(inv.centre||'‚Äî').replace('VILLAGE SPORTIF ','')} | ${inv.categorie||'‚Äî'} | ${(inv.description||'‚Äî').substring(0,50)} | ${inv.coutEstime||0}‚Ç¨ / ${inv.coutReel||0}‚Ç¨ | ${inv.statut||'‚Äî'}`;
      doc.text(line, 14, y, {maxWidth:265}); y+=5;
      if (y>185) { doc.addPage('landscape'); y=this.pdfHeader(doc,'Investissements (suite)'); doc.setFontSize(7); }
    });
    doc.save(`UCPA_AlpesSud_Investissements_${this.today()}.pdf`);
  },

  // ‚îÄ‚îÄ PDF EXPORTS ‚îÄ‚îÄ
  pdfHeader(doc, title) {
    const centre = this.centre === 'ALL' ? 'Tous les centres' : this.centre;
    doc.setFillColor(8, 12, 18);
    doc.rect(0, 0, 210, 30, 'F');
    doc.setTextColor(232, 84, 26);
    doc.setFontSize(16); doc.setFont('helvetica', 'bold');
    doc.text('UCPA ¬∑ Alpes Sud', 14, 14);
    doc.setTextColor(200, 210, 230);
    doc.setFontSize(10); doc.setFont('helvetica', 'normal');
    doc.text(title, 14, 22);
    doc.setTextColor(90, 107, 133);
    doc.setFontSize(9);
    doc.text(`Centre : ${centre}`, 14, 28);
    doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`, 150, 28);
    doc.setTextColor(0, 0, 0);
    return 38;
  },

  exportRegistrePDF() {
    if (!window.jspdf) { alert('jsPDF non disponible'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = this.pdfHeader(doc, 'Registre de S√©curit√© ‚Äî Synth√®se Commission');
    const centres = this.centre==='ALL' ? CENTRES : [this.centre];
    const reg = this.load('registre') || {};
    doc.setFontSize(10);
    centres.forEach(c => {
      doc.setFont('helvetica','bold'); doc.setTextColor(232,84,26);
      doc.text(c, 14, y); y+=6;
      doc.setFont('helvetica','normal'); doc.setTextColor(0,0,0);
      const rows = reg[c] || [];
      rows.filter(r=>r.periodicite).forEach(r => {
        const line = `${r.catId} ¬∑ ${r.libelle} | Dernier: ${r.dateRealisation||'N/A'} | R√©sultat: ${r.resultat||'N/A'} | Prochain: ${r.prochainControle||'N/A'}`;
        doc.setFontSize(8);
        const color = this.isExpired(r.prochainControle) ? [220,50,30] : [0,0,0];
        doc.setTextColor(...color);
        doc.text(line, 14, y, {maxWidth:182}); y+=5;
        if (y>270) { doc.addPage(); y = this.pdfHeader(doc,'Registre de S√©curit√© (suite)'); }
      });
      y+=4;
    });
    doc.save(`UCPA_AlpesSud_Registre_${this.today()}.pdf`);
  },

  exportMatrixPDF() {
    if (!window.jspdf) { alert('jsPDF non disponible'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    let y = this.pdfHeader(doc, 'Matrice de Conformit√©');
    doc.setFontSize(7); doc.setTextColor(80,80,80);
    const matrix = this.load('matrix') || {};
    const icons = {'ok':'‚úì','warn':'~','ko':'‚úó','na':'N/A','':'‚Äî'};
    CONTROLES_TEMPLATE.forEach(t => {
      let line = `${t.catId} ¬∑ ${t.libelle}`;
      CENTRES.forEach(c => {
        const key = `${c}::${t.catId}`;
        line += ` | ${icons[matrix[key]||'']}`;
      });
      doc.text(line, 14, y, {maxWidth:265}); y+=5;
      if (y>185) { doc.addPage('landscape'); y = this.pdfHeader(doc,'Matrice (suite)'); doc.setFontSize(7); }
    });
    doc.save(`UCPA_AlpesSud_Matrice_${this.today()}.pdf`);
  },

  exportPMRPDF() {
    if (!window.jspdf) { alert('jsPDF non disponible'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p','mm','a4');
    const pmr = this.load('pmr') || {};
    const c   = this.centre === 'ALL' ? CENTRES[0] : this.centre;
    const d   = pmr[c] || {};
    const nom = c.replace('VILLAGE SPORTIF ','').replace('CENTRE AQUATIQUE ','CA ').replace('CENTRE NAUTIQUE ','CN ');

    // En-t√™te
    doc.setFillColor(232,84,26);
    doc.rect(0,0,210,14,'F');
    doc.setTextColor(255,255,255);
    doc.setFontSize(11); doc.setFont('helvetica','bold');
    doc.text('UCPA ¬∑ Registre Public d\'Accessibilit√© PMR',14,9);
    doc.setFontSize(8); doc.setFont('helvetica','normal');
    doc.text(new Date().toLocaleDateString('fr-FR'),196,9,{align:'right'});
    doc.setTextColor(30,30,30);

    let y = 22;
    doc.setFontSize(13); doc.setFont('helvetica','bold');
    doc.text(nom,14,y); y+=7;
    doc.setFontSize(8); doc.setFont('helvetica','normal'); doc.setTextColor(120,120,120);
    doc.text('Art. R.111-19-8 Code de la Construction ¬∑ Arr√™t√© 8 d√©cembre 2014',14,y); y+=8;
    doc.setTextColor(30,30,30);

    const icons = {ok:'‚úì Conforme', partial:'‚ñ≥ Partiel', ko:'‚úó Non conforme', na:'N/A', '':'‚Äî Non √©valu√©'};

    // Infos g√©n√©rales
    doc.setFillColor(245,245,245); doc.rect(14,y-4,182,8,'F');
    doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(232,84,26);
    doc.text('INFORMATIONS G√âN√âRALES',16,y); y+=8; doc.setTextColor(30,30,30);
    doc.setFont('helvetica','normal'); doc.setFontSize(9);
    doc.text(`Pr√©sence registre √† l'accueil : ${icons[d.presence||'']}`,14,y); y+=6;
    doc.text(`Attestation d'accessibilit√© : ${icons[d.attestation||'']}`,14,y); y+=6;
    doc.text(`Ad'AP : ${icons[d.adap||'']}`,14,y); y+=6;
    doc.text(`Responsable : ${d.responsable||'‚Äî'}`,14,y); y+=6;
    doc.text(`Date mise √† jour : ${d.date||'‚Äî'} ¬∑ Prochaine v√©rif. : ${d['prochaine-verif']||'‚Äî'}`,14,y); y+=10;

    // Compteurs
    let total=0,okN=0,partialN=0,koN=0;
    PMR_SECTIONS.forEach(s=>s.items.forEach(item=>{
      total++; const v=d['status_'+item.id];
      if(v==='ok')okN++; else if(v==='partial')partialN++; else if(v==='ko')koN++;
    }));
    const pct=total?Math.round(okN/total*100):0;
    doc.setFillColor(232,84,26,0.08);
    doc.setDrawColor(232,84,26);
    doc.roundedRect(14,y-2,182,10,2,2,'FD');
    doc.setFont('helvetica','bold'); doc.setFontSize(9);
    doc.text(`Conformit√© globale : ${okN}/${total} points conformes (${pct}%) ¬∑ ${koN} non conformes ¬∑ ${partialN} partiels`,16,y+5);
    doc.setFont('helvetica','normal'); y+=16;

    // Sections d√©taill√©es
    PMR_SECTIONS.forEach(section => {
      if (y > 260) { doc.addPage(); y = 18; }
      doc.setFillColor(240,240,240);
      doc.rect(14,y-4,182,8,'F');
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(232,84,26);
      doc.text(`${section.icon} ${section.label.toUpperCase()}`,16,y);
      doc.setFont('helvetica','normal'); doc.setFontSize(7); doc.setTextColor(120,120,120);
      doc.text(section.ref,196,y,{align:'right'});
      y+=9; doc.setTextColor(30,30,30);

      section.items.forEach(item => {
        if (y > 268) { doc.addPage(); y = 18; }
        const v    = d['status_'+item.id] || '';
        const obs  = d['obs_'+item.id] || '';
        const ech  = d['ech_'+item.id] || '';
        const color= v==='ok'?[22,163,74]:v==='partial'?[217,119,6]:v==='ko'?[220,38,38]:[100,100,100];

        // Ligne principale
        doc.setFont('helvetica','bold'); doc.setFontSize(8); doc.setTextColor(30,30,30);
        doc.text(item.label,16,y);
        doc.setFillColor(...color);
        doc.setTextColor(255,255,255);
        const statusText = icons[v];
        const tw = doc.getTextWidth(statusText)+6;
        doc.roundedRect(196-tw,y-4,tw,5.5,1,1,'F');
        doc.setFontSize(7); doc.setFont('helvetica','normal');
        doc.text(statusText,196-tw+3,y);
        doc.setTextColor(30,30,30); y+=5;

        doc.setFont('helvetica','normal'); doc.setFontSize(7); doc.setTextColor(100,100,100);
        doc.text(item.ref,16,y); y+=4;
        if (obs) { doc.setTextColor(50,50,50); doc.text('‚Üí '+obs,16,y); y+=4; }
        if (ech) { doc.setTextColor(150,80,0); doc.text('üìÖ √âch√©ance : '+new Date(ech).toLocaleDateString('fr-FR'),16,y); y+=4; }
        doc.setTextColor(220,220,220); doc.line(14,y,196,y); y+=3;
        doc.setTextColor(30,30,30);
      });
      y+=4;
    });

    // Pied de page
    const pages = doc.internal.getNumberOfPages();
    for (let i=1; i<=pages; i++) {
      doc.setPage(i);
      doc.setFontSize(7); doc.setTextColor(150,150,150);
      doc.text(`UCPA ‚Äî Document confidentiel ‚Äî Page ${i}/${pages}`,105,292,{align:'center'});
    }

    doc.save(`UCPA_PMR_${nom.replace(/\s/g,'_')}_${this.today()}.pdf`);
  },

  exportPMRExcel() {
    if (!window.XLSX) { alert('SheetJS non disponible'); return; }
    const pmr = this.load('pmr') || {};
    const c   = this.centre === 'ALL' ? CENTRES[0] : this.centre;
    const d   = pmr[c] || {};
    const icons = {ok:'Conforme', partial:'Partiel', ko:'Non conforme', na:'N/A', '':'Non √©valu√©'};
    const rows = [
      ['Centre','Section','Sous-section (ref.)','Exigence','Conformit√©','Observations','√âch√©ance travaux']
    ];
    const nom = c.replace('VILLAGE SPORTIF ','');
    PMR_SECTIONS.forEach(section => {
      section.items.forEach(item => {
        rows.push([
          nom,
          section.label,
          section.ref,
          item.label,
          icons[d['status_'+item.id]||''],
          d['obs_'+item.id]||'',
          d['ech_'+item.id]||''
        ]);
      });
    });
    const ws  = XLSX.utils.aoa_to_sheet(rows);
    ws['!cols'] = [20,30,30,50,15,40,15].map(w=>({wch:w}));
    const wb  = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'PMR');
    XLSX.writeFile(wb, `UCPA_PMR_${nom.replace(/\s/g,'_')}_${this.today()}.xlsx`);
  },

  exportPreventionPDF() {
    if (!window.jspdf) { alert('jsPDF non disponible'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const prev = this.load('prevention') || {};
    let y = this.pdfHeader(doc, 'Plan de Pr√©vention');
    doc.setFontSize(10);
    const fields = [['Entreprise',prev.entreprise],['Nature travaux',prev.nature],['Responsable',prev.responsable],['D√©but',prev.debut],['Fin',prev.fin],['Effectif',prev.effectif]];
    fields.forEach(([k,v]) => { doc.text(`${k} : ${v||'‚Äî'}`, 14, y); y+=8; });
    y+=4; doc.setFont('helvetica','bold'); doc.text('Risques identifi√©s :', 14, y); y+=8; doc.setFont('helvetica','normal');
    PREV_RISKS.forEach((r, i) => {
      const checked = prev.risques&&prev.risques[i] ? '‚úì' : '‚óã';
      doc.text(`${checked} ${r}${prev.notes&&prev.notes[i]?' ‚Äî '+prev.notes[i]:''}`, 14, y); y+=7;
    });
    y+=4; doc.setFont('helvetica','bold'); doc.text('Signature :', 14, y); y+=8; doc.setFont('helvetica','normal');
    doc.text(`Signataire : ${prev.signataire||'‚Äî'}`, 14, y); y+=6;
    doc.text(`Date/heure : ${new Date().toLocaleString('fr-FR')}`, 14, y); y+=10;
    if (this.sigCanvas) {
      try { doc.addImage(this.sigCanvas.toDataURL('image/png'), 'PNG', 14, y, 80, 24); } catch(e) {}
    }
    doc.save(`UCPA_AlpesSud_PlanPrevention_${this.today()}.pdf`);
  },

  exportPermisfeuPDF() {
    const pf = this.load('permisfeu') || {};
    const allChecked = PF_CHECKS.every((_, i) => pf.checks && pf.checks[i]);
    if (!allChecked) { if (!confirm('Toutes les v√©rifications ne sont pas coch√©es. Exporter quand m√™me ?')) return; }
    if (!window.jspdf) { alert('jsPDF non disponible'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = this.pdfHeader(doc, 'Permis de Feu');
    doc.setFontSize(10);
    doc.text(`N¬∞ Permis : ${pf.num||'‚Äî'}`, 14, y); y+=8;
    doc.text(`Date : ${pf.date||'‚Äî'}`, 14, y); y+=8;
    doc.text(`Entreprise : ${pf.entreprise||'‚Äî'}`, 14, y); y+=8;
    doc.text(`Localisation : ${pf.local||'‚Äî'}`, 14, y); y+=12;
    doc.setFont('helvetica','bold'); doc.text('V√©rifications :', 14, y); y+=8; doc.setFont('helvetica','normal');
    PF_CHECKS.forEach((c, i) => {
      doc.text(`${pf.checks&&pf.checks[i]?'‚úì':'‚óã'} ${c}`, 14, y); y+=7;
    });
    y+=6; doc.text(`Signataire : ${pf.signataire||'‚Äî'}`, 14, y); y+=6;
    doc.text(`Horodatage : ${new Date().toLocaleString('fr-FR')}`, 14, y); y+=10;
    if (this.sigCanvasPF) {
      try { doc.addImage(this.sigCanvasPF.toDataURL('image/png'), 'PNG', 14, y, 80, 24); } catch(e) {}
    }
    doc.save(`UCPA_AlpesSud_PermisFeu_${this.today()}.pdf`);
  },

  exportSanitairePDF() { ECS.exportPDF(); },

  exportChecklistPDF(type) {
    if (!window.jspdf) { alert('jsPDF non disponible'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const def = CHECKLIST_DEFS[type];
    let y = this.pdfHeader(doc, `Check-list ${def.label}`);
    const cl = this.load('checklists') || {};
    const c = this.centre==='ALL'?'ALL':this.centre;
    const key = `${c}::${type}`;
    const data = cl[key] || {};
    doc.setFontSize(10);
    def.items.forEach((item, i) => {
      const checked = data[i] ? '‚úì' : '‚óã';
      const val = data['v_'+i] || '';
      doc.text(`${checked} ${item}${val?' ‚Äî '+val:''}`, 14, y); y+=8;
      if (y>270) { doc.addPage(); y=40; }
    });
    doc.save(`UCPA_AlpesSud_Checklist_${type}_${this.today()}.pdf`);
  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH SYSTEM ‚Äî Multi-r√©gion
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Centres Alpes Sud ‚îÄ‚îÄ
const CENTRES_SUD = [
  "VILLAGE SPORTIF SAINT SORLIN D'ARVES",
  "VILLAGE SPORTIF VALMEINIER",
  "VILLAGE SPORTIF VAL CENIS",
  "VILLAGE SPORTIF SERRE CHEVALIER",
  "VILLAGE SPORTIF VALLOIRE",
  "VILLAGE SPORTIF PRALOGNAN",
  "VILLAGE SPORTIF VAL THORENS",
  "VILLAGE SPORTIF LES ORRES",
  "VILLAGE SPORTIF LE VERDON",
  "VILLAGE SPORTIF ORPIERRE",
  "VILLAGE SPORTIF LES 2 ALPES VENOSC",
  "CCAS, CLAPI√àRE ET BASE DE VOILE",
  "CENTRE AQUATIQUE EAUX CHAUDES"
];

// ‚îÄ‚îÄ Centres Alpes Nord ‚îÄ‚îÄ
const CENTRES_NORD = [
  "VILLAGE SPORTIF CHAMONIX",
  "VILLAGE SPORTIF MEG√àVE",
  "VILLAGE SPORTIF LES GETS",
  "VILLAGE SPORTIF MORZINE",
  "VILLAGE SPORTIF SAMO√ãNS",
  "VILLAGE SPORTIF FLAINE",
  "VILLAGE SPORTIF LES CONTAMINES",
  "VILLAGE SPORTIF SAINT GERVAIS",
  "VILLAGE SPORTIF COMBLOUX",
  "VILLAGE SPORTIF PASSY",
  "VILLAGE SPORTIF CORDON",
  "VILLAGE SPORTIF SALLANCHES",
  "CENTRE NAUTIQUE ANNECY"
];

// G√©n√®re les passwords centre = nom du centre en minuscules (sans "VILLAGE SPORTIF " ou "CENTRE ")
function buildCentrePasswords(centres) {
  const pw = {};
  centres.forEach(c => {
    pw[c] = c.toLowerCase()
      .replace('village sportif ', '')
      .replace('centre aquatique ', '')
      .replace('centre nautique ', '')
      .replace('ccas, clapi√®re et base de voile', 'ccas, clapi√®re et base de voile')
      .trim();
  });
  return pw;
}

const CENTRE_PASSWORDS_SUD  = buildCentrePasswords(CENTRES_SUD);
const CENTRE_PASSWORDS_NORD = buildCentrePasswords(CENTRES_NORD);

const Auth = {
  currentTab: 'admin',       // 'admin' | 'sud' | 'nord'
  currentSubTab: { sud: 'region', nord: 'region' },

  init() {
    // Charger les listes de centres personnalis√©es (admin)
    Admin.loadPersistedCentres();

    // Populate Sud centre select
    this._populateCentreSelect('login-centre-sud', CENTRES_SUD);
    // Populate Nord centre select
    this._populateCentreSelect('login-centre-nord', CENTRES_NORD);

    // Check session
    const sess = sessionStorage.getItem('ucpa_session');
    if (sess) {
      try {
        const s = JSON.parse(sess);
        this.startSession(s.role, s.region, s.centre, s.label, true);
      } catch(e) { this.showLogin(); }
    } else {
      this.showLogin();
    }
  },

  _populateCentreSelect(id, centres) {
    const sel = document.getElementById(id);
    if (!sel) return;
    centres.forEach(c => {
      const o = document.createElement('option');
      o.value = c;
      o.textContent = c.replace('VILLAGE SPORTIF ','')
                       .replace('CENTRE AQUATIQUE ','CA ')
                       .replace('CENTRE NAUTIQUE ','CN ');
      sel.appendChild(o);
    });
  },

  showLogin() {
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('user-info-bar').style.display = 'none';
  },

  switchTab(tab) {
    this.currentTab = tab;
    ['admin','sud','nord'].forEach(t => {
      const el = document.getElementById('login-tab-'+t);
      const btn = document.getElementById('tab-'+t);
      if (el) el.style.display = t === tab ? '' : 'none';
      if (btn) {
        btn.classList.remove('active-admin','active-sud','active-nord');
        if (t === tab) btn.classList.add('active-'+t);
      }
    });
    document.getElementById('login-error').style.display = 'none';
  },

  switchSubTab(region, sub) {
    this.currentSubTab[region] = sub;
    ['region','centre'].forEach(s => {
      const el = document.getElementById(`login-subtab-${region}-${s}`);
      const btn = document.getElementById(`subtab-${region}-${s}`);
      if (el) el.style.display = s === sub ? '' : 'none';
      if (btn) {
        btn.classList.toggle('active', s === sub);
      }
    });
    document.getElementById('login-error').style.display = 'none';
  },

  login() {
    const err = document.getElementById('login-error');
    err.style.display = 'none';

    // ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ
    if (this.currentTab === 'admin') {
      const user = (document.getElementById('login-user-admin').value || '').trim().toLowerCase();
      const pass = (document.getElementById('login-pass-admin').value || '').trim().toLowerCase();
      if (user === 'admin' && pass === 'admin') {
        this.startSession('admin', 'ALL', 'ALL', 'üëë Admin ‚Äî Toutes r√©gions');
      } else {
        err.style.display = 'block';
        err.textContent = 'Identifiant ou mot de passe Admin incorrect.';
      }
      return;
    }

    // ‚îÄ‚îÄ ALPES SUD ‚îÄ‚îÄ
    if (this.currentTab === 'sud') {
      const sub = this.currentSubTab.sud;
      if (sub === 'region') {
        const user = (document.getElementById('login-user-sud').value || '').trim().toLowerCase();
        const pass = (document.getElementById('login-pass-sud-region').value || '').trim().toLowerCase();
        if (user === 'alpessud' && pass === 'alpessud') {
          this.startSession('region', 'SUD', 'ALL', '‚ñ≤ Alpes Sud ‚Äî Tous les centres');
        } else {
          err.style.display = 'block'; err.textContent = 'Identifiant ou mot de passe Alpes Sud incorrect.';
        }
      } else {
        const centre = document.getElementById('login-centre-sud').value;
        const pass   = (document.getElementById('login-pass-sud-centre').value || '').trim().toLowerCase();
        if (!centre) { err.style.display='block'; err.textContent='S√©lectionnez un centre.'; return; }
        const expected = CENTRE_PASSWORDS_SUD[centre] || '';
        if (pass === expected) {
          const label = 'üèî ' + centre.replace('VILLAGE SPORTIF ','').replace('CENTRE AQUATIQUE ','CA ');
          this.startSession('centre', 'SUD', centre, label);
        } else {
          err.style.display = 'block'; err.textContent = 'Mot de passe incorrect pour ce centre.';
        }
      }
      return;
    }

    // ‚îÄ‚îÄ ALPES NORD ‚îÄ‚îÄ
    if (this.currentTab === 'nord') {
      const sub = this.currentSubTab.nord;
      if (sub === 'region') {
        const user = (document.getElementById('login-user-nord').value || '').trim().toLowerCase();
        const pass = (document.getElementById('login-pass-nord-region').value || '').trim().toLowerCase();
        if (user === 'alpesnord' && pass === 'alpesnord') {
          this.startSession('region', 'NORD', 'ALL', '‚ñ≤ Alpes Nord ‚Äî Tous les centres');
        } else {
          err.style.display = 'block'; err.textContent = 'Identifiant ou mot de passe Alpes Nord incorrect.';
        }
      } else {
        const centre = document.getElementById('login-centre-nord').value;
        const pass   = (document.getElementById('login-pass-nord-centre').value || '').trim().toLowerCase();
        if (!centre) { err.style.display='block'; err.textContent='S√©lectionnez un centre.'; return; }
        const expected = CENTRE_PASSWORDS_NORD[centre] || '';
        if (pass === expected) {
          const label = 'üèî ' + centre.replace('VILLAGE SPORTIF ','').replace('CENTRE NAUTIQUE ','CN ');
          this.startSession('centre', 'NORD', centre, label);
        } else {
          err.style.display = 'block'; err.textContent = 'Mot de passe incorrect pour ce centre.';
        }
      }
      return;
    }
  },

  startSession(role, region, centre, label, fromStorage = false) {
    sessionStorage.setItem('ucpa_session', JSON.stringify({role, region, centre, label}));

    // Set active centres list based on region
    let activeCentres, regionLabel, storagePrefix;
    if (role === 'admin') {
      // Admin voit les deux r√©gions ‚Äî on met tous les centres
      activeCentres = [...CENTRES_SUD, ...CENTRES_NORD];
      regionLabel   = '‚ñ≤ Alpes Sud + Nord ¬∑ Admin';
      storagePrefix = 'ucpa_admin_';
      document.body.classList.add('region-admin');
    } else if (region === 'NORD') {
      activeCentres = CENTRES_NORD;
      regionLabel   = '‚ñ≤ Alpes Nord ¬∑ ' + CENTRES_NORD.length + ' Centres';
      storagePrefix = 'ucpa_nord_';
      document.body.classList.add('region-nord');
    } else {
      activeCentres = CENTRES_SUD;
      regionLabel   = '‚ñ≤ Alpes Sud ¬∑ ' + CENTRES_SUD.length + ' Centres';
      storagePrefix = 'ucpa_sud_';
    }

    // Override global CENTRES for this session
    CENTRES.length = 0;
    activeCentres.forEach(c => CENTRES.push(c));

    // Update storage prefix so each region has its own data
    App._storagePrefix = storagePrefix;

    // Update UI labels
    document.getElementById('sidebar-region-label').textContent = regionLabel;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('user-info-bar').style.display = 'flex';

    // Build user info label with badge
    const infoEl = document.getElementById('user-info-text');
    let badge = '';
    if (role === 'admin') badge = '<span class="badge-admin">ADMIN</span>';
    else if (region === 'NORD') badge = '<span class="badge-region-nord">NORD</span>';
    infoEl.innerHTML = label + badge;

    // Rebuild centre selector
    const sel = document.getElementById('centre-select');
    sel.innerHTML = '<option value="ALL">‚Äî Tous les centres ‚Äî</option>';
    activeCentres.forEach(c => {
      const o = document.createElement('option');
      o.value = c;
      o.textContent = c.replace('VILLAGE SPORTIF ','VS ').replace('CENTRE AQUATIQUE ','CA ').replace('CENTRE NAUTIQUE ','CN ');
      sel.appendChild(o);
    });

    // Restrict centre-level users
    if (role === 'centre') {
      sel.value = centre;
      Array.from(sel.options).forEach(o => {
        o.disabled = (o.value !== centre && o.value !== '');
      });
      sel.options[0].disabled = true;
    }

    // Admin: show switcher in sidebar + nav admin
    if (role === 'admin') {
      this._addAdminSwitcher();
      const navAdmin = document.getElementById('nav-admin');
      if (navAdmin) navAdmin.style.display = 'flex';
    }

    App.init();
    if (role === 'centre') {
      App.selectCentre(centre);
    }
  },

  // Admin can switch between region data views
  _addAdminSwitcher() {
    const head = document.getElementById('sidebar-head');
    if (document.getElementById('admin-region-switcher')) return;
    const sw = document.createElement('div');
    sw.id = 'admin-region-switcher';
    sw.className = 'region-switcher';
    sw.style.marginTop = '10px';
    sw.innerHTML = `
      <button class="region-tab active-sud" id="admin-sw-sud" onclick="Auth.adminSwitchRegion('SUD')">‚ñ≤ Sud</button>
      <button class="region-tab" id="admin-sw-nord" onclick="Auth.adminSwitchRegion('NORD')">‚ñ≤ Nord</button>
      <button class="region-tab" id="admin-sw-all" onclick="Auth.adminSwitchRegion('ALL')">‚äï Tout</button>
    `;
    head.appendChild(sw);
  },

  adminSwitchRegion(region) {
    let activeCentres, label;
    if (region === 'ALL') {
      activeCentres = [...CENTRES_SUD, ...CENTRES_NORD];
      label = '‚ñ≤ Alpes Sud + Nord ¬∑ Admin';
      App._storagePrefix = 'ucpa_admin_';
    } else if (region === 'NORD') {
      activeCentres = CENTRES_NORD;
      label = '‚ñ≤ Alpes Nord ¬∑ ' + CENTRES_NORD.length + ' Centres';
      App._storagePrefix = 'ucpa_nord_';
    } else {
      activeCentres = CENTRES_SUD;
      label = '‚ñ≤ Alpes Sud ¬∑ ' + CENTRES_SUD.length + ' Centres';
      App._storagePrefix = 'ucpa_sud_';
    }

    ['sud','nord','all'].forEach(r => {
      const btn = document.getElementById('admin-sw-'+r);
      if (btn) {
        btn.classList.remove('active-sud','active-nord','active-admin');
        if (r === region.toLowerCase()) btn.classList.add('active-'+r === 'active-all' ? 'active-admin' : 'active-'+r);
      }
    });

    CENTRES.length = 0;
    activeCentres.forEach(c => CENTRES.push(c));
    document.getElementById('sidebar-region-label').textContent = label;

    // Rebuild selector
    const sel = document.getElementById('centre-select');
    sel.innerHTML = '<option value="ALL">‚Äî Tous les centres ‚Äî</option>';
    activeCentres.forEach(c => {
      const o = document.createElement('option');
      o.value = c;
      o.textContent = c.replace('VILLAGE SPORTIF ','VS ').replace('CENTRE AQUATIQUE ','CA ').replace('CENTRE NAUTIQUE ','CN ');
      sel.appendChild(o);
    });

    App.centre = 'ALL';
    App.renderAll();
    App.nav(App.page);
  },

  logout() {
    sessionStorage.removeItem('ucpa_session');
    location.reload();
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ECS ‚Äî Carnet Sanitaire / Rondes
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ECS = {

  // ‚îÄ‚îÄ Valider une mesure contre ses seuils ‚îÄ‚îÄ
  _validate(row, val) {
    if (val === '' || val === null || val === undefined) return 'empty';
    const v = parseFloat(val);
    if (isNaN(v)) return 'empty';
    if (row.type === 'bool') return ''; // Bool g√©r√© diff√©remment
    if (row.min  !== undefined && row.max  !== undefined) return (v >= row.min  && v <= row.max)  ? 'ok' : 'ko';
    if (row.minV !== undefined) return v >= row.minV ? 'ok' : 'ko';
    if (row.maxV !== undefined) return v <= row.maxV ? 'ok' : 'ko';
    return ''; // Pas de seuil d√©fini
  },

  // ‚îÄ‚îÄ Rendu du formulaire de saisie ‚îÄ‚îÄ
  renderForm() {
    const wrap = document.getElementById('ecs-form-wrap');
    if (!wrap) return;

    wrap.innerHTML = ECS_SECTIONS.map(section => `
      <div class="ecs-section card" style="margin-bottom:14px">
        <div class="card-hdr" style="padding:10px 16px">
          <span>${section.icon}</span>
          <h3 style="font-size:13px">${section.label}</h3>
          <span class="ecs-badge" style="font-size:9px;font-family:'DM Mono',monospace;background:rgba(232,84,26,0.12);color:var(--accent);padding:2px 8px;border-radius:4px;margin-left:6px">${section.badge}</span>
        </div>
        <div class="card-body" style="padding:12px 16px">
          <!-- En-t√™tes colonnes -->
          <div style="display:grid;grid-template-columns:1fr 90px 56px 60px;gap:8px;padding-bottom:6px;border-bottom:1px solid var(--border);margin-bottom:2px">
            <div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-family:'DM Mono',monospace">Point de mesure</div>
            <div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-family:'DM Mono',monospace;text-align:center">Valeur</div>
            <div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-family:'DM Mono',monospace;text-align:center">√âtat</div>
            <div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-family:'DM Mono',monospace;text-align:center">Unit√©</div>
          </div>
          ${section.rows.map(row => {
            if (row.type === 'bool') {
              return `<div class="ecs-row">
                <div>
                  <div class="ecs-row-label">${row.label}</div>
                  <div class="ecs-row-ref">${row.ref}</div>
                </div>
                <select class="ecs-input" id="ecs-${row.id}" onchange="ECS.updateLive('${row.id}',this.value,'bool')">
                  <option value="">‚Äî</option>
                  <option value="ok">‚úÖ OK</option>
                  <option value="ko">‚ùå NON</option>
                  <option value="na">N/A</option>
                </select>
                <div class="ecs-status empty" id="ecs-st-${row.id}">‚Äî</div>
                <div class="ecs-unit">‚Äî</div>
              </div>`;
            }
            return `<div class="ecs-row">
              <div>
                <div class="ecs-row-label">${row.label}</div>
                <div class="ecs-row-ref">${row.ref}</div>
              </div>
              <input type="number" step="0.1" class="ecs-input" id="ecs-${row.id}"
                placeholder="‚Äî" oninput="ECS.updateLive('${row.id}',this.value)">
              <div class="ecs-status empty" id="ecs-st-${row.id}">‚Äî</div>
              <div class="ecs-unit">${row.unit}</div>
            </div>`;
          }).join('')}
        </div>
      </div>`).join('');
  },

  // ‚îÄ‚îÄ Mise √† jour live d'un champ ‚îÄ‚îÄ
  updateLive(rowId, val, type) {
    // Trouver la d√©finition du row
    let rowDef = null;
    for (const s of ECS_SECTIONS) {
      rowDef = s.rows.find(r => r.id === rowId);
      if (rowDef) break;
    }
    const stEl = document.getElementById('ecs-st-' + rowId);
    const inEl = document.getElementById('ecs-' + rowId);
    if (!stEl) return;

    if (type === 'bool') {
      stEl.className = 'ecs-status ' + (val==='ok' ? 'ok' : val==='ko' ? 'ko' : 'empty');
      stEl.textContent = val==='ok' ? '‚úì OK' : val==='ko' ? '‚úó NON' : '‚Äî';
    } else {
      const status = rowDef ? this._validate(rowDef, val) : '';
      stEl.className = 'ecs-status ' + (status || 'empty');
      stEl.textContent = status==='ok' ? '‚úì OK' : status==='ko' ? '‚úó HRS' : val ? '¬∑' : '‚Äî';
      if (inEl) { inEl.classList.remove('ok','ko'); if (status) inEl.classList.add(status); }
    }

    // Mettre √† jour le r√©sum√©
    this._updateSummary();
  },

  _updateSummary() {
    const body = document.getElementById('ecs-summary-body');
    if (!body) return;

    let total=0, ok=0, ko=0, na=0;
    const anomalies = [];

    ECS_SECTIONS.forEach(s => s.rows.forEach(row => {
      const val = document.getElementById('ecs-'+row.id)?.value;
      if (!val || val==='') return;
      total++;
      if (row.type === 'bool') {
        if (val==='ok') ok++;
        else if (val==='ko') { ko++; anomalies.push({label:row.label, ref:row.ref, val:'NON'}); }
        else na++;
      } else {
        const st = this._validate(row, val);
        if (st==='ok') ok++;
        else if (st==='ko') { ko++; anomalies.push({label:row.label, ref:row.ref, val:val+' '+row.unit}); }
      }
    }));

    if (total === 0) {
      body.innerHTML = '<div style="font-size:12px;color:var(--muted)">Saisissez des mesures pour voir le r√©sum√©.</div>';
      return;
    }

    body.innerHTML = `
      <div class="ecs-kpi-mini"><span>Mesures saisies</span><span class="ecs-kpi-val">${total}</span></div>
      <div class="ecs-kpi-mini"><span style="color:var(--green)">‚úì Conformes</span><span class="ecs-kpi-val" style="color:var(--green)">${ok}</span></div>
      <div class="ecs-kpi-mini"><span style="color:var(--red)">‚úó Hors seuil</span><span class="ecs-kpi-val" style="color:var(--red)">${ko}</span></div>
      ${anomalies.length ? `
        <div style="margin-top:10px;font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-family:'DM Mono',monospace;margin-bottom:6px">‚ö†Ô∏è Points hors seuil</div>
        ${anomalies.map(a => `
          <div style="padding:5px 0;border-bottom:1px solid var(--border);font-size:11px">
            <div style="font-weight:700;color:var(--red)">${a.label}</div>
            <div style="color:var(--muted);font-size:10px">Valeur: <strong>${a.val}</strong> ¬∑ Seuil: ${a.ref}</div>
          </div>`).join('')}` : `
        <div style="margin-top:10px;padding:8px;background:rgba(29,185,84,0.08);border-radius:6px;font-size:11px;color:var(--green);text-align:center">‚úÖ Tous les points sont conformes</div>`}`;
  },

  // ‚îÄ‚îÄ Sauvegarder le relev√© complet ‚îÄ‚îÄ
  saveReleve() {
    const datetime  = document.getElementById('ecs-datetime')?.value || new Date().toISOString();
    const operateur = document.getElementById('ecs-operateur')?.value || '';
    const frequence = document.getElementById('ecs-frequence')?.value || 'mensuel';
    const obsGen    = document.getElementById('ecs-obs-general')?.value || '';

    const mesures = {};
    let anyValue  = false;
    ECS_SECTIONS.forEach(s => s.rows.forEach(row => {
      const el = document.getElementById('ecs-' + row.id);
      if (el && el.value) { mesures[row.id] = el.value; anyValue = true; }
    }));

    if (!anyValue) { alert('Saisissez au moins une mesure avant d\'enregistrer.'); return; }

    const san = App.load('sanitaire') || {ecs:[], purges:[], releves:[]};
    if (!san.releves) san.releves = [];

    const releve = {
      id: App.uuid(),
      centre: App.centre === 'ALL' ? CENTRES[0] : App.centre,
      datetime, operateur, frequence, obsGen,
      mesures,
      savedAt: new Date().toISOString()
    };
    san.releves.unshift(releve);
    App.save('sanitaire', san);

    // Feedback
    const btn = document.querySelector('[onclick="ECS.saveReleve()"]');
    if (btn) {
      const orig = btn.innerHTML;
      btn.innerHTML = '‚úÖ Relev√© enregistr√©';
      btn.style.background = 'var(--green)';
      setTimeout(() => { btn.innerHTML = orig; btn.style.background = ''; }, 2200);
    }

    // Vider le formulaire
    ECS_SECTIONS.forEach(s => s.rows.forEach(row => {
      const el = document.getElementById('ecs-' + row.id);
      if (el) el.value = '';
      const st = document.getElementById('ecs-st-' + row.id);
      if (st) { st.className = 'ecs-status empty'; st.textContent = '‚Äî'; }
    }));
    document.getElementById('ecs-datetime').value = new Date().toISOString().slice(0,16);
    document.getElementById('ecs-obs-general').value = '';
    this._updateSummary();
    this.renderHistory();
  },

  // ‚îÄ‚îÄ Historique ‚îÄ‚îÄ
  renderHistory() {
    const body  = document.getElementById('ecs-history-body');
    const count = document.getElementById('ecs-history-count');
    if (!body) return;

    const san     = App.load('sanitaire') || {};
    const releves = (san.releves || []).filter(r => {
      if (App.centre === 'ALL') return true;
      return r.centre === App.centre;
    });

    if (count) count.textContent = releves.length ? `${releves.length} relev√©(s)` : '';

    if (!releves.length) {
      body.innerHTML = '<div style="font-size:12px;color:var(--muted);text-align:center;padding:20px 0">Aucun relev√© enregistr√© pour ce centre.</div>';
      return;
    }

    body.innerHTML = releves.map(r => {
      const total = Object.keys(r.mesures || {}).length;
      let anomalies = 0;
      ECS_SECTIONS.forEach(s => s.rows.forEach(row => {
        const val = r.mesures?.[row.id];
        if (!val) return;
        if (row.type==='bool' && val==='ko') anomalies++;
        else if (this._validate(row, val) === 'ko') anomalies++;
      }));
      const dt = new Date(r.datetime);
      return `<div class="ecs-history-item" onclick="ECS.viewReleve('${r.id}')">
        <div class="ecs-history-date">${isNaN(dt)?r.datetime:dt.toLocaleDateString('fr-FR')} ${isNaN(dt)?'':dt.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}</div>
        <div class="ecs-history-meta">${r.operateur||'Op√©rateur inconnu'} ¬∑ ${r.frequence||''}</div>
        <div class="ecs-history-badges">
          <span class="ecs-anom-badge ok">${total} mesures</span>
          ${anomalies > 0
            ? `<span class="ecs-anom-badge ko">‚ö† ${anomalies} anomalie${anomalies>1?'s':''}</span>`
            : `<span class="ecs-anom-badge ok">‚úì Conforme</span>`}
        </div>
      </div>`;
    }).join('');
  },

  // ‚îÄ‚îÄ Voir un relev√© ‚îÄ‚îÄ
  viewReleve(id) {
    const san    = App.load('sanitaire') || {};
    const releve = (san.releves || []).find(r => r.id === id);
    if (!releve) return;

    const dt = new Date(releve.datetime);
    let rows = '';
    ECS_SECTIONS.forEach(s => {
      const sectionRows = s.rows.filter(row => releve.mesures?.[row.id]);
      if (!sectionRows.length) return;
      rows += `<div style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--accent);font-family:'DM Mono',monospace;margin-bottom:6px">${s.icon} ${s.label}</div>
        ${sectionRows.map(row => {
          const val = releve.mesures[row.id];
          let status, color;
          if (row.type==='bool') { status=val==='ok'?'‚úì OK':'‚úó NON'; color=val==='ok'?'var(--green)':'var(--red)'; }
          else { const st=this._validate(row,val); status=st==='ok'?'‚úì OK':st==='ko'?'‚úó HRS seuil':'‚Äî'; color=st==='ok'?'var(--green)':st==='ko'?'var(--red)':'var(--muted)'; }
          return `<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);font-size:12px">
            <span style="color:var(--muted2)">${row.label}</span>
            <span style="font-family:'DM Mono',monospace;font-weight:700">
              ${row.type!=='bool'?`${val} ${row.unit} ¬∑ `:''}
              <span style="color:${color}">${status}</span>
            </span>
          </div>`;
        }).join('')}
      </div>`;
    });

    App.openModal(
      `üìã Relev√© du ${isNaN(dt)?releve.datetime:dt.toLocaleDateString('fr-FR')}`,
      `<div style="font-size:11px;color:var(--muted);margin-bottom:14px;padding:8px 12px;background:var(--bg3);border-radius:6px">
        Op√©rateur : <strong>${releve.operateur||'‚Äî'}</strong> ¬∑ Fr√©quence : ${releve.frequence||'‚Äî'}<br>
        ${releve.obsGen ? 'üìù ' + releve.obsGen : ''}
      </div>${rows}`,
      'ecs_view'
    );
    document.getElementById('modal-save').style.display = 'none';
  },

  // ‚îÄ‚îÄ Exports ‚îÄ‚îÄ
  exportExcel() {
    if (!window.XLSX) { alert('SheetJS non disponible'); return; }
    const san     = App.load('sanitaire') || {};
    const releves = san.releves || [];
    if (!releves.length) { alert('Aucun relev√© √† exporter.'); return; }

    const header = ['Date','Heure','Centre','Op√©rateur','Fr√©quence','Observations'];
    ECS_SECTIONS.forEach(s => s.rows.forEach(row => header.push(`[${s.badge}] ${row.label} (${row.unit||row.type})`)));
    header.push('Anomalies');

    const rows = [header];
    releves.forEach(r => {
      const dt = new Date(r.datetime);
      const row = [
        isNaN(dt)?r.datetime:dt.toLocaleDateString('fr-FR'),
        isNaN(dt)?'':dt.toLocaleTimeString('fr-FR'),
        r.centre||'', r.operateur||'', r.frequence||'', r.obsGen||''
      ];
      let anomalies = 0;
      ECS_SECTIONS.forEach(s => s.rows.forEach(rowDef => {
        const val = r.mesures?.[rowDef.id] || '';
        row.push(val);
        if (val && rowDef.type==='bool' && val==='ko') anomalies++;
        else if (val && this._validate(rowDef, val)==='ko') anomalies++;
      }));
      row.push(anomalies);
      rows.push(row);
    });

    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Rondes ECS');
    XLSX.writeFile(wb, `UCPA_ECS_${App.today()}.xlsx`);
  },

  exportPDF() {
    if (!window.jspdf) { alert('jsPDF non disponible'); return; }
    const { jsPDF } = window.jspdf;
    const san     = App.load('sanitaire') || {};
    const releves = (san.releves || []).slice(0, 20);
    if (!releves.length) { alert('Aucun relev√© √† exporter.'); return; }

    const doc = new jsPDF('l','mm','a4');
    const centre = App.centre === 'ALL' ? 'Tous centres' : App.centre.replace('VILLAGE SPORTIF ','');

    doc.setFillColor(232,84,26);
    doc.rect(0,0,297,12,'F');
    doc.setTextColor(255,255,255);
    doc.setFontSize(10); doc.setFont('helvetica','bold');
    doc.text('UCPA ¬∑ Carnet Sanitaire ‚Äî Rondes ECS ‚Äî ' + centre, 14, 8);
    doc.setFontSize(8); doc.setFont('helvetica','normal');
    doc.text('G√©n√©r√© le ' + new Date().toLocaleDateString('fr-FR'), 283, 8, {align:'right'});

    let y = 22;
    doc.setTextColor(30,30,30);

    releves.forEach((r, idx) => {
      if (y > 180) { doc.addPage(); y = 18; }
      const dt = new Date(r.datetime);
      let anomalies = 0;
      ECS_SECTIONS.forEach(s => s.rows.forEach(row => {
        const val = r.mesures?.[row.id];
        if (!val) return;
        if (row.type==='bool' && val==='ko') anomalies++;
        else if (this._validate(row, val)==='ko') anomalies++;
      }));

      const color = anomalies > 0 ? [220,38,38] : [22,163,74];
      doc.setFillColor(...color, 0.1);
      doc.setDrawColor(...color);
      doc.roundedRect(14, y-4, 269, 8, 2, 2, 'FD');
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(...color);
      doc.text(`${isNaN(dt)?r.datetime:dt.toLocaleDateString('fr-FR')} ${isNaN(dt)?'':dt.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}  ¬∑  ${r.operateur||'‚Äî'}  ¬∑  ${r.frequence||''}`, 16, y);
      doc.setTextColor(...color);
      doc.text(anomalies > 0 ? `‚ö† ${anomalies} anomalie(s)` : '‚úì Conforme', 270, y, {align:'right'});
      y += 9; doc.setTextColor(30,30,30);

      // Mesures en colonnes
      const keys = Object.keys(r.mesures || {});
      let x = 14;
      keys.forEach((rowId, i) => {
        let rowDef = null;
        for (const s of ECS_SECTIONS) { rowDef = s.rows.find(rr=>rr.id===rowId); if (rowDef) break; }
        if (!rowDef) return;
        const val  = r.mesures[rowId];
        const st   = rowDef.type==='bool' ? (val==='ok'?'ok':'ko') : this._validate(rowDef,val);
        const col  = st==='ok'?[22,163,74]:st==='ko'?[220,38,38]:[100,100,100];
        doc.setFontSize(7); doc.setFont('helvetica','normal'); doc.setTextColor(80,80,80);
        const label = rowDef.label.length > 22 ? rowDef.label.substr(0,22)+'‚Ä¶' : rowDef.label;
        doc.text(label, x, y);
        doc.setFont('helvetica','bold'); doc.setTextColor(...col);
        doc.text(`${val}${rowDef.unit?' '+rowDef.unit:''}`, x, y+4);
        doc.setTextColor(30,30,30);
        x += 45;
        if (x > 260 || i === keys.length-1) { x=14; y+=10; }
      });
      y += 4;
      doc.setDrawColor(200,200,200); doc.line(14,y,283,y); y+=4;
    });

    doc.save(`UCPA_ECS_${centre.replace(/\s/g,'_')}_${App.today()}.pdf`);
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GED ‚Äî Gestion √âlectronique des Documents
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GED = {

  // ‚îÄ‚îÄ Arborescence compl√®te ‚îÄ‚îÄ
  TREE: [
    { id:'1', icon:'üìë', label:'1 ‚Äî Contrats', children:[
      { id:'1.1', icon:'üìÑ', label:'Contrats de maintenance par lot technique' },
    ]},
    { id:'2', icon:'üèó', label:'2 ‚Äî Donn√©es Techniques', children:[
      { id:'2.1', icon:'üìÑ', label:'DCE et contrats (DSP, PPP, concessions)' },
      { id:'2.2', icon:'üìÑ', label:'DOE ‚Äî Dossiers des ouvrages ex√©cut√©s' },
      { id:'2.3', icon:'üó∫', label:'Plans (structure, masse, fa√ßades, niveaux, toitures)' },
      { id:'2.4', icon:'üìã', label:'Inventaire des biens et √©quipements' },
      { id:'2.5', icon:'üîç', label:'Audits techniques (d√©cret tertiaire, structurel)' },
    ]},
    { id:'3', icon:'üîß', label:'3 ‚Äî Pilotage Maintenance', children:[
      { id:'3.1', icon:'üíß', label:'Consommation des fluides' },
      { id:'3.2', icon:'üìã', label:'Synth√®se des contrats (contrats et fournitures)' },
      { id:'3.3', icon:'‚úÖ', label:'Suivi des op√©rations r√©glementaires' },
      { id:'3.4', icon:'üîÑ', label:'Rondes ECS' },
      { id:'3.5', icon:'üìù', label:'Protocoles de maintenance' },
      { id:'3.6', icon:'üõ†', label:'Op√©rations pr√©ventives' },
      { id:'3.7', icon:'üèó', label:'GER ‚Äî Gros Entretien et Remplacement' },
      { id:'3.8', icon:'üí°', label:'Axes d\'am√©lioration technique' },
      { id:'3.9', icon:'üìÜ', label:'Gammes de maintenance' },
      { id:'3.10', icon:'üî¶', label:'Rondes techniques (inspections, GMAO)' },
    ]},
    { id:'4', icon:'üî•', label:'4 ‚Äî S√©curit√© √âtablissement', children:[
      { id:'4.1', icon:'üèõ', label:'Commission de s√©curit√© ‚Äî Autorisation d\'ouverture, PV' },
      { id:'4.2', icon:'‚ö°', label:'V√©rifications p√©riodiques r√©glementaires' },
      { id:'4.3', icon:'üéì', label:'Formations du personnel (extincteurs, SSI, √©lectrique)' },
      { id:'4.4', icon:'‚ö†', label:'Plan de pr√©vention du site' },
      { id:'4.5', icon:'üöí', label:'Moyens de lutte contre l\'incendie' },
      { id:'4.6', icon:'ü¶†', label:'L√©gionelle et potabilit√© ‚Äî Analyses et plans de pr√©l√®vement' },
    ]},
    { id:'5', icon:'üèó', label:'5 ‚Äî Suivi des Travaux', children:[
      { id:'5.1', icon:'üìä', label:'Suivi et gestion des travaux' },
    ]},
    { id:'6', icon:'üìö', label:'6 ‚Äî Suite Documentaire', children:[
      { id:'6.1', icon:'üìù', label:'Protocole de maintenance' },
      { id:'6.2', icon:'üè¢', label:'Renseignements sur l\'√©tablissement' },
      { id:'6.3', icon:'üë•', label:'Effectif ERP' },
      { id:'6.4', icon:'üìñ', label:'Registre de s√©curit√© (attestations, consignes, rapports)' },
      { id:'6.5', icon:'üìì', label:'Main courante SSI (anomalies, √©v√©nements, interventions)' },
      { id:'6.6', icon:'üö®', label:'S√©curit√© incendie ‚Äî SOSI' },
      { id:'6.7', icon:'‚úÖ', label:'V√©rifications r√©glementaires ‚Äî Suivi' },
      { id:'6.8', icon:'üìÇ', label:'V√©rifications r√©glementaires ‚Äî Classeur de rapports' },
      { id:'6.9', icon:'üìÜ', label:'Maintenance pr√©ventive ‚Äî Planning des op√©rations' },
      { id:'6.10', icon:'üíß', label:'Maintenance pr√©ventive ‚Äî Rondes ECS / BAES' },
    ]},
    { id:'7', icon:'üí∂', label:'7 ‚Äî Suivi Budg√©taire', children:[
      { id:'7.1', icon:'üìä', label:'Suivi des budgets' },
    ]},
    { id:'8', icon:'üö®', label:'8 ‚Äî Sinistres', children:[
      { id:'8.1', icon:'üìã', label:'D√©claration et suivi des sinistres (d√©g√¢ts des eaux, DO)' },
      { id:'8.2', icon:'üîç', label:'Rapports d\'expertise d\'assurance' },
    ]},
    { id:'9', icon:'üìä', label:'9 ‚Äî Rapports de Visite', children:[
      { id:'9.1', icon:'ü§ù', label:'R√©unions techniques ‚Äî Comptes rendus internes et externes' },
      { id:'9.2', icon:'üìã', label:'√âtats des lieux techniques' },
      { id:'9.3', icon:'üîç', label:'Audits internes' },
    ]},
  ],

  _activeFolder: null,   // { id, label, icon }
  _activeParent: null,   // label du dossier parent

  // Cl√© de stockage : par centre
  _key() {
    const c = App.centre === 'ALL' ? '__global__' : App.centre;
    return 'ged_' + c;
  },

  _load() { return App.load(this._key()) || {}; },
  _save(data) { App.save(this._key(), data); },

  // ‚îÄ‚îÄ Rendu principal ‚îÄ‚îÄ
  render() {
    this.renderTree();
    // R√©-ouvrir le dernier dossier si disponible
    if (this._activeFolder) {
      this.openFolder(this._activeFolder.id, this._activeFolder.label, this._activeFolder.icon, this._activeParent);
    }
  },

  renderTree() {
    const body = document.getElementById('ged-tree-body');
    if (!body) return;
    const data = this._load();

    body.innerHTML = this.TREE.map(section => {
      const childCount = (section.children || []).reduce((acc, ch) => {
        return acc + ((data[ch.id] || []).length);
      }, 0);
      return `
        <div class="ged-folder-row" id="ged-row-${section.id}"
          onclick="GED.toggleSection('${section.id}')">
          <span class="ged-icon">${section.icon}</span>
          <span style="flex:1">${section.label}</span>
          ${childCount ? `<span style="font-size:9px;font-family:'DM Mono',monospace;background:rgba(232,84,26,0.15);color:var(--accent);padding:1px 6px;border-radius:10px">${childCount}</span>` : ''}
          <span class="ged-arrow">‚Ä∫</span>
        </div>
        <div class="ged-subfolder-children" id="ged-children-${section.id}">
          ${(section.children || []).map(ch => {
            const docs = data[ch.id] || [];
            return `<div class="ged-subfolder-row" id="ged-row-${ch.id}"
              onclick="GED.openFolder('${ch.id}','${ch.label.replace(/'/g,"\\'")}','${ch.icon}','${section.label.replace(/'/g,"\\'")}')">
              <span>${ch.icon}</span>
              <span style="flex:1">${ch.label}</span>
              ${docs.length ? `<span style="font-size:9px;font-family:'DM Mono',monospace;background:rgba(232,84,26,0.12);color:var(--accent);padding:1px 5px;border-radius:10px">${docs.length}</span>` : ''}
            </div>`;
          }).join('')}
        </div>`;
    }).join('');
  },

  toggleSection(id) {
    const children = document.getElementById('ged-children-' + id);
    const row      = document.getElementById('ged-row-' + id);
    if (!children) return;
    const isOpen = children.classList.contains('open');
    // Fermer tous
    document.querySelectorAll('.ged-subfolder-children').forEach(el => el.classList.remove('open'));
    document.querySelectorAll('.ged-folder-row').forEach(el => el.classList.remove('open'));
    if (!isOpen) {
      children.classList.add('open');
      row.classList.add('open');
    }
  },

  openFolder(id, label, icon, parentLabel) {
    this._activeFolder = { id, label, icon };
    this._activeParent = parentLabel;

    // Activer la ligne
    document.querySelectorAll('.ged-subfolder-row,.ged-folder-row').forEach(el => el.classList.remove('active'));
    const row = document.getElementById('ged-row-' + id);
    if (row) row.classList.add('active');

    // Breadcrumb
    const bc = document.getElementById('ged-breadcrumb');
    bc.style.display = 'flex';
    bc.innerHTML = `<span>${parentLabel}</span><span class="sep">‚Ä∫</span><span style="color:var(--text);font-weight:700">${label}</span>`;

    // Titre
    document.getElementById('ged-folder-icon').textContent = icon;
    document.getElementById('ged-folder-title').textContent = label;
    document.getElementById('ged-add-btn').style.display = App.centre !== 'ALL' ? '' : 'none';

    // Contenu
    this.renderContent(id);
  },

  renderContent(folderId) {
    const body = document.getElementById('ged-content-body');
    if (!body) return;

    if (App.centre === 'ALL') {
      body.innerHTML = `<div class="ged-empty">
        <div class="icon">üè¢</div>
        <div style="font-weight:700;margin-bottom:6px">S√©lectionnez un centre</div>
        <div style="font-size:12px">La GED est organis√©e par centre. Choisissez un centre dans le s√©lecteur.</div>
      </div>`;
      return;
    }

    const data = this._load();
    const docs = data[folderId] || [];

    if (!docs.length) {
      body.innerHTML = `<div class="ged-empty">
        <div class="icon">üìÑ</div>
        <div style="font-weight:700;margin-bottom:6px">Aucun document li√©</div>
        <div style="font-size:12px;color:var(--muted)">Cliquez sur <strong>+ Lier un document</strong> pour ajouter un lien Google Drive ou enregistrer un document.</div>
      </div>`;
      return;
    }

    body.innerHTML = docs.map((doc, i) => `
      <div class="ged-doc-card">
        <div class="ged-doc-icon">${this._docIcon(doc.type)}</div>
        <div class="ged-doc-info">
          <div class="ged-doc-name" title="${doc.name}">${doc.name}</div>
          <div class="ged-doc-meta">
            ${doc.date ? 'üìÖ ' + new Date(doc.date).toLocaleDateString('fr-FR') : ''}
            ${doc.version ? ' ¬∑ v' + doc.version : ''}
            ${doc.note ? ' ¬∑ ' + doc.note : ''}
          </div>
        </div>
        <div class="ged-doc-actions">
          ${doc.url ? `<a class="ged-drive-link" href="${doc.url}" target="_blank" rel="noopener">
            <span>üîó</span> Ouvrir Drive
          </a>` : '<span style="font-size:11px;color:var(--muted)">Pas de lien</span>'}
          <button class="btn btn-ghost btn-sm" onclick="GED.editDoc('${folderId}',${i})" title="Modifier">‚úèÔ∏è</button>
          <button class="btn btn-ghost btn-sm" style="color:var(--red)" onclick="GED.deleteDoc('${folderId}',${i})" title="Supprimer">üóëÔ∏è</button>
        </div>
      </div>`).join('');
  },

  _docIcon(type) {
    const icons = { pdf:'üìÑ', word:'üìù', excel:'üìä', image:'üñº', plan:'üó∫', zip:'üì¶', link:'üîó', autre:'üìé' };
    return icons[type] || 'üìé';
  },

  // ‚îÄ‚îÄ Ajouter un document ‚îÄ‚îÄ
  openAddDoc() {
    if (!this._activeFolder) { alert('S√©lectionnez d\'abord un dossier.'); return; }
    App.openModal('‚ûï Lier un document ‚Äî ' + this._activeFolder.label, `
      <div style="margin-bottom:14px;padding:10px 14px;background:var(--bg3);border-radius:8px;font-size:12px;color:var(--muted2)">
        üìÅ <strong style="color:var(--text)">${this._activeFolder.label}</strong><br>
        <span style="font-size:10px">Liez un document existant dans votre Drive ou enregistrez un r√©f√©rencement.</span>
      </div>
      <div class="form-grid">
        <div class="form-group" style="grid-column:span 2">
          <label>Nom du document *</label>
          <input type="text" id="ged-m-name" placeholder="Ex: Contrat maintenance CVC 2024">
        </div>
        <div class="form-group">
          <label>Type de document</label>
          <select id="ged-m-type">
            <option value="pdf">üìÑ PDF</option>
            <option value="word">üìù Word / Texte</option>
            <option value="excel">üìä Excel / Tableur</option>
            <option value="plan">üó∫ Plan / Dessin</option>
            <option value="image">üñº Image / Photo</option>
            <option value="zip">üì¶ Archive ZIP</option>
            <option value="link">üîó Lien externe</option>
            <option value="autre">üìé Autre</option>
          </select>
        </div>
        <div class="form-group">
          <label>Date du document</label>
          <input type="date" id="ged-m-date" value="${new Date().toISOString().split('T')[0]}">
        </div>
        <div class="form-group" style="grid-column:span 2">
          <label>Lien Google Drive (URL partag√©e)</label>
          <input type="url" id="ged-m-url" placeholder="https://drive.google.com/file/d/..."
            oninput="GED.previewURL(this.value)">
          <div class="ged-drive-preview" id="ged-url-preview" style="display:none">
            <span class="drive-icon">üîó</span>
            <span id="ged-url-preview-text">‚Äî</span>
          </div>
        </div>
        <div class="form-group">
          <label>Version</label>
          <input type="text" id="ged-m-version" placeholder="Ex: v2.1">
        </div>
        <div class="form-group">
          <label>Note / R√©f√©rence</label>
          <input type="text" id="ged-m-note" placeholder="Ex: Sign√© le 12/01/2024">
        </div>
      </div>`, 'ged_add');
  },

  previewURL(url) {
    const preview = document.getElementById('ged-url-preview');
    const text    = document.getElementById('ged-url-preview-text');
    if (!preview || !text) return;
    if (url && url.startsWith('http')) {
      let label = url;
      if (url.includes('drive.google.com')) label = '‚úÖ Lien Google Drive valide';
      else if (url.includes('sharepoint')) label = '‚úÖ Lien SharePoint valide';
      else if (url.includes('dropbox'))    label = '‚úÖ Lien Dropbox valide';
      preview.style.display = 'flex';
      text.textContent = label;
    } else {
      preview.style.display = 'none';
    }
  },

  // ‚îÄ‚îÄ √âditer ‚îÄ‚îÄ
  editDoc(folderId, idx) {
    const data = this._load();
    const doc  = (data[folderId] || [])[idx];
    if (!doc) return;
    App.openModal('‚úèÔ∏è Modifier le document', `
      <div class="form-grid">
        <div class="form-group" style="grid-column:span 2">
          <label>Nom du document *</label>
          <input type="text" id="ged-m-name" value="${doc.name}">
        </div>
        <div class="form-group">
          <label>Type de document</label>
          <select id="ged-m-type">
            ${['pdf','word','excel','plan','image','zip','link','autre'].map(t =>
              `<option value="${t}" ${doc.type===t?'selected':''}>${this._docIcon(t)} ${t.charAt(0).toUpperCase()+t.slice(1)}</option>`
            ).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Date du document</label>
          <input type="date" id="ged-m-date" value="${doc.date||''}">
        </div>
        <div class="form-group" style="grid-column:span 2">
          <label>Lien Google Drive</label>
          <input type="url" id="ged-m-url" value="${doc.url||''}" placeholder="https://drive.google.com/file/d/...">
        </div>
        <div class="form-group">
          <label>Version</label>
          <input type="text" id="ged-m-version" value="${doc.version||''}">
        </div>
        <div class="form-group">
          <label>Note / R√©f√©rence</label>
          <input type="text" id="ged-m-note" value="${doc.note||''}">
        </div>
      </div>`, 'ged_edit');
    App._gedEditFolder = folderId;
    App._gedEditIdx    = idx;
  },

  // ‚îÄ‚îÄ Supprimer ‚îÄ‚îÄ
  deleteDoc(folderId, idx) {
    const data = this._load();
    const doc  = (data[folderId] || [])[idx];
    if (!doc) return;
    if (!confirm(`Supprimer "${doc.name}" ?\nLe document sur Drive ne sera pas affect√©.`)) return;
    data[folderId].splice(idx, 1);
    this._save(data);
    this.renderContent(folderId);
    this.renderTree();
  },

  // ‚îÄ‚îÄ Sauvegarde depuis modal (appel√© par App.saveModal) ‚îÄ‚îÄ
  saveFromModal(type) {
    const name    = (document.getElementById('ged-m-name')?.value    || '').trim();
    const docType = document.getElementById('ged-m-type')?.value    || 'autre';
    const date    = document.getElementById('ged-m-date')?.value    || '';
    const url     = (document.getElementById('ged-m-url')?.value     || '').trim();
    const version = (document.getElementById('ged-m-version')?.value || '').trim();
    const note    = (document.getElementById('ged-m-note')?.value    || '').trim();

    if (!name) { alert('Le nom du document est obligatoire.'); return false; }

    const data   = this._load();
    const folder = this._activeFolder?.id;

    if (type === 'ged_add') {
      if (!folder) return false;
      if (!data[folder]) data[folder] = [];
      data[folder].unshift({ name, type: docType, date, url, version, note, addedAt: new Date().toISOString() });
    } else if (type === 'ged_edit') {
      const f   = App._gedEditFolder;
      const idx = App._gedEditIdx;
      if (data[f] && data[f][idx]) {
        data[f][idx] = { ...data[f][idx], name, type: docType, date, url, version, note };
      }
    }

    this._save(data);
    App.closeModal();
    this.renderContent(this._activeFolder?.id);
    this.renderTree();
    return true;
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ‚Äî Gestion des centres (mode admin uniquement)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Admin = {

  // Cl√©s localStorage pour la persistance des listes
  _key: { SUD: 'ucpa_centres_SUD', NORD: 'ucpa_centres_NORD' },

  // Charger les listes persist√©es (appel√© par Auth.init avant tout)
  loadPersistedCentres() {
    ['SUD','NORD'].forEach(r => {
      const raw = localStorage.getItem(this._key[r]);
      if (!raw) return;
      try {
        const arr = JSON.parse(raw);
        const target = r === 'SUD' ? CENTRES_SUD : CENTRES_NORD;
        target.length = 0;
        arr.forEach(c => target.push(c));
      } catch(e) {}
    });
  },

  // Sauvegarder
  _persist(region) {
    const arr = region === 'SUD' ? CENTRES_SUD : CENTRES_NORD;
    localStorage.setItem(this._key[region], JSON.stringify(arr));
  },

  // ‚îÄ‚îÄ Rendu de la page ‚îÄ‚îÄ
  render() {
    // KPIs
    document.getElementById('adm-kpi-sud').textContent   = CENTRES_SUD.length;
    document.getElementById('adm-kpi-nord').textContent  = CENTRES_NORD.length;
    document.getElementById('adm-kpi-total').textContent = CENTRES_SUD.length + CENTRES_NORD.length;

    this._renderList('SUD',  'admin-list-sud');
    this._renderList('NORD', 'admin-list-nord');
  },

  _pw(name) {
    return name.toLowerCase()
      .replace('village sportif ','')
      .replace('centre aquatique ','')
      .replace('centre nautique ','')
      .trim();
  },

  _short(name) {
    return name
      .replace('VILLAGE SPORTIF ','')
      .replace('CENTRE AQUATIQUE ','CA ')
      .replace('CENTRE NAUTIQUE ','CN ');
  },

  _renderList(region, elId) {
    const arr = region === 'SUD' ? CENTRES_SUD : CENTRES_NORD;
    const el  = document.getElementById(elId);
    if (!el) return;

    if (!arr.length) {
      el.innerHTML = '<div class="empty-state"><div class="icon">üèî</div><div>Aucun centre configur√©</div></div>';
      return;
    }

    el.innerHTML = arr.map((c, i) => `
      <div class="admin-centre-card">
        <div class="admin-centre-info">
          <div class="admin-centre-name" title="${c}">${this._short(c)}</div>
          <div class="admin-centre-pw">Mot de passe : <code>${this._pw(c)}</code></div>
        </div>
        <div style="display:flex;gap:6px;flex-shrink:0">
          <button class="btn btn-ghost btn-sm" title="Renommer" onclick="Admin.openEditModal('${region}',${i})">‚úèÔ∏è</button>
          <button class="btn btn-ghost btn-sm" title="Supprimer" onclick="Admin.confirmDelete('${region}',${i})"
            style="color:var(--red);border-color:transparent">üóëÔ∏è</button>
        </div>
      </div>`).join('');
  },

  // ‚îÄ‚îÄ Ajouter ‚îÄ‚îÄ
  openAddModal(region) {
    App.openModal(
      `‚ûï Ajouter un centre ‚Äî Alpes ${region === 'SUD' ? 'Sud' : 'Nord'}`,
      `<div class="form-group">
        <label>Nom complet du centre (majuscules)</label>
        <input type="text" id="adm-centre-input" placeholder="Ex: VILLAGE SPORTIF CHAMONIX"
          style="text-transform:uppercase" oninput="this.value=this.value.toUpperCase()">
        <div style="margin-top:8px;font-size:11px;color:var(--muted)">
          Le mot de passe sera g√©n√©r√© automatiquement √† partir du nom.<br>
          Convention : commencer par <strong>VILLAGE SPORTIF</strong>, <strong>CENTRE AQUATIQUE</strong> ou <strong>CENTRE NAUTIQUE</strong>.
        </div>
        <div id="adm-pw-preview" style="margin-top:12px;padding:10px 14px;background:var(--bg3);border-radius:6px;font-size:12px;font-family:'DM Mono',monospace;color:var(--muted2)">
          Mot de passe g√©n√©r√© : <span id="adm-pw-val" style="color:var(--accent)">‚Äî</span>
        </div>
      </div>`,
      'admin_add_centre'
    );
    App._adminModalRegion = region;

    // Pr√©visualisation du mot de passe en temps r√©el
    setTimeout(() => {
      const inp = document.getElementById('adm-centre-input');
      if (inp) inp.addEventListener('input', () => {
        const preview = document.getElementById('adm-pw-val');
        if (preview) preview.textContent = this._pw(inp.value) || '‚Äî';
      });
    }, 50);
  },

  // ‚îÄ‚îÄ √âditer ‚îÄ‚îÄ
  openEditModal(region, idx) {
    const arr  = region === 'SUD' ? CENTRES_SUD : CENTRES_NORD;
    const current = arr[idx];
    App.openModal(
      `‚úèÔ∏è Modifier le centre`,
      `<div class="form-group">
        <label>Nom complet du centre</label>
        <input type="text" id="adm-centre-input" value="${current}"
          style="text-transform:uppercase" oninput="this.value=this.value.toUpperCase()">
        <div id="adm-pw-preview" style="margin-top:12px;padding:10px 14px;background:var(--bg3);border-radius:6px;font-size:12px;font-family:'DM Mono',monospace;color:var(--muted2)">
          Nouveau mot de passe : <span id="adm-pw-val" style="color:var(--accent)">${this._pw(current)}</span>
        </div>
      </div>`,
      'admin_edit_centre'
    );
    App._adminModalRegion = region;
    App._adminModalIdx    = idx;

    setTimeout(() => {
      const inp = document.getElementById('adm-centre-input');
      if (inp) inp.addEventListener('input', () => {
        const preview = document.getElementById('adm-pw-val');
        if (preview) preview.textContent = this._pw(inp.value) || '‚Äî';
      });
    }, 50);
  },

  // ‚îÄ‚îÄ Confirmer suppression ‚îÄ‚îÄ
  confirmDelete(region, idx) {
    const arr  = region === 'SUD' ? CENTRES_SUD : CENTRES_NORD;
    const name = arr[idx];
    App.openModal(
      'üóëÔ∏è Supprimer le centre',
      `<div class="alert-banner danger" style="margin-bottom:16px">
        ‚ö†Ô∏è Cette action supprime d√©finitivement <strong>${this._short(name)}</strong> de la liste des centres.<br>
        Les donn√©es ERP de ce centre restent en m√©moire mais ne seront plus accessibles via ce compte.
      </div>
      <p style="font-size:13px;color:var(--muted2)">Confirmez-vous la suppression de <strong style="color:var(--text)">${name}</strong> ?</p>`,
      'admin_delete_centre'
    );
    App._adminModalRegion = region;
    App._adminModalIdx    = idx;
    document.getElementById('modal-save').textContent = 'üóëÔ∏è Supprimer';
    document.getElementById('modal-save').style.background = 'var(--red)';
  },

  // ‚îÄ‚îÄ Sauvegarder (appel√© par App.saveModal) ‚îÄ‚îÄ
  saveFromModal(type) {
    const region = App._adminModalRegion;
    const arr    = region === 'SUD' ? CENTRES_SUD : CENTRES_NORD;

    if (type === 'admin_add_centre') {
      const val = (document.getElementById('adm-centre-input')?.value || '').trim().toUpperCase();
      if (!val) { alert('Veuillez saisir un nom de centre.'); return false; }
      if (arr.includes(val)) { alert('Ce centre existe d√©j√† dans la liste.'); return false; }
      arr.push(val);
      this._persist(region);
      this._refreshCentreSelector(region);
      App.closeModal();
      this.render();
      return true;
    }

    if (type === 'admin_edit_centre') {
      const idx = App._adminModalIdx;
      const val = (document.getElementById('adm-centre-input')?.value || '').trim().toUpperCase();
      if (!val) { alert('Veuillez saisir un nom de centre.'); return false; }
      arr[idx] = val;
      this._persist(region);
      this._refreshCentreSelector(region);
      App.closeModal();
      this.render();
      return true;
    }

    if (type === 'admin_delete_centre') {
      const idx = App._adminModalIdx;
      arr.splice(idx, 1);
      this._persist(region);
      this._refreshCentreSelector(region);
      App.closeModal();
      this.render();
      return true;
    }

    return false;
  },

  // Rafra√Æchir le s√©lecteur de centres en sidebar apr√®s modification
  _refreshCentreSelector(region) {
    // Reconstruire CENTRES global si l'admin est en vue "ALL" ou sur la bonne r√©gion
    const prefix = App._storagePrefix;
    let actives;
    if (prefix === 'ucpa_admin_') actives = [...CENTRES_SUD, ...CENTRES_NORD];
    else if (prefix === 'ucpa_nord_') actives = CENTRES_NORD;
    else actives = CENTRES_SUD;

    CENTRES.length = 0;
    actives.forEach(c => CENTRES.push(c));

    const sel = document.getElementById('centre-select');
    const current = App.centre;
    sel.innerHTML = '<option value="ALL">‚Äî Tous les centres ‚Äî</option>';
    actives.forEach(c => {
      const o = document.createElement('option');
      o.value = c;
      o.textContent = c.replace('VILLAGE SPORTIF ','VS ').replace('CENTRE AQUATIQUE ','CA ').replace('CENTRE NAUTIQUE ','CN ');
      sel.appendChild(o);
    });
    // Restaurer s√©lection si toujours valide
    if (actives.includes(current)) sel.value = current;
    else { App.centre = 'ALL'; sel.value = 'ALL'; }

    // Mettre √† jour le compteur sidebar
    const label = document.getElementById('sidebar-region-label');
    if (label && prefix === 'ucpa_sud_') label.textContent = '‚ñ≤ Alpes Sud ¬∑ ' + CENTRES_SUD.length + ' Centres';
    if (label && prefix === 'ucpa_nord_') label.textContent = '‚ñ≤ Alpes Nord ¬∑ ' + CENTRES_NORD.length + ' Centres';
    if (label && prefix === 'ucpa_admin_') label.textContent = '‚ñ≤ Alpes Sud + Nord ¬∑ Admin';
  },

  // Import liste depuis un fichier texte (un centre par ligne)
  importCentres(region) {
    const input = document.createElement('input');
    input.type = 'file'; input.accept = '.txt,.csv';
    input.onchange = (e) => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const lines = ev.target.result.split('\n')
          .map(l => l.trim().toUpperCase())
          .filter(l => l.length > 0);
        const arr = region === 'SUD' ? CENTRES_SUD : CENTRES_NORD;
        let added = 0;
        lines.forEach(l => { if (!arr.includes(l)) { arr.push(l); added++; } });
        this._persist(region);
        this._refreshCentreSelector(region);
        this.render();
        alert(`${added} centre(s) import√©(s) dans Alpes ${region === 'SUD' ? 'Sud' : 'Nord'}.`);
      };
      reader.readAsText(file);
    };
    input.click();
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXCEL IMPORT FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ExcelImport = {
  // Generic Excel reader
  readFile(file, callback) {
    if (!window.XLSX) { alert('SheetJS non disponible'); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const wb = XLSX.read(e.target.result, {type:'binary', cellDates:true});
        callback(wb);
      } catch(err) { alert('Erreur lecture fichier: ' + err.message); }
    };
    reader.readAsBinaryString(file);
  },

  // Import Registre S√©curit√©
  importRegistre(event) {
    const file = event.target.files[0]; if (!file) return;
    this.readFile(file, wb => {
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
      const reg = App.load('registre') || {};
      let count = 0;
      rows.forEach(row => {
        const c = String(row['Centre']||row['CENTRE']||'').trim();
        if (!c || !CENTRES.includes(c)) return;
        if (!reg[c]) reg[c] = App.buildInitRegistre()[c] || [];
        // Try to match by catId
        const catId = String(row['Cat.']||row['CAT']||row['catId']||'').trim();
        const idx = reg[c].findIndex(r=>r.catId===catId);
        if (idx >= 0) {
          if (row['Dernier contr√¥le']||row['dateRealisation']) reg[c][idx].dateRealisation = String(row['Dernier contr√¥le']||row['dateRealisation']||'');
          if (row['R√©sultat']||row['resultat']) reg[c][idx].resultat = String(row['R√©sultat']||row['resultat']||'');
          if (row['Organisme']||row['organisme']) reg[c][idx].organisme = String(row['Organisme']||row['organisme']||'');
          if (row['Prochain contr√¥le']||row['prochainControle']) reg[c][idx].prochainControle = String(row['Prochain contr√¥le']||row['prochainControle']||'');
          if (row['Observations']||row['observations']) reg[c][idx].observations = String(row['Observations']||row['observations']||'');
          count++;
        }
      });
      App.save('registre', reg);
      alert(`${count} lignes du registre mises √† jour.`);
      event.target.value = '';
      App.renderRegistre(); App.renderAll();
    });
  },

  // Import Observations
  importObs(event) {
    const file = event.target.files[0]; if (!file) return;
    this.readFile(file, wb => {
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
      const obs = App.load('observations') || [];
      rows.forEach(row => {
        obs.push({
          id: App.uuid(),
          date: String(row['Date']||row['date']||App.today()),
          centre: String(row['Centre']||row['centre']||''),
          categorie: String(row['Cat√©gorie']||row['categorie']||row['Libell√©']||''),
          description: String(row['Description']||row['description']||''),
          statut: String(row['Statut']||row['statut']||'Ouvert')
        });
      });
      App.save('observations', obs);
      alert(`${rows.length} observations import√©es.`);
      event.target.value = '';
      App.renderPage('observations');
    });
  },

  // Import Maintenance
  importMaintenance(event) {
    const file = event.target.files[0]; if (!file) return;
    this.readFile(file, wb => {
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
      const items = App.load('maintenance') || [];
      rows.forEach(row => {
        items.push({
          id: App.uuid(),
          date: String(row['Date']||row['date']||App.today()),
          centre: String(row['Centre']||row['centre']||''),
          equipement: String(row['√âquipement']||row['equipement']||row['Equipement']||''),
          description: String(row['Description']||row['description']||''),
          priorite: String(row['Priorit√©']||row['priorite']||'Normale'),
          statut: String(row['Statut']||row['statut']||'Ouvert')
        });
      });
      App.save('maintenance', items);
      alert(`${rows.length} anomalies import√©es.`);
      event.target.value = '';
      App.renderPage('maintenance');
    });
  },

  // Import Rondes
  importRondes(event) {
    const file = event.target.files[0]; if (!file) return;
    this.readFile(file, wb => {
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
      const items = App.load('rondes') || [];
      rows.forEach(row => {
        items.push({
          id: App.uuid(),
          date: String(row['Date']||row['date']||App.today()),
          centre: String(row['Centre']||row['centre']||''),
          type: String(row['Type']||row['type']||'Ronde s√©curit√©'),
          agent: String(row['Agent']||row['agent']||''),
          observations: String(row['Observations']||row['observations']||'')
        });
      });
      App.save('rondes', items);
      alert(`${rows.length} rondes import√©es.`);
      event.target.value = '';
      App.renderPage('rondes');
    });
  },

  // Import RH
  importRH(event) {
    const file = event.target.files[0]; if (!file) return;
    this.readFile(file, wb => {
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
      const items = App.load('rh') || [];
      rows.forEach(row => {
        items.push({
          id: App.uuid(),
          centre: String(row['Centre']||row['centre']||''),
          nom: String(row['Nom']||row['nom']||''),
          poste: String(row['Poste']||row['poste']||''),
          habilitation: String(row['Habilitation']||row['habilitation']||''),
          dateObtention: String(row['Date obtention']||row['dateObtention']||''),
          expiration: String(row['Expiration']||row['expiration']||'')
        });
      });
      App.save('rh', items);
      alert(`${rows.length} habilitations import√©es.`);
      event.target.value = '';
      App.renderRH(); App.renderAll();
    });
  },

  // Import Contrats
  importContrats(event) {
    const file = event.target.files[0]; if (!file) return;
    this.readFile(file, wb => {
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
      const items = App.load('contrats') || [];
      rows.forEach(row => {
        items.push({
          id: App.uuid(),
          centre: String(row['Centre']||row['centre']||''),
          prestataire: String(row['Prestataire']||row['prestataire']||''),
          objet: String(row['Objet']||row['objet']||''),
          debut: String(row['D√©but']||row['debut']||''),
          fin: String(row['Fin']||row['fin']||'')
        });
      });
      App.save('contrats', items);
      alert(`${rows.length} contrats import√©s.`);
      event.target.value = '';
      App.renderPage('contrats');
    });
  },

  // Import T√¢ches
  importTaches(event) {
    const file = event.target.files[0]; if (!file) return;
    this.readFile(file, wb => {
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
      const items = App.load('taches') || [];
      rows.forEach(row => {
        items.push({
          id: App.uuid(),
          centre: String(row['Centre']||row['centre']||''),
          titre: String(row['Titre']||row['titre']||''),
          priorite: String(row['Priorit√©']||row['priorite']||'Normale'),
          echeance: String(row['√âch√©ance']||row['echeance']||''),
          statut: String(row['Statut']||row['statut']||'En cours')
        });
      });
      App.save('taches', items);
      alert(`${rows.length} t√¢ches import√©es.`);
      event.target.value = '';
      App.renderPage('taches');
    });
  },

  // Import Sanitaire
  importSanitaire(event) {
    const file = event.target.files[0]; if (!file) return;
    this.readFile(file, wb => {
      const san = App.load('sanitaire') || {ecs:[], purges:[]};
      // Sheet 1 = ECS, Sheet 2 = Purges
      const ws1 = wb.Sheets[wb.SheetNames[0]];
      const rows1 = XLSX.utils.sheet_to_json(ws1, {defval:''});
      rows1.forEach(row => {
        san.ecs.push({ date: String(row['Date']||''), point: String(row['Point de mesure']||''), temp: String(row['Temp√©rature (¬∞C)']||row['Temp√©rature']||'') });
      });
      if (wb.SheetNames.length > 1) {
        const ws2 = wb.Sheets[wb.SheetNames[1]];
        const rows2 = XLSX.utils.sheet_to_json(ws2, {defval:''});
        rows2.forEach(row => {
          san.purges.push({ date: String(row['Date']||''), circuit: String(row['Circuit']||''), agent: String(row['Agent']||'') });
        });
      }
      App.save('sanitaire', san);
      alert('Donn√©es sanitaires import√©es.');
      event.target.value = '';
      App.renderSanitaire();
    });
  },

  // Import Veille
  importVeille(event) {
    const file = event.target.files[0]; if (!file) return;
    this.readFile(file, wb => {
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
      const items = App.load('veille') || [];
      rows.forEach(row => {
        items.push({
          id: App.uuid(),
          date: String(row['Date']||row['date']||App.today()),
          reference: String(row['R√©f√©rence']||row['reference']||''),
          objet: String(row['Objet']||row['objet']||''),
          impact: String(row['Impact']||row['impact']||'Informatif')
        });
      });
      App.save('veille', items);
      alert(`${rows.length} √©l√©ments de veille import√©s.`);
      event.target.value = '';
      App.renderPage('veille');
    });
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// THEME ‚Äî Bascule clair / sombre avec persistance
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Theme = {
  KEY: 'ucpa_theme',

  init() {
    // Lire pr√©f√©rence sauvegard√©e, sinon d√©tecter syst√®me
    const saved = localStorage.getItem(this.KEY);
    if (saved) {
      document.documentElement.setAttribute('data-theme', saved);
    } else {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
    }
  },

  toggle() {
    const html = document.documentElement;
    const current = html.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', next);
    localStorage.setItem(this.KEY, next);
  },

  current() {
    return document.documentElement.getAttribute('data-theme');
  }
};

// Initialiser le th√®me AVANT le rendu (√©vite le flash)
Theme.init();

// Start
window.addEventListener('DOMContentLoaded', () => Auth.init());
</script>
</body>
</html>
